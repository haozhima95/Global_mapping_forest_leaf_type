---
title: "play_with_functional_type"
author: "Haozhi Ma"
date: "6/23/2021"
output: html_document
---

This script is used for playing with the pixel aggregated dataset that could see the patterns of functional distributions across environmental gradients.


Load teh dataset

```{R}

df.fft <- read.csv('C:\\Users\\haozh\\Desktop\\LL\\GFBI_data\\gfbi_recent_plot_info_4class_with_fold_with_env_20221010.csv')


head(df.fft)

names(df.fft)

df.fft$be_prop_dbh <- df.fft$be_prop_dbh * 100
df.fft$bd_prop_dbh <- df.fft$bd_prop_dbh * 100
df.fft$ne_prop_dbh <- df.fft$ne_prop_dbh * 100
df.fft$nd_prop_dbh <- df.fft$nd_prop_dbh * 100


df.fft$be_prop_stem <- df.fft$be_prop_stem * 100
df.fft$bd_prop_stem <- df.fft$bd_prop_stem * 100
df.fft$ne_prop_stem <- df.fft$ne_prop_stem * 100
df.fft$nd_prop_stem <- df.fft$nd_prop_stem * 100



df.fft$ev_prop_dbh <- df.fft$be_prop_dbh + df.fft$ne_prop_dbh
df.fft$broad_prop_dbh <- df.fft$be_prop_dbh + df.fft$bd_prop_dbh
df.fft$de_prop_dbh <- 100 - df.fft$ev_prop_dbh


df.fft$needle_prop_dbh <- 100 - df.fft$broad_prop_dbh



df.fft$ev_prop_stem <- df.fft$be_prop_stem + df.fft$ne_prop_stem

df.fft$broad_prop_stem <- df.fft$be_prop_stem + df.fft$bd_prop_stem

df.fft$de_prop_stem <- 100 - df.fft$ev_prop_stem

df.fft$needle_prop_stem <- 100 - df.fft$broad_prop_stem


#df.fft$broad_evergreen <- df.fft$broad_evergreen*10

#df.fft$broad_deciduous <- df.fft$broad_deciduous*10

#df.fft$needle <- df.fft$needle*10

#df.fft$needle <- df.fft$needle_deciduous + df.fft$needle_evergreen

#df.fft$evergreen <- df.fft$broad_evergreen + df.fft$needle_evergreen

#df.fft$deciduous <- df.fft$broad_deciduous + df.fft$needle_deciduous

#df.fft$broad <- df.fft$broad_evergreen + df.fft$broad_deciduous

#df.fft$petprep <- df.fft$PET - df.fft$CHELSA_Annual_Precipitation

```


```{R}
library(broom)
library(tidyr)
library(dplyr)
library(ggplot2)

library(lme4)


df.fft$tempcut <- cut_width(df.fft$CHELSA_Precipitation_of_Driest_Quarter,280)

ggplot(df.fft, aes(x = tempcut, y = de_prop_dbh)) +
  geom_boxplot(outlier.shape = NA,notch=T)


df.fft$tempcut <- cut_width(df.fft$CHELSA_Mean_Temperature_of_Coldest_Quarter,120)

ggplot(df.fft, aes(x = tempcut, y = broad_prop_dbh)) +
  geom_boxplot(outlier.shape = NA,notch=T)




ggplot(df.fft, aes(x = CHELSA_Mean_Temperature_of_Coldest_Quarter, y = CHELSA_Precipitation_of_Driest_Quarter, color = de_prop_dbh))+
  geom_point(alpha = 0.6)+
  scale_color_viridis_c(limits = c(0,80),oob = scales::squish)



ggplot(df.fft, aes(x = CHELSA_Mean_Temperature_of_Coldest_Quarter, y = CHELSA_Precipitation_of_Driest_Quarter, color = broad_prop_dbh))+
  geom_point(alpha = 0.6)+
  scale_color_viridis_c(limits = c(0,80),oob = scales::squish)

```



```{R}

ggplot(df.fft, aes(x = cnRatio, y = SG_Soil_pH_H2O_0_100cm, color = de_prop_dbh))+
  geom_point(alpha = 0.6)+
  scale_color_viridis_c(limits = c(0,80),oob = scales::squish)



ggplot(df.fft, aes(x = CHELSA_Isothermality, y = CHELSA_Temperature_Annual_Range, color = broad_prop_dbh))+
  geom_point(alpha = 0.6)+
  scale_color_viridis_c(limits = c(0,80),oob = scales::squish)



```










```{R}
ggplot(df.fft, aes(x = be_prop_dbh))+
  geom_histogram()

```



```{R}


library(ggplot2)

ggplot(df.fft, aes(x = CHELSA_Annual_Precipitation))+
  geom_histogram()



quantile(df.fft$CHELSA_Annual_Precipitation, 0.25)

quantile(df.fft$CHELSA_Annual_Precipitation, 0.5)


quantile(df.fft$CHELSA_Annual_Precipitation, 0.75)

quantile(df.fft$CHELSA_Annual_Precipitation, 0.95)



quantile(df.fft$CHELSA_Annual_Precipitation, 0.33)

quantile(df.fft$CHELSA_Annual_Precipitation, 0.67)




```

```{R}

ggplot(df.fft, aes(x = broad_evergreen, fill = cate))+
  geom_histogram(position = 'identity',colour = 'black',bins = 60,alpha = 0.5)+
  scale_fill_manual(values = c('#0745ff','#fff429'))+
  #scale_x_continuous(limits = c(-180,180))+
  #scale_y_continuous(trans = 'sqrt')+
  labs(y = 'Number of points',
       x = 'Functional type coverage (%)',
       title = 'rf_broad_evergreen')+
  theme_classic()+
  theme(plot.background = element_rect(fill = 'white'),panel.border = element_rect(color = 'black',fill = NA),panel.background = element_rect(fill = 'white'), axis.text = element_text(color = 'black',size = 20),legend.position = 'none',axis.line = element_line(color = 'black'),axis.title.y = element_text(size = 20, colour = 'black'), axis.title.x = element_text(size = 20, colour = 'black'))




```









```{R}
library(ggplot2)
library(grDevices)
library(zoo)
# theme_set(theme_minimal())


#prep1<-df.fft[df.fft$CHELSA_Annual_Precipitation<400,]
#prep1$prepcat <- 'less than 800'

#prep2 <- df.fft[df.fft$CHELSA_Annual_Precipitation >=400 & df.fft$CHELSA_Annual_Precipitation < 800,]
#prep2$prepcat <- 'less than 800'

#prep3 <- df.fft[df.fft$CHELSA_Annual_Precipitation >=800 & df.fft$CHELSA_Annual_Precipitation < 1200, ]
#prep3$prepcat <- '800 to 1200'
#prep4 <- df.fft[df.fft$CHELSA_Annual_Precipitation >=1200 & df.fft$CHELSA_Annual_Precipitation < 1600,]
#prep4$prepcat <- '1200 to 1600'


#prep5 <- df.fft[df.fft$CHELSA_Annual_Precipitation >=1600 & df.fft$CHELSA_Annual_Precipitation <2000, ]
#prep5$prepcat <- '1600 to 2000'

#prep6 <- df.fft[df.fft$CHELSA_Annual_Precipitation >=2000, ]
#prep6$prepcat <- 'higher than 2000'


#newdata <- rbind(prep1, rbind(prep2, rbind(prep3, rbind(prep4, rbind(prep5, prep6)))))
#newdata$prepcat <- factor(newdata$prepcat, levels = c('less than 800', '800 to 1200', '1200 to 1600', '1600 to 2000', 'higher than 2000'))

# newdata$tempcat <- 1

new1 <- df.fft[df.fft$CHELSA_Annual_Mean_Temperature <= 180 & df.fft$CHELSA_Annual_Mean_Temperature > 60, ]
new1$tempcat <- '6 to 18'

new2 <- df.fft[df.fft$CHELSA_Annual_Mean_Temperature > 180, ]
new2$tempcat <- 'higher than 18'

new3 <- df.fft[df.fft$CHELSA_Annual_Mean_Temperature <= 60, ]
new3$tempcat <- 'lower than 6'

newdata <- rbind(new1, rbind(new2,new3))

#newdata$prepround <- round(newdata$CHELSA_Annual_Precipitation,-3)

p4<- ggplot(newdata, aes(x = CHELSA_Annual_Precipitation, y = be_prop_dbh, color = tempcat))+
  #geom_point(alpha = 0.1)+
  stat_smooth(method = 'loess', span = 0.5, size = 1.5, se = FALSE, n = 200)+
  #geom_line(stat = 'summary', fun.y = median)+
  #stat_summary(fun = median, fun.min = function(z){quantile(z, 0.45)}, fun.max = function(z){quantile(z, 0.55)}, size = 1)+
  #stat_summary(fun.data = 'mean_cl_boot', size = 1)+
  #stat_summary(fun = median, geom = 'line', size = 1, aes(group = tempcat))+
  #geom_path()+
  #geom_line(aes(y = rollmean(broad_evergreen, 101, na.pad = TRUE)))+
  #stat_summary(aes(x = prepround), fun.y = median, geom = 'line')+
  scale_color_viridis_d()+
  coord_cartesian(ylim = c(0,100))+
  theme(axis.title = element_text(size = 20, color = 'black'), axis.text = element_text(size = 20), axis.text.x = element_text(angle = 45, hjust = 1))



new1 <- newdata[newdata$CHELSA_Annual_Mean_Temperature <=180 & newdata$CHELSA_Annual_Mean_Temperature>60,]
new1$tempcat <- '6 to 18'


new2 <- newdata[newdata$CHELSA_Annual_Mean_Temperature > 180, ]
new2$tempcat <- 'higher than 18'

new3 <- newdata[newdata$CHELSA_Annual_Mean_Temperature <= 60,]
new3$tempcat <- 'lower than 6'

newdata <- rbind(new1,rbind(new2, new3))




p5<-ggplot(newdata, aes(x = CHELSA_Annual_Precipitation, y = bd_prop_dbh, color = tempcat))+
  stat_smooth(method = 'loess', span = 0.5, size = 1.5, se = FALSE, n = 200)+
  #geom_smooth(method = 'gam', se = FALSE)+
  #stat_summary(fun = median, fun.min = function(z){quantile(z, 0.45)}, fun.max = function(z){quantile(z, 0.55)}, size = 1)+
  #stat_summary(fun.data = 'mean_cl_boot', size = 1)+
  #stat_summary(fun = median, geom = 'line', size = 1, aes(group = tempcat))+
  #geom_path()+
  scale_color_viridis_d()+
  coord_cartesian(ylim = c(0,100))+
  theme(axis.title = element_text(size = 20, color = 'black'), axis.text = element_text(size = 20), axis.text.x = element_text(angle = 45, hjust = 1))


new1 <- newdata[newdata$CHELSA_Annual_Mean_Temperature <= 60, ]
new1$tempcat <- 'lower than 6'

new2 <- newdata[newdata$CHELSA_Annual_Mean_Temperature > 60, ]
new2$tempcat <- 'higher than 6'


newdata <- rbind(new1, new2)





p6<-ggplot(newdata, aes(x = CHELSA_Annual_Precipitation, y = ne_prop_dbh, color = tempcat))+
  stat_smooth(method = 'loess', span = 0.5, size = 1.5, se = FALSE, n = 200)+
  #geom_smooth(method = 'gam', se = FALSE)+
  #stat_summary(fun = median, fun.min = function(z){quantile(z, 0.45)}, fun.max = function(z){quantile(z, 0.55)}, size = 1)+
  #stat_summary(fun.data = 'mean_cl_boot', size = 1)+
  #stat_summary(fun = median, geom = 'line', size = 1, aes(group = tempcat))+
  #geom_path()+
  scale_color_viridis_d()+
  coord_cartesian(ylim = c(0,100))+
  theme(axis.title = element_text(size = 20, color = 'black'), axis.text = element_text(size = 20), axis.text.x = element_text(angle = 45, hjust = 1))



#ggplot(newdata, aes(x = CHELSA_Annual_Mean_Temperature, y = broad_evergreen))+
#  geom_point(color = densCols(newdata$CHELSA_Annual_Mean_Temperature, newdata$broad_evergreen))+
  #geom_smooth()+
 # facet_wrap(~prepcat, ncol = 1)
  


#ggplot(newdata, aes(x = CHELSA_Annual_Mean_Temperature, y = broad_deciduous))+
#  geom_point(color = densCols(newdata$CHELSA_Annual_Mean_Temperature, newdata$broad_deciduous))+
#  geom_smooth()+
#  facet_wrap(~prepcat, ncol = 1)


#ggplot(newdata, aes(x = CHELSA_Annual_Mean_Temperature, y = needle_evergreen))+
#  geom_point(color = densCols(newdata$CHELSA_Annual_Mean_Temperature, newdata$needle_evergreen))+
#  geom_smooth()+
#  facet_wrap(~prepcat, ncol = 1)




#gplot(newdata, aes(x = CHELSA_Annual_Mean_Temperature, y = evergreen))+
#  geom_point(color = densCols(newdata$CHELSA_Annual_Mean_Temperature, newdata$evergreen))+
#  geom_smooth()+
#  facet_wrap(~prepcat, ncol = 1)
  


#ggplot(newdata, aes(x = CHELSA_Annual_Mean_Temperature, y = broad))+
#  geom_point(color = densCols(newdata$CHELSA_Annual_Mean_Temperature, newdata$broad))+
#  geom_smooth()+
#  facet_wrap(~prepcat, ncol = 1)




```


BE Annual precipitation
```{R}

new1 <- df.fft[df.fft$CHELSA_Annual_Mean_Temperature <= 180 & df.fft$CHELSA_Annual_Mean_Temperature > 60, ]
new1$tempcat <- '6 to 18'

new2 <- df.fft[df.fft$CHELSA_Annual_Mean_Temperature > 180, ]
new2$tempcat <- 'higher than 18'

new3 <- df.fft[df.fft$CHELSA_Annual_Mean_Temperature <= 60, ]
new3$tempcat <- 'lower than 6'


new1$dens <- col2rgb(densCols(new1$CHELSA_Annual_Precipitation, new1$broad_evergreen))[1,]+1L

newds1 <- new1[,c('CHELSA_Annual_Precipitation', 'tempcat', 'broad_evergreen', 'dens')]

newds1$CHELSA_Annual_Precipitation <- round(newds1$CHELSA_Annual_Precipitation,1)

newds1 <- newds1[newds1$dens<140,]

new2$dens <- col2rgb(densCols(new2$CHELSA_Annual_Precipitation, new2$broad_evergreen))[1,]+1L

newds2 <- new2[,c('CHELSA_Annual_Precipitation', 'tempcat', 'broad_evergreen', 'dens')]

newds2$CHELSA_Annual_Precipitation <- round(newds2$CHELSA_Annual_Precipitation,1)

newds2 <- newds2[newds2$dens < 140,]


new3$dens <- col2rgb(densCols(new3$CHELSA_Annual_Precipitation, new3$broad_evergreen))[1,]+1L

newds3 <- new3[,c('CHELSA_Annual_Precipitation', 'tempcat', 'broad_evergreen', 'dens')]

newds3$CHELSA_Annual_Precipitation <- round(newds3$CHELSA_Annual_Precipitation,1)

newds3 <- newds3[newds3$dens < 140,]

library(dplyr)

newds1 <- newds1 %>%
  group_by(CHELSA_Annual_Precipitation)%>%
  slice(which.min(dens))

newds2 <- newds2 %>%
  group_by(CHELSA_Annual_Precipitation)%>%
  slice(which.min(dens))


newds3 <- newds3 %>%
  group_by(CHELSA_Annual_Precipitation)%>%
  slice(which.min(dens))


newdata <- rbind(newds1,rbind(newds2,newds3))


newds1
ggplot(data = newds1, aes(x = CHELSA_Annual_Precipitation, y = broad_evergreen))+
  geom_point()+
  geom_smooth(method = 'gam', se = FALSE)+
  coord_cartesian(ylim = c(0,100))
  #geom_line()


ggplot(data = newds2, aes(x = CHELSA_Annual_Precipitation, y = broad_evergreen))+
  geom_point()+
  geom_smooth(method = 'gam',orientation ='x', se = FALSE)+
  coord_cartesian(ylim = c(0,100))


ggplot(data = newds3, aes(x = CHELSA_Annual_Precipitation, y = broad_evergreen))+
  geom_point()+
  coord_cartesian(ylim = c(0,100))
  #geom_line()


pwd1<-ggplot(newdata, aes(x = CHELSA_Annual_Precipitation, y = broad_evergreen, color = tempcat))+
  #geom_point(size = 4, alpha = 0.3)+
  geom_smooth(method = 'loess', size = 1.5, span = 0.55)+
  scale_color_viridis_d()+
  coord_cartesian(ylim = c(0,100))+
  theme_classic()+
  theme(axis.title = element_blank(), axis.text = element_text(size = 20), axis.text.x = element_text(angle = 45, hjust = 1), legend.text = element_text(size = 20), legend.title = element_blank())





```

BD Annual precipitation
```{R}

new1 <- df.fft[df.fft$CHELSA_Annual_Mean_Temperature <= 180 & df.fft$CHELSA_Annual_Mean_Temperature > 60, ]
new1$tempcat <- '6 to 18'

new2 <- df.fft[df.fft$CHELSA_Annual_Mean_Temperature > 180, ]
new2$tempcat <- 'higher than 18'

new3 <- df.fft[df.fft$CHELSA_Annual_Mean_Temperature <= 60, ]
new3$tempcat <- 'lower than 6'


new1$dens <- col2rgb(densCols(new1$CHELSA_Annual_Precipitation, new1$broad_deciduous))[1,]+1L

newds1 <- new1[,c('CHELSA_Annual_Precipitation', 'tempcat', 'broad_deciduous', 'dens')]

newds1$CHELSA_Annual_Precipitation <- round(newds1$CHELSA_Annual_Precipitation,1)

newds1 <- newds1[newds1$dens<140,]

new2$dens <- col2rgb(densCols(new2$CHELSA_Annual_Precipitation, new2$broad_deciduous))[1,]+1L

newds2 <- new2[,c('CHELSA_Annual_Precipitation', 'tempcat', 'broad_deciduous', 'dens')]

newds2$CHELSA_Annual_Precipitation <- round(newds2$CHELSA_Annual_Precipitation,1)

newds2 <- newds2[newds2$dens < 140,]


new3$dens <- col2rgb(densCols(new3$CHELSA_Annual_Precipitation, new3$broad_deciduous))[1,]+1L

newds3 <- new3[,c('CHELSA_Annual_Precipitation', 'tempcat', 'broad_deciduous', 'dens')]

newds3$CHELSA_Annual_Precipitation <- round(newds3$CHELSA_Annual_Precipitation,1)

newds3 <- newds3[newds3$dens < 140,]

library(dplyr)

newds1 <- newds1 %>%
  group_by(CHELSA_Annual_Precipitation)%>%
  slice(which.min(dens))

newds2 <- newds2 %>%
  group_by(CHELSA_Annual_Precipitation)%>%
  slice(which.min(dens))


newds3 <- newds3 %>%
  group_by(CHELSA_Annual_Precipitation)%>%
  slice(which.min(dens))


newdata <- rbind(newds1,rbind(newds2,newds3))


newds1
ggplot(data = newds1, aes(x = CHELSA_Annual_Precipitation, y = broad_deciduous))+
  geom_point()+
  geom_smooth(method = 'gam', se = FALSE)+
  coord_cartesian(ylim = c(0,100))
  #geom_line()


ggplot(data = newds2, aes(x = CHELSA_Annual_Precipitation, y = broad_deciduous))+
  geom_point()+
  geom_smooth(method = 'gam',orientation ='x', se = FALSE)+
  coord_cartesian(ylim = c(0,100))


ggplot(data = newds3, aes(x = CHELSA_Annual_Precipitation, y = broad_deciduous))+
  geom_point()+
  geom_smooth(method = 'gam', se = FALSE)+
  coord_cartesian(ylim = c(0,100))
  #geom_line()


pwd2<-ggplot(newdata, aes(x = CHELSA_Annual_Precipitation, y = broad_deciduous, color = tempcat))+
  #geom_point(size = 4, alpha = 0.3)+
  geom_smooth(method = 'loess', size = 1.5, span = 0.55)+
  scale_color_viridis_d()+
  coord_cartesian(ylim = c(0,100))+
  theme_classic()+
  theme(axis.title = element_blank(), axis.text = element_text(size = 20), axis.text.x = element_text(angle = 45, hjust = 1), legend.text = element_text(size = 20), legend.title = element_blank())




```

N Annual precipitation
```{R}

new1 <- df.fft[df.fft$CHELSA_Annual_Mean_Temperature <= 180 & df.fft$CHELSA_Annual_Mean_Temperature > 60, ]
new1$tempcat <- '6 to 18'

new2 <- df.fft[df.fft$CHELSA_Annual_Mean_Temperature > 180, ]
new2$tempcat <- 'higher than 18'

new3 <- df.fft[df.fft$CHELSA_Annual_Mean_Temperature <= 60, ]
new3$tempcat <- 'lower than 6'


new1$dens <- col2rgb(densCols(new1$CHELSA_Annual_Precipitation, new1$needle))[1,]+1L

newds1 <- new1[,c('CHELSA_Annual_Precipitation', 'tempcat', 'needle', 'dens')]

newds1$CHELSA_Annual_Precipitation <- round(newds1$CHELSA_Annual_Precipitation,1)

newds1 <- newds1[newds1$dens<140,]

new2$dens <- col2rgb(densCols(new2$CHELSA_Annual_Precipitation, new2$needle))[1,]+1L

newds2 <- new2[,c('CHELSA_Annual_Precipitation', 'tempcat', 'needle', 'dens')]

newds2$CHELSA_Annual_Precipitation <- round(newds2$CHELSA_Annual_Precipitation,1)

newds2 <- newds2[newds2$dens < 140,]


new3$dens <- col2rgb(densCols(new3$CHELSA_Annual_Precipitation, new3$needle))[1,]+1L

newds3 <- new3[,c('CHELSA_Annual_Precipitation', 'tempcat', 'needle', 'dens')]

newds3$CHELSA_Annual_Precipitation <- round(newds3$CHELSA_Annual_Precipitation,1)

newds3 <- newds3[newds3$dens < 140,]

library(dplyr)

newds1 <- newds1 %>%
  group_by(CHELSA_Annual_Precipitation)%>%
  slice(which.min(dens))

newds2 <- newds2 %>%
  group_by(CHELSA_Annual_Precipitation)%>%
  slice(which.min(dens))


newds3 <- newds3 %>%
  group_by(CHELSA_Annual_Precipitation)%>%
  slice(which.min(dens))


newdata <- rbind(newds1,rbind(newds2,newds3))


newds1
ggplot(data = newds1, aes(x = CHELSA_Annual_Precipitation, y = needle))+
  geom_point()+
  geom_smooth(method = 'gam', se = FALSE)+
  coord_cartesian(ylim = c(0,100))
  #geom_line()


ggplot(data = newds2, aes(x = CHELSA_Annual_Precipitation, y = needle))+
  geom_point()+
  geom_smooth(method = 'gam',orientation ='x', se = FALSE)+
  coord_cartesian(ylim = c(0,100))


ggplot(data = newds3, aes(x = CHELSA_Annual_Precipitation, y = needle))+
  geom_point()+
  geom_smooth(method = 'gam', se = FALSE)+
  coord_cartesian(ylim = c(0,100))
  #geom_line()


pwd3<-ggplot(newdata, aes(x = CHELSA_Annual_Precipitation, y = needle, color = tempcat))+
  #geom_point(size = 4, alpha = 0.3)+
  geom_smooth(method = 'loess', size = 1.5, span = 0.55)+
  scale_color_viridis_d()+
  coord_cartesian(ylim = c(0,100))+
  theme_classic()+
  theme(axis.title = element_blank(), axis.text = element_text(size = 20), axis.text.x = element_text(angle = 45, hjust = 1), legend.text = element_text(size = 20), legend.title = element_blank())



```






```{R}

ggplot(df.fft[df.fft$broad_deciduous == 100,], aes(x = CHELSA_Annual_Mean_Temperature))+
  geom_histogram()




```














```{R}
for(i in unique(newdata$prepcat)){
  print(summary(lm(scale(broad_evergreen)~scale(CHELSA_Annual_Mean_Temperature), data = newdata[newdata$prepcat == i, ])))
  print(summary(lm(scale(broad_deciduous)~scale(CHELSA_Annual_Mean_Temperature), data = newdata[newdata$prepcat == i, ])))
  print(summary(lm(scale(needle_evergreen)~scale(CHELSA_Annual_Mean_Temperature), data = newdata[newdata$prepcat == i, ])))


}

coefbe <- c(0.399, -0.179, -0.094, 0.578, 0.103, -0.564, 0.498, 0.339, -0.669, 0.458, -0.069, -0.551)

sebe <- c(0.039, 0.043, 0.043, 0.018, 0.022, 0.018, 0.018, 0.019, 0.015, 0.015, 0.016, 0.014)

prepcat <- c(rep('less than 400',times = 3), rep('400 to 800', times = 3), rep('800 to 1200', times = 3), rep('higher than 1200', times = 3))

fft <- rep(c('broad_evergreen', 'broad_deciduous', 'needle_evergreen'), times = 4)

coefdf <- data.frame('coefbe' = coefbe, 'sebe' = sebe, 'prepcat' = prepcat, 'fft' = fft)

coefdf$prepcat <- factor(coefdf$prepcat, levels = c('less than 400', '400 to 800', '800 to 1200', 'higher than 1200'))


ggplot(coefdf, aes(x = prepcat, y = coefbe, color = fft))+
  geom_point(size = 2)+
  geom_errorbar(aes(ymin = coefbe-2*sebe, ymax = coefbe + 2*sebe), width = 0, size = 1)+
  geom_line(aes(group = fft, color = fft), size = 1)+
  geom_abline(slope = 0, intercept = 0)

```


```{R}
for(i in unique(newdata$prepcat)){
  print(summary(lm(scale(broad)~scale(CHELSA_Annual_Mean_Temperature), data = newdata[newdata$prepcat == i, ])))
}


```


```{R}
coeflm <- c(0.117, 0.578, 0.673, 0.488, 0.586, 0.564)

selm <- c(0.043, 0.018, 0.015, 0.022, 0.027, 0.023)

prepcat <- c('less than 400', '400 to 800', ' 800 to 1200', '1200 to 1600', '1600 to 2000', 'higher than 2000')

group <- c(1,1,1,1,1,1)

coefdf <- data.frame('coeflm' = coeflm, 'selm' = selm, 'prepcat' = prepcat, 'group' = group)

coefdf$prepcat <- factor(coefdf$prepcat, levels = prepcat)

ggplot(coefdf, aes(x = prepcat, y = coeflm, color = coeflm/abs(coeflm)))+
  geom_point(size = 2)+
  geom_errorbar(aes(ymin = coeflm-2*selm, ymax = coeflm + 2*selm), width = 0, size = 1)+
  geom_line(aes(group = group, color = coeflm/coeflm), size = 1)+
  geom_abline(slope = 0, intercept = 0)+
  labs(x = 'Precipitation class (%)', y = 'Temp Effect on broadleaf')+
  theme(legend.position = 'none', axis.title = element_text(size = 20), axis.text.x = element_text(size = 20, angle = 45, hjust = 1,colour = 'black'), axis.text.y = element_text(size = 20,colour = 'black'))+
  scale_color_gradient(low = '#2166AC', high = '#2166AC')


```













```{R}
for(i in unique(newdata$prepcat)){
  print(summary(lm(scale(evergreen)~scale(CHELSA_Annual_Mean_Temperature), data = newdata[newdata$prepcat == i, ])))
}



```


```{R}
coeflm <- c(0.2, -0.082, -0.331, -0.069, 0.077, -0.007)

selm <- c(0.043, 0.022, 0.019, 0.025, 0.033, 0.028)

prepcat <- c('less than 400', '400 to 800', ' 800 to 1200', '1200 to 1600', '1600 to 2000', 'higher than 2000')

group <- c(1,1,1,1,1,1)

coefdf <- data.frame('coeflm' = coeflm, 'selm' = selm, 'prepcat' = prepcat, 'group' = group)

coefdf$prepcat <- factor(coefdf$prepcat, levels = prepcat)

ggplot(coefdf, aes(x = prepcat, y = coeflm, color = coeflm/abs(coeflm)))+
  geom_point(size = 2)+
  geom_errorbar(aes(ymin = coeflm-2*selm, ymax = coeflm + 2*selm), width = 0, size = 1)+
  geom_line(aes(group = group, color = coeflm/coeflm), size = 1)+
  geom_abline(slope = 0, intercept = 0)+
  labs(x = 'Precipitation class (%)', y = 'Temp Effect on evergreen')+
  theme(legend.position = 'none', axis.title = element_text(size = 20), axis.text.x = element_text(size = 20, angle = 45, hjust = 1,colour = 'black'), axis.text.y = element_text(size = 20,colour = 'black'))+
  scale_color_gradient(low = '#2166AC', high = '#2166AC')


```


```{R}

ggplot(df.fft, aes(x = CHELSA_Annual_Mean_Temperature))+
  geom_histogram()

quantile(df.fft$CHELSA_Annual_Mean_Temperature, 0.25)

quantile(df.fft$CHELSA_Annual_Mean_Temperature, 0.5)

quantile(df.fft$CHELSA_Annual_Mean_Temperature, 0.75)



quantile(df.fft$CHELSA_Annual_Mean_Temperature, 0.33)

quantile(df.fft$CHELSA_Annual_Mean_Temperature, 0.67)


quantile(df.fft$CHELSA_Annual_Mean_Temperature, 0.2)

quantile(df.fft$CHELSA_Annual_Mean_Temperature, 0.4)

quantile(df.fft$CHELSA_Annual_Mean_Temperature, 0.6)

quantile(df.fft$CHELSA_Annual_Mean_Temperature, 0.8)



```



```{R}
ggplot(df.fft, aes(x = CHELSA_Annual_Precipitation))+
  geom_histogram()
median(df.fft$CHELSA_Annual_Precipitation)


quantile(df.fft$CHELSA_Annual_Precipitation, 0.33)

quantile(df.fft$CHELSA_Annual_Precipitation, 0.67)
```




```{R}
#temp1 <- df.fft[df.fft$CHELSA_Annual_Mean_Temperature<0, ]
#temp1$tempcat <- '<8\u00B0C'

#temp2 <- df.fft[df.fft$CHELSA_Annual_Mean_Temperature>=0 & df.fft$CHELSA_Annual_Mean_Temperature<40, ]
#temp2$tempcat <- '<8\u00B0C'

#temp3 <- df.fft[df.fft$CHELSA_Annual_Mean_Temperature>=40 & df.fft$CHELSA_Annual_Mean_Temperature<80, ]
#temp3$tempcat <- '<8\u00B0C'

#temp4 <- df.fft[df.fft$CHELSA_Annual_Mean_Temperature >= 80 & df.fft$CHELSA_Annual_Mean_Temperature<120, ]
#temp4$tempcat <- '8~12\u00B0C'

#temp5 <- df.fft[df.fft$CHELSA_Annual_Mean_Temperature >= 120 & df.fft$CHELSA_Annual_Mean_Temperature <160, ]
#temp5$tempcat <- '12~16\u00B0C'

#temp6 <- df.fft[df.fft$CHELSA_Annual_Mean_Temperature >=160 & df.fft$CHELSA_Annual_Mean_Temperature<200, ]
#temp6$tempcat <- '\u226516\u00B0C'

#temp7 <- df.fft[df.fft$CHELSA_Annual_Mean_Temperature>=200,]
#temp7$tempcat <- '\u226516\u00B0C'

#newdata <- rbind(temp1, rbind(temp2, rbind(temp3, rbind(temp4, rbind(temp5, rbind(temp6,temp7))))))

#newdata$tempcat <- factor(newdata$tempcat, levels = c('<8\u00B0C', '8~12\u00B0C','12~16\u00B0C',  '\u226516\u00B0C'))


#ggplot(newdata, aes(x = CHELSA_Annual_Precipitation, y = broad_evergreen))+
#  geom_point(color = densCols(newdata$CHELSA_Annual_Precipitation, newdata$broad_evergreen))+
#  geom_smooth()+
#  facet_wrap(~tempcat, ncol = 1)
  


#ggplot(newdata, aes(x = CHELSA_Annual_Precipitation, y = broad_deciduous))+
#  geom_point(color = densCols(newdata$CHELSA_Annual_Precipitation, newdata$broad_deciduous))+
#  geom_smooth()+
#  facet_wrap(~tempcat, ncol = 1)


#ggplot(newdata, aes(x = CHELSA_Annual_Precipitation, y = needle_evergreen))+
#  geom_point(color = densCols(newdata$CHELSA_Annual_Precipitation, newdata$needle_evergreen))+
#  geom_smooth()+
#  facet_wrap(~tempcat, ncol = 1)


#ggplot(newdata, aes(x = tempcat, y = broad_evergreen))+
  
binomial_smooth <- function(...) {
  geom_smooth(method = "glm", method.args = list(family = "binomial"), ...)
}


new1 <- df.fft[df.fft$CHELSA_Annual_Precipitation < 400, ]
new1$prepcat <- '<400mm'

new2 <- df.fft[df.fft$CHELSA_Annual_Precipitation >= 1600, ]
new2$prepcat <- '\u22651600mm'

new3 <- df.fft[df.fft$CHELSA_Annual_Precipitation <1600 & df.fft$CHELSA_Annual_Precipitation >= 400, ]
new3$prepcat <- '400~1600mm'



newdata <- rbind(new1,rbind(new2, new3))


p1<-ggplot(newdata, aes(x = CHELSA_Annual_Mean_Temperature, y = broad_evergreen/100, color = prepcat))+
  geom_point(alpha = 0.1)+
  #stat_smooth(method = 'loess', span = 0.7, size = 1.5, se = FALSE, n = 200)+
  binomial_smooth(size = 1.5, se = FALSE)+
  #stat_summary(fun = median, fun.min = function(z){quantile(z, 0.45)}, fun.max = function(z){quantile(z, 0.55)}, size = 1)+
  #stat_summary(fun.data = 'mean_cl_boot', size = 1)+
  #stat_summary(fun = median, geom = 'line', size = 1, aes(group = prepcat))+
  #geom_path()+
  scale_color_viridis_d()+
  coord_cartesian(ylim = c(0,1))+
  theme_classic()+
  theme(axis.title = element_blank(), axis.text = element_text(size = 20), axis.text.x = element_text(angle = 45, hjust = 1), legend.text = element_text(size = 20), legend.title = element_blank())
  






new1 <- df.fft[df.fft$CHELSA_Annual_Precipitation < 400, ]
new1$prepcat <- '<400mm'

new2 <- df.fft[df.fft$CHELSA_Annual_Precipitation >= 1600, ]
new2$prepcat <- '\u22651600mm'

new3 <- df.fft[df.fft$CHELSA_Annual_Precipitation <=1600 & df.fft$CHELSA_Annual_Precipitation > 400, ]
new3$prepcat <- '400~1600mm'



newdata <- rbind(new1,rbind(new2,new3))


p2<-ggplot(newdata, aes(x = CHELSA_Annual_Mean_Temperature, y = broad_deciduous, color = prepcat))+
  stat_smooth(method = 'loess', span = 0.7, size = 1.5, se = FALSE, n = 200)+
  #stat_summary(fun = median, fun.min = function(z){quantile(z, 0.45)}, fun.max = function(z){quantile(z, 0.55)}, size = 1)+
  #stat_summary(fun.data = 'mean_cl_boot', size = 1)+
  #stat_summary(fun = median, geom = 'line', size = 1, aes(group = prepcat))+
  #geom_path()+
  scale_color_viridis_d()+
  coord_cartesian(ylim = c(0,100))+
  theme_classic()+
  theme(axis.title = element_blank(), axis.text = element_text(size = 20), axis.text.x = element_text(angle = 45, hjust = 1), legend.text = element_text(size = 20), legend.title = element_blank())



new1 <- df.fft[df.fft$CHELSA_Annual_Precipitation < 400, ]
new1$prepcat <- '<400mm'

new2 <- df.fft[df.fft$CHELSA_Annual_Precipitation >= 1600, ]
new2$prepcat <- '\u22651600mm'

new3 <- df.fft[df.fft$CHELSA_Annual_Precipitation <=1600 & df.fft$CHELSA_Annual_Precipitation > 400, ]
new3$prepcat <- '400~1600mm'

newdata <- rbind(new1,rbind(new2,new3))
#new1 <- newdata[newdata$CHELSA_Annual_Precipitation < 1600, ]
#new1$prepcat <- '<1600'

#new2 <- newdata[newdata$CHELSA_Annual_Precipitation >= 1600, ]
#new2$prepcat <- '\u22651600'

#new3 <- newdata[newdata$CHELSA_Annual_Precipitation <=2000 & newdata$CHELSA_Annual_Precipitation > 800, ]
#new3$prepcat <- '800 to 2000'



#newdata <- rbind(new1,new2)


p3<-ggplot(newdata, aes(x = CHELSA_Annual_Mean_Temperature, y = needle, color = prepcat))+
  stat_smooth(method = 'loess', span = 0.7, size = 1.5, se = FALSE, n = 200)+
  #stat_summary(fun = median, fun.min = function(z){quantile(z, 0.45)}, fun.max = function(z){quantile(z, 0.55)}, size = 1)+
  #stat_summary(fun.data = 'mean_cl_boot', size = 1)+
  #stat_summary(fun = median, geom = 'line', size = 1, aes(group = prepcat))+
  #geom_path()+
  scale_color_viridis_d()+
  coord_cartesian(ylim = c(0,100))+
  theme_classic()+
  theme(axis.title = element_blank(), axis.text = element_text(size = 20), axis.text.x = element_text(angle = 45, hjust = 1), legend.text = element_text(size = 20), legend.title = element_blank())








```


```{R}


new1 <- df.fft[df.fft$CHELSA_Annual_Precipitation < 400, ]
new1$prepcat <- '<400mm'

new2 <- df.fft[df.fft$CHELSA_Annual_Precipitation >= 1600, ]
new2$prepcat <- '\u22651600mm'

new3 <- df.fft[df.fft$CHELSA_Annual_Precipitation <1600 & df.fft$CHELSA_Annual_Precipitation >= 400, ]
new3$prepcat <- '400~1600mm'

new1$dens <- col2rgb(densCols(new1$CHELSA_Annual_Mean_Temperature, new1$broad_evergreen))[1,]+1L

newds1 <- new1[,c('CHELSA_Annual_Mean_Temperature', 'prepcat', 'broad_evergreen', 'dens')]

newds1$CHELSA_Annual_Mean_Temperature <- round(newds1$CHELSA_Annual_Mean_Temperature,1)

newds1 <- newds1[newds1$dens<140,]

new2$dens <- col2rgb(densCols(new2$CHELSA_Annual_Mean_Temperature, new2$broad_evergreen))[1,]+1L

newds2 <- new2[,c('CHELSA_Annual_Mean_Temperature', 'prepcat', 'broad_evergreen', 'dens')]

newds2$CHELSA_Annual_Mean_Temperature <- round(newds2$CHELSA_Annual_Mean_Temperature,1)

newds2 <- newds2[newds2$dens < 140,]


new3$dens <- col2rgb(densCols(new3$CHELSA_Annual_Mean_Temperature, new3$broad_evergreen))[1,]+1L

newds3 <- new3[,c('CHELSA_Annual_Mean_Temperature', 'prepcat', 'broad_evergreen', 'dens')]

newds3$CHELSA_Annual_Mean_Temperature <- round(newds3$CHELSA_Annual_Mean_Temperature,1)

newds3 <- newds3[newds3$dens < 140,]

library(dplyr)

newds1 <- newds1 %>%
  group_by(CHELSA_Annual_Mean_Temperature)%>%
  slice(which.min(dens))

newds2 <- newds2 %>%
  group_by(CHELSA_Annual_Mean_Temperature)%>%
  slice(which.min(dens))


newds3 <- newds3 %>%
  group_by(CHELSA_Annual_Mean_Temperature)%>%
  slice(which.min(dens))


newdata <- rbind(newds1,rbind(newds2,newds3))


newds1
ggplot(data = newds1, aes(x = CHELSA_Annual_Mean_Temperature, y = broad_evergreen))+
  geom_point()
  #geom_line()


ggplot(data = newds2, aes(x = CHELSA_Annual_Mean_Temperature, y = broad_evergreen))+
  geom_point()+
  geom_smooth(method = 'gam',orientation ='x', se = FALSE)


ggplot(data = newds3, aes(x = CHELSA_Annual_Mean_Temperature, y = broad_evergreen))+
  geom_point()
  #geom_line()


pwd4<-ggplot(newdata, aes(x = CHELSA_Annual_Mean_Temperature, y = broad_evergreen, color = prepcat))+
  #geom_point(size = 4, alpha = 0.3)+
  geom_smooth(method = 'loess', size = 1.5, span = 0.55)+
  scale_color_viridis_d()+
  coord_cartesian(ylim = c(0,100))+
  labs(x = 'Annual mean Temperature (\u00B0C)', y = 'Coverage')+
  theme_classic()+
  theme(axis.title = element_text(size = 20), axis.text = element_text(size = 20), axis.text.x = element_text(angle = 45, hjust = 1), legend.text = element_text(size = 20), legend.title = element_blank())


```


```{R}

new1 <- df.fft[df.fft$CHELSA_Annual_Precipitation < 400, ]
new1$prepcat <- '<400mm'

new2 <- df.fft[df.fft$CHELSA_Annual_Precipitation >= 1600, ]
new2$prepcat <- '\u22651600mm'

new3 <- df.fft[df.fft$CHELSA_Annual_Precipitation <1600 & df.fft$CHELSA_Annual_Precipitation >= 400, ]
new3$prepcat <- '400-1600mm'

new1$dens <- col2rgb(densCols(new1$CHELSA_Annual_Mean_Temperature, new1$broad_deciduous))[1,]+1L

newds1 <- new1[,c('CHELSA_Annual_Mean_Temperature', 'prepcat', 'broad_deciduous', 'dens')]

newds1$CHELSA_Annual_Mean_Temperature <- round(newds1$CHELSA_Annual_Mean_Temperature,1)

newds1 <- newds1[newds1$dens<100,]

new2$dens <- col2rgb(densCols(new2$CHELSA_Annual_Mean_Temperature, new2$broad_deciduous))[1,]+1L

newds2 <- new2[,c('CHELSA_Annual_Mean_Temperature', 'prepcat', 'broad_deciduous', 'dens')]

newds2$CHELSA_Annual_Mean_Temperature <- round(newds2$CHELSA_Annual_Mean_Temperature,1)

newds2 <- newds2[newds2$dens <100, ]


new3$dens <- col2rgb(densCols(new3$CHELSA_Annual_Mean_Temperature, new3$broad_deciduous))[1,]+1L

newds3 <- new3[,c('CHELSA_Annual_Mean_Temperature', 'prepcat', 'broad_deciduous', 'dens')]

newds3$CHELSA_Annual_Mean_Temperature <- round(newds3$CHELSA_Annual_Mean_Temperature,1)

newds3 <- newds3[newds3$dens<100,]
library(dplyr)

newds1 <- newds1 %>%
  group_by(CHELSA_Annual_Mean_Temperature)%>%
  slice(which.min(dens))

newds2 <- newds2 %>%
  group_by(CHELSA_Annual_Mean_Temperature)%>%
  slice(which.min(dens))


newds3 <- newds3 %>%
  group_by(CHELSA_Annual_Mean_Temperature)%>%
  slice(which.min(dens))


newdata <- rbind(newds1,rbind(newds2,newds3))


newds1
ggplot(data = newds1, aes(x = CHELSA_Annual_Mean_Temperature, y = broad_deciduous))+
  geom_point()
  #geom_line()


ggplot(data = newds2, aes(x = CHELSA_Annual_Mean_Temperature, y = broad_deciduous))+
  geom_point()+
  geom_smooth(method = 'gam',orientation ='x', se = FALSE)


ggplot(data = newds3, aes(x = CHELSA_Annual_Mean_Temperature, y = broad_deciduous))+
  geom_point()
  #geom_line()


pwd5<-ggplot(newdata, aes(x = CHELSA_Annual_Mean_Temperature, y = broad_deciduous, color = prepcat))+
  #geom_point(size = 4, alpha = 0.3)+
  geom_smooth(method = 'loess', size = 1.5, span = 0.55)+
  scale_color_viridis_d()+
  coord_cartesian(ylim = c(0,100))+
  labs(x = 'Annual mean temperature (\u00B0C)', y = 'Coverage')+
  theme_classic()+
  theme(axis.title = element_text(size = 20), axis.text = element_text(size = 20), axis.text.x = element_text(angle = 45, hjust = 1), legend.text = element_text(size = 20), legend.title = element_blank())


```

```{R}

new1 <- df.fft[df.fft$CHELSA_Annual_Precipitation < 400, ]
new1$prepcat <- '<400mm'

new2 <- df.fft[df.fft$CHELSA_Annual_Precipitation >= 1600, ]
new2$prepcat <- '\u2265400mm'

new3 <- df.fft[df.fft$CHELSA_Annual_Precipitation <1600 & df.fft$CHELSA_Annual_Precipitation >= 400, ]
new3$prepcat <- '\u2265400mm'

new1$dens <- col2rgb(densCols(new1$CHELSA_Annual_Mean_Temperature, new1$needle))[1,]+1L

newds1 <- new1[,c('CHELSA_Annual_Mean_Temperature', 'prepcat', 'needle', 'dens')]

newds1$CHELSA_Annual_Mean_Temperature <- round(newds1$CHELSA_Annual_Mean_Temperature,1)

newds1 <- newds1[newds1$dens<80,]

new2$dens <- col2rgb(densCols(new2$CHELSA_Annual_Mean_Temperature, new2$needle))[1,]+1L

newds2 <- new2[,c('CHELSA_Annual_Mean_Temperature', 'prepcat', 'needle', 'dens')]

newds2$CHELSA_Annual_Mean_Temperature <- round(newds2$CHELSA_Annual_Mean_Temperature,1)

newds2 <- newds2[newds2$dens<80,]


new3$dens <- col2rgb(densCols(new3$CHELSA_Annual_Mean_Temperature, new3$needle))[1,]+1L

newds3 <- new3[,c('CHELSA_Annual_Mean_Temperature', 'prepcat', 'needle', 'dens')]

newds3$CHELSA_Annual_Mean_Temperature <- round(newds3$CHELSA_Annual_Mean_Temperature,1)

newds3 <- newds3[newds3$dens<80,]
library(dplyr)

newds1 <- newds1 %>%
  group_by(CHELSA_Annual_Mean_Temperature)%>%
  slice(which.min(dens))

newds2 <- newds2 %>%
  group_by(CHELSA_Annual_Mean_Temperature)%>%
  slice(which.min(dens))


newds3 <- newds3 %>%
  group_by(CHELSA_Annual_Mean_Temperature)%>%
  slice(which.min(dens))


newdata <- rbind(newds1,rbind(newds2,newds3))


newds1
ggplot(data = newds1, aes(x = CHELSA_Annual_Mean_Temperature, y = needle))+
  geom_point()
  #geom_line()


ggplot(data = newds2, aes(x = CHELSA_Annual_Mean_Temperature, y = needle))+
  geom_point()+
  geom_smooth(method = 'gam',orientation ='x', se = FALSE)


ggplot(data = newds3, aes(x = CHELSA_Annual_Mean_Temperature, y = needle))+
  geom_point()
  #geom_line()


pwd6<-ggplot(newdata, aes(x = CHELSA_Annual_Mean_Temperature, y = needle, color = prepcat))+
  #geom_line(size = 1.5, alpha = 0.5)+
  #geom_point(size = 4, alpha = 0.4)+
  geom_smooth(method = 'loess', size = 1.5, span = 0.55)+
  scale_color_viridis_d()+
  coord_cartesian(ylim = c(0,100))+
  labs(x = 'Annual mean temperature (\u00B0C)', y = 'Coverage (%)')+
  theme_classic()+
  theme(axis.title = element_text(size = 20), axis.text = element_text(size = 20), axis.text.x = element_text(angle = 45, hjust = 1), legend.text = element_text(size = 20), legend.title = element_blank())

```



```{R}

library(ggpubr)


ggarrange(pwd1,pwd2,pwd3,
          pwd4, pwd5, pwd6,
          #labels = c('D', 'E', 'F'),
        font.label = list(face = 'bold',color = 'black',size = 20),
        ncol = 3,
        nrow = 2)


```






```{R}
for(i in unique(newdata$tempcat)){
  print(summary(lm(scale(broad_evergreen)~scale(CHELSA_Annual_Precipitation), data = newdata[newdata$tempcat == i, ])))
  print(summary(lm(scale(broad_deciduous)~scale(CHELSA_Annual_Precipitation), data = newdata[newdata$tempcat == i, ])))
  print(summary(lm(scale(needle_evergreen)~scale(CHELSA_Annual_Precipitation), data = newdata[newdata$tempcat == i, ])))


}

coefbe <- c(-0.003, -0.375, 0.393, 0.282, -0.038, -0.138, 0.344, -0.064, -0.329, 0.406, -0.366, -0.141)

sebe <- c(0.037, 0.034, 0.034, 0.018, 0.019, 0.018, 0.019, 0.02, 0.019, 0.018, 0.018, 0.019)

tempcat <- c(rep('less than 0',times = 3), rep('0 to 10', times = 3), rep('10 to 20', times = 3), rep('higher than 20', times = 3))

fft <- rep(c('broad_evergreen', 'broad_deciduous', 'needle_evergreen'), times = 4)

coefdf <- data.frame('coefbe' = coefbe, 'sebe' = sebe, 'tempcat' = tempcat, 'fft' = fft)

coefdf$tempcat <- factor(coefdf$tempcat, levels = c('less than 0', '0 to 10', '10 to 20', 'higher than 20'))


ggplot(coefdf, aes(x = tempcat, y = coefbe, color = fft))+
  geom_point(size = 2)+
  geom_errorbar(aes(ymin = coefbe-2*sebe, ymax = coefbe + 2*sebe), width = 0, size = 1)+
  geom_abline(slope = 0, intercept = 0)+
  geom_line(aes(group = fft, color = fft), size = 1)

```




```{R}
for(i in unique(newdata$tempcat)){
  print(summary(lm(scale(broad)~scale(CHELSA_Annual_Precipitation), data = newdata[newdata$tempcat == i, ])))
  
}


```

```{R}
coeflm <- c(-0.132, -0.012, 0.288, 0.344, 0.282, 0.152)

selm <- c(0.02, 0.036, 0.03, 0.032, 0.032, 0.019)

prepcat <- c('lower than 4', '4 to 8', ' 8 to 12', '12 to 16', '16 to 20', 'higher than 20')

group <- c(1,1,1,1,1,1)

coefdf <- data.frame('coeflm' = coeflm, 'selm' = selm, 'prepcat' = prepcat, 'group' = group)

coefdf$prepcat <- factor(coefdf$prepcat, levels = prepcat)

ggplot(coefdf, aes(x = prepcat, y = coeflm, color = coeflm/abs(coeflm)))+
  geom_point(size = 2)+
  geom_errorbar(aes(ymin = coeflm-2*selm, ymax = coeflm + 2*selm), width = 0, size = 1)+
  scale_color_gradient(low = '#2166AC', high = '#2166AC')+
  geom_line(aes(group = group, color = coeflm/coeflm), size = 1)+
  geom_abline(slope = 0, intercept = 0)+
  labs(x = 'Temperature class (%)', y = 'Prep Effect on broadleaf')+
  theme(legend.position = 'none', axis.title = element_text(size = 20), axis.text.x = element_text(size = 20, angle = 45, hjust = 1,colour = 'black'), axis.text.y = element_text(size = 20,colour = 'black'))
  


```











```{R}
for(i in unique(newdata$tempcat)){
  print(summary(lm(scale(evergreen)~scale(CHELSA_Annual_Precipitation), data = newdata[newdata$tempcat == i, ])))
  
}


```




```{R}
coeflm <- c(0.151, 0.1, 0.079, 0.003, 0.106, 0.371)

selm <- c(0.02, 0.036, 0.031, 0.034, 0.033, 0.018)

prepcat <- c('lower than 4', '4 to 8', ' 8 to 12', '12 to 16', '16 to 20', 'higher than 20')

group <- c(1,1,1,1,1,1)

coefdf <- data.frame('coeflm' = coeflm, 'selm' = selm, 'prepcat' = prepcat, 'group' = group)

coefdf$prepcat <- factor(coefdf$prepcat, levels = prepcat)

ggplot(coefdf, aes(x = prepcat, y = coeflm, color = coeflm/abs(coeflm)))+
  geom_point(size = 2)+
  geom_errorbar(aes(ymin = coeflm-2*selm, ymax = coeflm + 2*selm), width = 0, size = 1)+
  scale_color_gradient(low = '#2166AC', high = '#2166AC')+
  geom_line(aes(group = group, color = coeflm/coeflm), size = 1)+
  geom_abline(slope = 0, intercept = 0)+
  labs(x = 'Temperature class (%)', y = 'Prep Effect on evergreen')+
  theme(legend.position = 'none', axis.title = element_text(size = 20), axis.text.x = element_text(size = 20, angle = 45, hjust = 1,colour = 'black'), axis.text.y = element_text(size = 20,colour = 'black'))
  


```


```{R}

ggplot(data = df.fft, aes(x = CHELSA_Temperature_Seasonality))+
  geom_histogram()





```

```{R}
tempseason1 <- df.fft[df.fft$CHELSA_Temperature_Seasonality<4000, ]
tempseason1$tempseasoncat <- '<4000'

tempseason2 <- df.fft[df.fft$CHELSA_Temperature_Seasonality>=4000 & df.fft$CHELSA_Temperature_Seasonality<8000, ]
tempseason2$tempseasoncat <- '4000~8000'

tempseason3 <- df.fft[df.fft$CHELSA_Temperature_Seasonality>=8000 & df.fft$CHELSA_Temperature_Seasonality<12000, ]
tempseason3$tempseasoncat <- '8000~12000'

tempseason4 <- df.fft[df.fft$CHELSA_Temperature_Seasonality >= 12000, ]
tempseason4$tempseasoncat <- '\u226512000'

summary(tempseason4$CHELSA_Annual_Precipitation)
nrow(tempseason4)


#temp5 <- df.fft[df.fft$CHELSA_Annual_Mean_Temperature >= 120 & df.fft$CHELSA_Annual_Mean_Temperature <160, ]
#temp5$tempcat <- '12 to 16'

#temp6 <- df.fft[df.fft$CHELSA_Annual_Mean_Temperature >=160 & df.fft$CHELSA_Annual_Mean_Temperature<200, ]
#temp6$tempcat <- '16 to 20'

#temp7 <- df.fft[df.fft$CHELSA_Annual_Mean_Temperature>=200,]
#temp7$tempcat <- 'higher than 20'

newdata <- rbind(tempseason1, rbind(tempseason2,rbind(tempseason3,tempseason4)))

newdata$tempseasoncat <- factor(newdata$tempseasoncat, levels = c('<4000', '4000~8000', '8000~12000', '\u226512000'))


new1 <- newdata[newdata$CHELSA_Annual_Precipitation < 600, ]
new1$prepcat <- '<600mm'

new2 <- newdata[newdata$CHELSA_Annual_Precipitation >= 2000, ]
new2$prepcat <- '\u22652000mm'

new3 <- newdata[newdata$CHELSA_Annual_Precipitation <2000 & newdata$CHELSA_Annual_Precipitation >= 600, ]
new3$prepcat <- '600~2000mm'



newdata <- rbind(new1,rbind(new2, new3))


p7<-ggplot(newdata, aes(x = tempseasoncat, y = broad_evergreen, color = prepcat))+
  stat_summary(fun = median, fun.min = function(z){quantile(z, 0.45)}, fun.max = function(z){quantile(z, 0.55)}, size = 1)+
  #stat_summary(fun.data = 'mean_cl_boot', size = 1)+
  stat_summary(fun = median, geom = 'line', size = 1, aes(group = prepcat))+
  #geom_path()+
  scale_color_viridis_d()+
  coord_cartesian(ylim = c(0,100))+
  theme_classic()+
  theme(axis.title = element_blank(), axis.text = element_text(size = 20), axis.text.x = element_text(angle = 45, hjust = 1), legend.text = element_text(size = 20), legend.title = element_blank())




new1 <- newdata[newdata$CHELSA_Annual_Precipitation < 600, ]
new1$prepcat <- '<600mm'

new2 <- newdata[newdata$CHELSA_Annual_Precipitation >= 600, ]
new2$prepcat <- '\u2265600mm'

#new3 <- newdata[newdata$CHELSA_Annual_Precipitation <=2000 & newdata$CHELSA_Annual_Precipitation > 800, ]
#new3$prepcat <- '800 to 2000'



newdata <- rbind(new1,new2)


p8<-ggplot(newdata, aes(x = tempseasoncat, y = broad_deciduous, color = prepcat))+
  stat_summary(fun = median, fun.min = function(z){quantile(z, 0.45)}, fun.max = function(z){quantile(z, 0.55)}, size = 1)+
  #stat_summary(fun.data = 'mean_cl_boot', size = 1)+
  stat_summary(fun = median, geom = 'line', size = 1, aes(group = prepcat))+
  #geom_path()+
  scale_color_viridis_d()+
  coord_cartesian(ylim = c(0,100))+
  theme_classic()+
  theme(axis.title = element_blank(), axis.text = element_text(size = 20), axis.text.x = element_text(angle = 45, hjust = 1), legend.text = element_text(size = 20), legend.title = element_blank())





new1 <- newdata[newdata$CHELSA_Annual_Precipitation < 600, ]
new1$prepcat <- '<600mm'

new2 <- newdata[newdata$CHELSA_Annual_Precipitation >= 600, ]
new2$prepcat <- '\u2265600mm'

#new3 <- newdata[newdata$CHELSA_Annual_Precipitation <=2000 & newdata$CHELSA_Annual_Precipitation > 800, ]
#new3$prepcat <- '800 to 2000'



newdata <- rbind(new1,new2)


p9<-ggplot(newdata, aes(x = tempseasoncat, y = needle, color = prepcat))+
  stat_summary(fun = median, fun.min = function(z){quantile(z, 0.45)}, fun.max = function(z){quantile(z, 0.55)}, size = 1)+
  #stat_summary(fun.data = 'mean_cl_boot', size = 1)+
  stat_summary(fun = median, geom = 'line', size = 1, aes(group = prepcat))+
  #geom_path()+
  scale_color_viridis_d()+
  coord_cartesian(ylim = c(0,100))+
  theme_classic()+
  theme(axis.title = element_blank(), axis.text = element_text(size = 20), axis.text.x = element_text(angle = 45, hjust = 1), legend.text = element_text(size = 20), legend.title = element_blank())








```


```{R}

new1 <- df.fft[df.fft$CHELSA_Annual_Precipitation < 600, ]
new1$prepcat <- '<600mm'

new2 <- df.fft[df.fft$CHELSA_Annual_Precipitation >= 1600, ]
new2$prepcat <- '\u22651600mm'

new3 <- df.fft[df.fft$CHELSA_Annual_Precipitation <1600 & df.fft$CHELSA_Annual_Precipitation >= 600, ]
new3$prepcat <- '600~1600mm'



new1$dens <- col2rgb(densCols(new1$CHELSA_Temperature_Seasonality, new1$broad_evergreen))[1,]+1L

newds1 <- new1[,c('CHELSA_Temperature_Seasonality', 'prepcat', 'broad_evergreen', 'dens')]

newds1$CHELSA_Temperature_Seasonality <- round(newds1$CHELSA_Temperature_Seasonality,1)

newds1 <- newds1[newds1$dens<140,]

new2$dens <- col2rgb(densCols(new2$CHELSA_Temperature_Seasonality, new2$broad_evergreen))[1,]+1L

newds2 <- new2[,c('CHELSA_Temperature_Seasonality', 'prepcat', 'broad_evergreen', 'dens')]

newds2$CHELSA_Temperature_Seasonality <- round(newds2$CHELSA_Temperature_Seasonality,1)

newds2 <- newds2[newds2$dens <140, ]


new3$dens <- col2rgb(densCols(new3$CHELSA_Temperature_Seasonality, new3$broad_evergreen))[1,]+1L

newds3 <- new3[,c('CHELSA_Temperature_Seasonality', 'prepcat', 'broad_evergreen', 'dens')]

newds3$CHELSA_Temperature_Seasonality <- round(newds3$CHELSA_Temperature_Seasonality,1)

newds3 <- newds3[newds3$dens<140,]
library(dplyr)

newds1 <- newds1 %>%
  group_by(CHELSA_Temperature_Seasonality)%>%
  slice(which.min(dens))

newds2 <- newds2 %>%
  group_by(CHELSA_Temperature_Seasonality)%>%
  slice(which.min(dens))


newds3 <- newds3 %>%
  group_by(CHELSA_Temperature_Seasonality)%>%
  slice(which.min(dens))


newdata <- rbind(newds1,rbind(newds2,newds3))


newds1
ggplot(data = newds1, aes(x = CHELSA_Temperature_Seasonality, y = broad_evergreen))+
  geom_point()+
  geom_smooth(method = 'gam', se = FALSE)
  #geom_line()


ggplot(data = newds2, aes(x = CHELSA_Temperature_Seasonality, y = broad_evergreen))+
  geom_point()+
  geom_smooth(method = 'gam',orientation ='x', se = FALSE)


ggplot(data = newds3, aes(x = CHELSA_Temperature_Seasonality, y = broad_evergreen))+
  geom_point()+
  geom_smooth(method = 'gam', se = FALSE)
  #geom_line()


pwd7<-ggplot(newdata, aes(x = CHELSA_Temperature_Seasonality, y = broad_evergreen, color = prepcat))+
  #geom_point(size = 4, alpha = 0.3)+
  geom_smooth(method = 'loess', size = 1.5, span = 0.55)+
  scale_color_viridis_d()+
  coord_cartesian(ylim = c(0,100))+
  labs(x = 'Temperature seasonality', y = 'Coverage (%)')+
  theme_classic()+
  theme(axis.title = element_text(size = 20), axis.text = element_text(size = 20), axis.text.x = element_text(angle = 45, hjust = 1), legend.text = element_text(size = 20), legend.title = element_blank())


```





```{R}

new1 <- df.fft[df.fft$CHELSA_Annual_Precipitation < 600, ]
new1$prepcat <- '<600mm'

new2 <- df.fft[df.fft$CHELSA_Annual_Precipitation >= 1600, ]
new2$prepcat <- '\u22651600mm'

new3 <- df.fft[df.fft$CHELSA_Annual_Precipitation <1600 & df.fft$CHELSA_Annual_Precipitation >= 600, ]
new3$prepcat <- '600~1600mm'



new1$dens <- col2rgb(densCols(new1$CHELSA_Temperature_Seasonality, new1$broad_deciduous))[1,]+1L

newds1 <- new1[,c('CHELSA_Temperature_Seasonality', 'prepcat', 'broad_deciduous', 'dens')]

newds1$CHELSA_Temperature_Seasonality <- round(newds1$CHELSA_Temperature_Seasonality,1)

newds1 <- newds1[newds1$dens<140,]

new2$dens <- col2rgb(densCols(new2$CHELSA_Temperature_Seasonality, new2$broad_deciduous))[1,]+1L

newds2 <- new2[,c('CHELSA_Temperature_Seasonality', 'prepcat', 'broad_deciduous', 'dens')]

newds2$CHELSA_Temperature_Seasonality <- round(newds2$CHELSA_Temperature_Seasonality,1)

newds2 <- newds2[newds2$dens <140, ]


new3$dens <- col2rgb(densCols(new3$CHELSA_Temperature_Seasonality, new3$broad_deciduous))[1,]+1L

newds3 <- new3[,c('CHELSA_Temperature_Seasonality', 'prepcat', 'broad_deciduous', 'dens')]

newds3$CHELSA_Temperature_Seasonality <- round(newds3$CHELSA_Temperature_Seasonality,1)

newds3 <- newds3[newds3$dens<140,]
library(dplyr)

newds1 <- newds1 %>%
  group_by(CHELSA_Temperature_Seasonality)%>%
  slice(which.min(dens))

newds2 <- newds2 %>%
  group_by(CHELSA_Temperature_Seasonality)%>%
  slice(which.min(dens))


newds3 <- newds3 %>%
  group_by(CHELSA_Temperature_Seasonality)%>%
  slice(which.min(dens))


newdata <- rbind(newds1,rbind(newds2,newds3))


newds1
ggplot(data = newds1, aes(x = CHELSA_Temperature_Seasonality, y = broad_deciduous))+
  geom_point()+
  geom_smooth(method = 'gam', se = FALSE)
  #geom_line()


ggplot(data = newds2, aes(x = CHELSA_Temperature_Seasonality, y = broad_deciduous))+
  geom_point()+
  geom_smooth(method = 'gam',orientation ='x', se = FALSE)


ggplot(data = newds3, aes(x = CHELSA_Temperature_Seasonality, y = broad_deciduous))+
  geom_point()+
  geom_smooth(method = 'gam', se = FALSE)
  #geom_line()


pwd8<-ggplot(newdata, aes(x = CHELSA_Temperature_Seasonality, y = broad_deciduous, color = prepcat))+
  #geom_point(size = 4, alpha = 0.3)+
  geom_smooth(method = 'loess', size = 1.5, span = 0.55)+
  scale_color_viridis_d()+
  coord_cartesian(ylim = c(0,100))+
  labs(x = 'Temperature seasonality', y = 'Coverage (%)')+
  theme_classic()+
  theme(axis.title = element_text(size = 20), axis.text = element_text(size = 20), axis.text.x = element_text(angle = 45, hjust = 1), legend.text = element_text(size = 20), legend.title = element_blank())





```





```{R}

new1 <- df.fft[df.fft$CHELSA_Annual_Precipitation < 600, ]
new1$prepcat <- '<600mm'

new2 <- df.fft[df.fft$CHELSA_Annual_Precipitation >= 1600, ]
new2$prepcat <- '\u2265600mm'

new3 <- df.fft[df.fft$CHELSA_Annual_Precipitation <1600 & df.fft$CHELSA_Annual_Precipitation >= 600, ]
new3$prepcat <- '\u2265600mm'



new1$dens <- col2rgb(densCols(new1$CHELSA_Temperature_Seasonality, new1$needle))[1,]+1L

newds1 <- new1[,c('CHELSA_Temperature_Seasonality', 'prepcat', 'needle', 'dens')]

newds1$CHELSA_Temperature_Seasonality <- round(newds1$CHELSA_Temperature_Seasonality,1)

newds1 <- newds1[newds1$dens<140,]

new2$dens <- col2rgb(densCols(new2$CHELSA_Temperature_Seasonality, new2$needle))[1,]+1L

newds2 <- new2[,c('CHELSA_Temperature_Seasonality', 'prepcat', 'needle', 'dens')]

newds2$CHELSA_Temperature_Seasonality <- round(newds2$CHELSA_Temperature_Seasonality,1)

newds2 <- newds2[newds2$dens <140, ]


new3$dens <- col2rgb(densCols(new3$CHELSA_Temperature_Seasonality, new3$needle))[1,]+1L

newds3 <- new3[,c('CHELSA_Temperature_Seasonality', 'prepcat', 'needle', 'dens')]

newds3$CHELSA_Temperature_Seasonality <- round(newds3$CHELSA_Temperature_Seasonality,1)

newds3 <- newds3[newds3$dens<140,]
library(dplyr)

newds1 <- newds1 %>%
  group_by(CHELSA_Temperature_Seasonality)%>%
  slice(which.min(dens))

newds2 <- newds2 %>%
  group_by(CHELSA_Temperature_Seasonality)%>%
  slice(which.min(dens))


newds3 <- newds3 %>%
  group_by(CHELSA_Temperature_Seasonality)%>%
  slice(which.min(dens))


newdata <- rbind(newds1,rbind(newds2,newds3))


newds1
ggplot(data = newds1, aes(x = CHELSA_Temperature_Seasonality, y = needle))+
  geom_point()+
  geom_smooth(method = 'gam', se = FALSE)
  #geom_line()


ggplot(data = newds2, aes(x = CHELSA_Temperature_Seasonality, y = needle))+
  geom_point()+
  geom_smooth(method = 'gam',orientation ='x', se = FALSE)


ggplot(data = newds3, aes(x = CHELSA_Temperature_Seasonality, y = needle))+
  geom_point()+
  geom_smooth(method = 'gam', se = FALSE)
  #geom_line()


pwd9<-ggplot(newdata, aes(x = CHELSA_Temperature_Seasonality, y = needle, color = prepcat))+
  #geom_point(size = 4, alpha = 0.3)+
  geom_smooth(method = 'loess', size = 1.5, span = 0.55,fullrange = TRUE)+
  scale_color_viridis_d()+
  coord_cartesian(ylim = c(0,100))+
  labs(x = 'Temperature seasonality', y = 'Coverage (%)')+
  theme_classic()+
  theme(axis.title = element_text(size = 20), axis.text = element_text(size = 20), axis.text.x = element_text(angle = 45, hjust = 1), legend.text = element_text(size = 20), legend.title = element_blank())




```



```{R}

ggarrange(pwd4,pwd5,pwd6,
           pwd7, pwd8, pwd9,
           #labels = c('D', 'E', 'F'),
           font.label = list(face = 'bold',color = 'black',size = 20),
           ncol = 3,
           nrow = 2)

```










```{R}

ggplot(data = df.fft, aes(x = CHELSA_Precipitation_Seasonality))+
  geom_histogram()

ggplot(data = df.fft, aes(x = CHELSA_Annual_Precipitation, y = CHELSA_Precipitation_Seasonality))+
  geom_point(alpha = 0.1)+
  geom_smooth(method = 'gam')



```




```{R}
prepseason1 <- df.fft[df.fft$CHELSA_Precipitation_Seasonality<25, ]
prepseason1$prepseasoncat <- 'less than 25'

prepseason2 <- df.fft[df.fft$CHELSA_Precipitation_Seasonality>=25 & df.fft$CHELSA_Precipitation_Seasonality<50, ]
prepseason2$prepseasoncat <- '25 to 50'

prepseason3 <- df.fft[df.fft$CHELSA_Precipitation_Seasonality>= 50 & df.fft$CHELSA_Precipitation_Seasonality< 75, ]
prepseason3$prepseasoncat <- '50 to 75'

prepseason4 <- df.fft[df.fft$CHELSA_Precipitation_Seasonality >= 75, ]
prepseason4$prepseasoncat <- 'higher than 75'

summary(prepseason4$CHELSA_Annual_Mean_Temperature)
nrow(prepseason4)


#temp5 <- df.fft[df.fft$CHELSA_Annual_Mean_Temperature >= 120 & df.fft$CHELSA_Annual_Mean_Temperature <160, ]
#temp5$tempcat <- '12 to 16'

#temp6 <- df.fft[df.fft$CHELSA_Annual_Mean_Temperature >=160 & df.fft$CHELSA_Annual_Mean_Temperature<200, ]
#temp6$tempcat <- '16 to 20'

#temp7 <- df.fft[df.fft$CHELSA_Annual_Mean_Temperature>=200,]
#temp7$tempcat <- 'higher than 20'

newdata <- rbind(prepseason1, rbind(prepseason2,rbind(prepseason3,prepseason4)))

newdata$prepseasoncat <- factor(newdata$prepseasoncat, levels = c('less than 25', '25 to 50', '50 to 75', 'higher than 75'))


new1 <- newdata[newdata$CHELSA_Annual_Mean_Temperature <= 160 & newdata$CHELSA_Annual_Mean_Temperature > 30, ]
new1$tempcat <- '3 to 16'

new2 <- newdata[newdata$CHELSA_Annual_Mean_Temperature > 160, ]
new2$tempcat <- 'higher than 16'

new3 <- newdata[newdata$CHELSA_Annual_Mean_Temperature <= 30, ]
new3$tempcat <- 'lower than 3'

newdata <- rbind(new1, rbind(new2,new3))


ggplot(newdata, aes(x = prepseasoncat, y = broad_evergreen, color = tempcat))+
  stat_summary(fun = median, fun.min = function(z){quantile(z, 0.45)}, fun.max = function(z){quantile(z, 0.55)}, size = 1)+
  #stat_summary(fun.data = 'mean_cl_boot', size = 1)+
  stat_summary(fun = median, geom = 'line', size = 1, aes(group = tempcat))+
  #geom_path()+
  scale_color_viridis_d()+
  coord_cartesian(ylim = c(0,100))



new1 <- newdata[newdata$CHELSA_Annual_Mean_Temperature <=160 & newdata$CHELSA_Annual_Mean_Temperature>30,]
new1$tempcat <- '3 to 16'


new2 <- newdata[newdata$CHELSA_Annual_Mean_Temperature > 160, ]
new2$tempcat <- 'higher than 16'

new3 <- newdata[newdata$CHELSA_Annual_Mean_Temperature <= 30,]
new3$tempcat <- 'lower than 3'

newdata <- rbind(new1,rbind(new2, new3))




ggplot(newdata, aes(x = prepseasoncat, y = broad_deciduous, color = tempcat))+
  stat_summary(fun = median, fun.min = function(z){quantile(z, 0.45)}, fun.max = function(z){quantile(z, 0.55)}, size = 1)+
  #stat_summary(fun.data = 'mean_cl_boot', size = 1)+
  stat_summary(fun = median, geom = 'line', size = 1, aes(group = tempcat))+
  #geom_path()+
  scale_color_viridis_d()+
  coord_cartesian(ylim = c(0,100))


new1 <- newdata[newdata$CHELSA_Annual_Mean_Temperature <= 60, ]
new1$tempcat <- 'lower than 6'

new2 <- newdata[newdata$CHELSA_Annual_Mean_Temperature > 60, ]
new2$tempcat <- 'higher than 6'


newdata <- rbind(new1, new2)





ggplot(newdata, aes(x = prepseasoncat, y = needle, color = tempcat))+
  stat_summary(fun = median, fun.min = function(z){quantile(z, 0.45)}, fun.max = function(z){quantile(z, 0.55)}, size = 1)+
  #stat_summary(fun.data = 'mean_cl_boot', size = 1)+
  stat_summary(fun = median, geom = 'line', size = 1, aes(group = tempcat))+
  #geom_path()+
  scale_color_viridis_d()+
  coord_cartesian(ylim = c(0,100))



```





```{R}



prepseason1 <- df.fft[df.fft$CHELSA_Precipitation_Seasonality<25, ]
prepseason1$prepseasoncat <- 'less than 25'

prepseason2 <- df.fft[df.fft$CHELSA_Precipitation_Seasonality>=25 & df.fft$CHELSA_Precipitation_Seasonality<50, ]
prepseason2$prepseasoncat <- '25 to 50'

prepseason3 <- df.fft[df.fft$CHELSA_Precipitation_Seasonality>= 50 & df.fft$CHELSA_Precipitation_Seasonality< 75, ]
prepseason3$prepseasoncat <- '50 to 75'

prepseason4 <- df.fft[df.fft$CHELSA_Precipitation_Seasonality >= 75, ]
prepseason4$prepseasoncat <- 'higher than 75'

summary(prepseason4$CHELSA_Annual_Mean_Temperature)
nrow(prepseason4)


#temp5 <- df.fft[df.fft$CHELSA_Annual_Mean_Temperature >= 120 & df.fft$CHELSA_Annual_Mean_Temperature <160, ]
#temp5$tempcat <- '12 to 16'

#temp6 <- df.fft[df.fft$CHELSA_Annual_Mean_Temperature >=160 & df.fft$CHELSA_Annual_Mean_Temperature<200, ]
#temp6$tempcat <- '16 to 20'

#temp7 <- df.fft[df.fft$CHELSA_Annual_Mean_Temperature>=200,]
#temp7$tempcat <- 'higher than 20'

newdata <- rbind(prepseason1, rbind(prepseason2,rbind(prepseason3,prepseason4)))

newdata$prepseasoncat <- factor(newdata$prepseasoncat, levels = c('less than 25', '25 to 50', '50 to 75', 'higher than 75'))



new1 <- newdata[newdata$CHELSA_Annual_Precipitation <= 800, ]
new1$prepcat <- 'less than 800'

new2 <- newdata[newdata$CHELSA_Annual_Precipitation > 1800, ]
new2$prepcat <- 'higher than 1800'

new3 <- newdata[newdata$CHELSA_Annual_Precipitation <=1800 & newdata$CHELSA_Annual_Precipitation > 800, ]
new3$prepcat <- '800 to 1800'



newdata <- rbind(new1,rbind(new2, new3))


ggplot(newdata, aes(x = prepseasoncat, y = broad_evergreen, color = prepcat))+
  stat_summary(fun = median, fun.min = function(z){quantile(z, 0.45)}, fun.max = function(z){quantile(z, 0.55)}, size = 1)+
  #stat_summary(fun.data = 'mean_cl_boot', size = 1)+
  stat_summary(fun = median, geom = 'line', size = 1, aes(group = prepcat))+
  #geom_path()+
  scale_color_viridis_d()+
  coord_cartesian(ylim = c(0,100))




new1 <- newdata[newdata$CHELSA_Annual_Precipitation <= 800, ]
new1$prepcat <- 'less than 800'

new2 <- newdata[newdata$CHELSA_Annual_Precipitation > 1800, ]
new2$prepcat <- 'higher than 1800'

new3 <- newdata[newdata$CHELSA_Annual_Precipitation <=1800 & newdata$CHELSA_Annual_Precipitation > 800, ]
new3$prepcat <- '800 to 1800'



newdata <- rbind(new1,rbind(new2,new3))


ggplot(newdata, aes(x = prepseasoncat, y = broad_deciduous, color = prepcat))+
  stat_summary(fun = median, fun.min = function(z){quantile(z, 0.45)}, fun.max = function(z){quantile(z, 0.55)}, size = 1)+
  #stat_summary(fun.data = 'mean_cl_boot', size = 1)+
  stat_summary(fun = median, geom = 'line', size = 1, aes(group = prepcat))+
  #geom_path()+
  scale_color_viridis_d()+
  coord_cartesian(ylim = c(0,100))





new1 <- newdata[newdata$CHELSA_Annual_Precipitation <= 800, ]
new1$prepcat <- 'less than 800'

new2 <- newdata[newdata$CHELSA_Annual_Precipitation > 800, ]
new2$prepcat <- 'higher than 800'

#new3 <- newdata[newdata$CHELSA_Annual_Precipitation <=2000 & newdata$CHELSA_Annual_Precipitation > 800, ]
#new3$prepcat <- '800 to 2000'



newdata <- rbind(new1,new2)


ggplot(newdata, aes(x = prepseasoncat, y = needle, color = prepcat))+
  stat_summary(fun = median, fun.min = function(z){quantile(z, 0.45)}, fun.max = function(z){quantile(z, 0.55)}, size = 1)+
  #stat_summary(fun.data = 'mean_cl_boot', size = 1)+
  stat_summary(fun = median, geom = 'line', size = 1, aes(group = prepcat))+
  #geom_path()+
  scale_color_viridis_d()+
  coord_cartesian(ylim = c(0,100))


```























```{R}

ggplot(df.fft, aes(x = Aridity_Index))+
  geom_histogram()


```


```{R}


aridity1 <- df.fft[df.fft$Aridity_Index<5000, ]
aridity1$ariditycat <- 'less than 5000'

aridity2 <- df.fft[df.fft$Aridity_Index>=5000 & df.fft$Aridity_Index<10000, ]
aridity2$ariditycat <- '5000 to 10000'

aridity3 <- df.fft[df.fft$Aridity_Index>= 10000 & df.fft$Aridity_Index< 15000, ]
aridity3$ariditycat <- '10000 to 15000'

aridity4 <- df.fft[df.fft$Aridity_Index >= 15000 & df.fft$Aridity_Index < 20000, ]
aridity4$ariditycat <- '15000 to 20000'

aridity5 <- df.fft[df.fft$Aridity_Index >= 20000,]
aridity5$ariditycat <- 'higher than 20000'




newdata <- rbind(aridity1, rbind(aridity2,rbind(aridity3,rbind(aridity4,aridity5))))

newdata$ariditycat <- factor(newdata$ariditycat, levels = c('less than 5000', '5000 to 10000', '10000 to 15000', '15000 to 20000', 'higher than 20000'))




new1 <- newdata[newdata$CHELSA_Annual_Mean_Temperature <= 180 & newdata$CHELSA_Annual_Mean_Temperature > 80, ]
new1$tempcat <- 'higher than 8'

new2 <- newdata[newdata$CHELSA_Annual_Mean_Temperature > 180, ]
new2$tempcat <- 'higher than 8'

new3 <- newdata[newdata$CHELSA_Annual_Mean_Temperature <= 80, ]
new3$tempcat <- 'lower than 8'

newdata <- rbind(new1, rbind(new2,new3))


p10<-ggplot(newdata, aes(x = ariditycat, y = broad_evergreen, color = tempcat))+
  stat_summary(fun = median, fun.min = function(z){quantile(z, 0.45)}, fun.max = function(z){quantile(z, 0.55)}, size = 1)+
  #stat_summary(fun.data = 'mean_cl_boot', size = 1)+
  stat_summary(fun = median, geom = 'line', size = 1, aes(group = tempcat))+
  #geom_path()+
  scale_color_viridis_d()+
  coord_cartesian(ylim = c(0,100))+
  theme(axis.title = element_text(size = 20, color = 'black'), axis.text = element_text(size = 20), axis.text.x = element_text(angle = 45, hjust = 1))



new1 <- newdata[newdata$CHELSA_Annual_Mean_Temperature <=160 & newdata$CHELSA_Annual_Mean_Temperature>80,]
new1$tempcat <- '8 to 16'


new2 <- newdata[newdata$CHELSA_Annual_Mean_Temperature > 160, ]
new2$tempcat <- 'higher than 16'

new3 <- newdata[newdata$CHELSA_Annual_Mean_Temperature <= 80,]
new3$tempcat <- 'lower than 8'

newdata <- rbind(new1,rbind(new2, new3))




p11<-ggplot(newdata, aes(x = ariditycat, y = broad_deciduous, color = tempcat))+
  stat_summary(fun = median, fun.min = function(z){quantile(z, 0.45)}, fun.max = function(z){quantile(z, 0.55)}, size = 1)+
  #stat_summary(fun.data = 'mean_cl_boot', size = 1)+
  stat_summary(fun = median, geom = 'line', size = 1, aes(group = tempcat))+
  #geom_path()+
  scale_color_viridis_d()+
  coord_cartesian(ylim = c(0,100))+
  theme(axis.title = element_text(size = 20, color = 'black'), axis.text = element_text(size = 20), axis.text.x = element_text(angle = 45, hjust = 1))


new1 <- newdata[newdata$CHELSA_Annual_Mean_Temperature <= 80, ]
new1$tempcat <- 'lower than 8'

new2 <- newdata[newdata$CHELSA_Annual_Mean_Temperature > 80, ]
new2$tempcat <- 'higher than 8'


newdata <- rbind(new1, new2)





p12<- ggplot(newdata, aes(x = ariditycat, y = needle, color = tempcat))+
  stat_summary(fun = median, fun.min = function(z){quantile(z, 0.45)}, fun.max = function(z){quantile(z, 0.55)}, size = 1)+
  #stat_summary(fun.data = 'mean_cl_boot', size = 1)+
  stat_summary(fun = median, geom = 'line', size = 1, aes(group = tempcat))+
  #geom_path()+
  scale_color_viridis_d()+
  coord_cartesian(ylim = c(0,100))+
  theme(axis.title = element_text(size = 20, color = 'black'), axis.text = element_text(size = 20), axis.text.x = element_text(angle = 45, hjust = 1))


```


```{R}

new1 <- df.fft[df.fft$CHELSA_Annual_Mean_Temperature <= 180 & df.fft$CHELSA_Annual_Mean_Temperature > 80, ]
new1$tempcat <- '8-18'

new2 <- df.fft[df.fft$CHELSA_Annual_Mean_Temperature > 180, ]
new2$tempcat <- 'higher than 18'

new3 <- df.fft[df.fft$CHELSA_Annual_Mean_Temperature <= 80, ]
new3$tempcat <- 'lower than 8'


new1$dens <- col2rgb(densCols(new1$Aridity_Index, new1$broad_evergreen))[1,]+1L

newds1 <- new1[,c('Aridity_Index', 'tempcat', 'broad_evergreen', 'dens')]

newds1$Aridity_Index <- round(newds1$Aridity_Index,1)

newds1 <- newds1[newds1$dens<140,]

new2$dens <- col2rgb(densCols(new2$Aridity_Index, new2$broad_evergreen))[1,]+1L

newds2 <- new2[,c('Aridity_Index', 'tempcat', 'broad_evergreen', 'dens')]

newds2$Aridity_Index <- round(newds2$Aridity_Index,1)

newds2 <- newds2[newds2$dens <140, ]


new3$dens <- col2rgb(densCols(new3$Aridity_Index, new3$broad_evergreen))[1,]+1L

newds3 <- new3[,c('Aridity_Index', 'tempcat', 'broad_evergreen', 'dens')]

newds3$Aridity_Index <- round(newds3$Aridity_Index,1)

newds3 <- newds3[newds3$dens<140,]
library(dplyr)

newds1 <- newds1 %>%
  group_by(Aridity_Index)%>%
  slice(which.min(dens))

newds2 <- newds2 %>%
  group_by(Aridity_Index)%>%
  slice(which.min(dens))


newds3 <- newds3 %>%
  group_by(Aridity_Index)%>%
  slice(which.min(dens))


newdata <- rbind(newds1,rbind(newds2,newds3))


newds1
ggplot(data = newds1, aes(x = Aridity_Index, y = broad_evergreen))+
  geom_point()+
  geom_smooth(method = 'gam', se = FALSE)
  #geom_line()


ggplot(data = newds2, aes(x = Aridity_Index, y = broad_evergreen))+
  geom_point()+
  geom_smooth(method = 'gam',orientation ='x', se = FALSE)


ggplot(data = newds3, aes(x = Aridity_Index, y = broad_evergreen))+
  geom_point()+
  geom_smooth(method = 'gam', se = FALSE)
  #geom_line()


pwd10<-ggplot(newdata, aes(x = Aridity_Index, y = broad_evergreen, color = tempcat))+
  #geom_point(size = 4, alpha = 0.3)+
  geom_smooth(method = 'loess', size = 1.5, span = 0.55,fullrange = TRUE)+
  scale_color_viridis_d()+
  coord_cartesian(ylim = c(0,100))+
  labs(x = 'Aridity index', y = 'Coverage (%)')+
  theme_classic()+
  theme(axis.title = element_text(size = 20), axis.text = element_text(size = 20), axis.text.x = element_text(angle = 45, hjust = 1), legend.text = element_text(size = 20), legend.title = element_blank())




```


```{R}

new1 <- df.fft[df.fft$CHELSA_Annual_Mean_Temperature <= 180 & df.fft$CHELSA_Annual_Mean_Temperature > 80, ]
new1$tempcat <- '8-18'

new2 <- df.fft[df.fft$CHELSA_Annual_Mean_Temperature > 180, ]
new2$tempcat <- 'higher than 18'

new3 <- df.fft[df.fft$CHELSA_Annual_Mean_Temperature <= 80, ]
new3$tempcat <- 'lower than 8'


new1$dens <- col2rgb(densCols(new1$Aridity_Index, new1$broad_deciduous))[1,]+1L

newds1 <- new1[,c('Aridity_Index', 'tempcat', 'broad_deciduous', 'dens')]

newds1$Aridity_Index <- round(newds1$Aridity_Index,1)

newds1 <- newds1[newds1$dens<140,]

new2$dens <- col2rgb(densCols(new2$Aridity_Index, new2$broad_deciduous))[1,]+1L

newds2 <- new2[,c('Aridity_Index', 'tempcat', 'broad_deciduous', 'dens')]

newds2$Aridity_Index <- round(newds2$Aridity_Index,1)

newds2 <- newds2[newds2$dens <140, ]


new3$dens <- col2rgb(densCols(new3$Aridity_Index, new3$broad_deciduous))[1,]+1L

newds3 <- new3[,c('Aridity_Index', 'tempcat', 'broad_deciduous', 'dens')]

newds3$Aridity_Index <- round(newds3$Aridity_Index,1)

newds3 <- newds3[newds3$dens<140,]
library(dplyr)

newds1 <- newds1 %>%
  group_by(Aridity_Index)%>%
  slice(which.min(dens))

newds2 <- newds2 %>%
  group_by(Aridity_Index)%>%
  slice(which.min(dens))


newds3 <- newds3 %>%
  group_by(Aridity_Index)%>%
  slice(which.min(dens))


newdata <- rbind(newds1,rbind(newds2,newds3))


newds1
ggplot(data = newds1, aes(x = Aridity_Index, y = broad_deciduous))+
  geom_point()+
  geom_smooth(method = 'gam', se = FALSE)
  #geom_line()


ggplot(data = newds2, aes(x = Aridity_Index, y = broad_deciduous))+
  geom_point()+
  geom_smooth(method = 'gam',orientation ='x', se = FALSE)


ggplot(data = newds3, aes(x = Aridity_Index, y = broad_deciduous))+
  geom_point()+
  geom_smooth(method = 'gam', se = FALSE)
  #geom_line()


pwd11<-ggplot(newdata, aes(x = Aridity_Index, y = broad_deciduous, color = tempcat))+
  #geom_point(size = 4, alpha = 0.3)+
  geom_smooth(method = 'loess', size = 1.5, span = 0.55,fullrange = TRUE)+
  scale_color_viridis_d()+
  coord_cartesian(ylim = c(0,100))+
  labs(x = 'Aridity index', y = 'Coverage (%)')+
  theme_classic()+
  theme(axis.title = element_text(size = 20), axis.text = element_text(size = 20), axis.text.x = element_text(angle = 45, hjust = 1), legend.text = element_text(size = 20), legend.title = element_blank())




```




```{R}
new1 <- df.fft[df.fft$CHELSA_Annual_Mean_Temperature <= 180 & df.fft$CHELSA_Annual_Mean_Temperature > 80, ]
new1$tempcat <- '8-18'

new2 <- df.fft[df.fft$CHELSA_Annual_Mean_Temperature > 180, ]
new2$tempcat <- 'higher than 18'

new3 <- df.fft[df.fft$CHELSA_Annual_Mean_Temperature <= 80, ]
new3$tempcat <- 'lower than 8'


new1$dens <- col2rgb(densCols(new1$Aridity_Index, new1$needle))[1,]+1L

newds1 <- new1[,c('Aridity_Index', 'tempcat', 'needle', 'dens')]

newds1$Aridity_Index <- round(newds1$Aridity_Index,1)

newds1 <- newds1[newds1$dens<140,]

new2$dens <- col2rgb(densCols(new2$Aridity_Index, new2$needle))[1,]+1L

newds2 <- new2[,c('Aridity_Index', 'tempcat', 'needle', 'dens')]

newds2$Aridity_Index <- round(newds2$Aridity_Index,1)

newds2 <- newds2[newds2$dens <140, ]


new3$dens <- col2rgb(densCols(new3$Aridity_Index, new3$needle))[1,]+1L

newds3 <- new3[,c('Aridity_Index', 'tempcat', 'needle', 'dens')]

newds3$Aridity_Index <- round(newds3$Aridity_Index,1)

newds3 <- newds3[newds3$dens<140,]
library(dplyr)

newds1 <- newds1 %>%
  group_by(Aridity_Index)%>%
  slice(which.min(dens))

newds2 <- newds2 %>%
  group_by(Aridity_Index)%>%
  slice(which.min(dens))


newds3 <- newds3 %>%
  group_by(Aridity_Index)%>%
  slice(which.min(dens))


newdata <- rbind(newds1,rbind(newds2,newds3))


newds1
ggplot(data = newds1, aes(x = Aridity_Index, y = needle))+
  geom_point()+
  geom_smooth(method = 'gam', se = FALSE)
  #geom_line()


ggplot(data = newds2, aes(x = Aridity_Index, y = needle))+
  geom_point()+
  geom_smooth(method = 'gam',orientation ='x', se = FALSE)


ggplot(data = newds3, aes(x = Aridity_Index, y = needle))+
  geom_point()+
  geom_smooth(method = 'gam', se = FALSE)
  #geom_line()


pwd12<-ggplot(newdata, aes(x = Aridity_Index, y = needle, color = tempcat))+
  #geom_point(size = 4, alpha = 0.3)+
  geom_smooth(method = 'loess', size = 1.5, span = 0.55,fullrange = TRUE)+
  scale_color_viridis_d()+
  coord_cartesian(ylim = c(0,100))+
  labs(x = 'Aridity index', y = 'Coverage (%)')+
  theme_classic()+
  theme(axis.title = element_text(size = 20), axis.text = element_text(size = 20), axis.text.x = element_text(angle = 45, hjust = 1), legend.text = element_text(size = 20), legend.title = element_blank())



```





```{R}

ggplot(data = df.fft, aes(x = cnratio))+
  geom_histogram()


ggplot(data = df.fft, aes(x = soil_nitrogen))+
  geom_histogram()

ggplot(data = df.fft, aes(x = soil_moisture))+
  geom_histogram()

ggplot(data = df.fft, aes(x = SG_Soil_pH_H2O_0_100cm))+
  geom_histogram()

```



```{R}

nrow(df.fft[df.fft$cnratio<0,])

cnratio1 <- df.fft[df.fft$cnratio>= 0 & df.fft$cnratio < 10, ]
cnratio1$cnratiocat <- '<10'

cnratio2 <- df.fft[df.fft$cnratio>=10 & df.fft$cnratio<15, ]
cnratio2$cnratiocat <- '10~15'

cnratio3 <- df.fft[df.fft$cnratio>= 15 & df.fft$cnratio< 20, ]
cnratio3$cnratiocat <- '15~20'

cnratio4 <- df.fft[df.fft$cnratio >= 20, ]
cnratio4$cnratiocat <- '\u226520'

summary(cnratio4$CHELSA_Annual_Mean_Temperature)
nrow(cnratio4)


newdata <- rbind(cnratio1, rbind(cnratio2,rbind(cnratio3,cnratio4)))

newdata$cnratiocat <- factor(newdata$cnratiocat, levels = c('<10', '10~15', '15~20', '\u226520'))



new1 <- newdata[newdata$CHELSA_Annual_Mean_Temperature < 150 & newdata$CHELSA_Annual_Mean_Temperature >= 40, ]
new1$tempcat <- '4~15\u00B0C'

new2 <- newdata[newdata$CHELSA_Annual_Mean_Temperature >= 150, ]
new2$tempcat <- '\u226515\u00B0C'

new3 <- newdata[newdata$CHELSA_Annual_Mean_Temperature < 40, ]
new3$tempcat <- '<4\u00B0C'

newdata <- rbind(new1, rbind(new2,new3))


q13<-ggplot(newdata, aes(x = cnratiocat, y = broad_evergreen, color = tempcat))+
  stat_summary(fun = median, fun.min = function(z){quantile(z, 0.45)}, fun.max = function(z){quantile(z, 0.55)}, size = 1)+
  #stat_summary(fun.data = 'mean_cl_boot', size = 1)+
  stat_summary(fun = median, geom = 'line', size = 1, aes(group = tempcat))+
  #geom_path()+
  scale_color_viridis_d()+
  coord_cartesian(ylim = c(0,100))+
  theme_classic()+
  theme(axis.title = element_blank(), axis.text = element_text(size = 20), axis.text.x = element_text(angle = 45, hjust = 1), legend.text = element_text(size = 20), legend.title = element_blank())



new1 <- newdata[newdata$CHELSA_Annual_Mean_Temperature <150 & newdata$CHELSA_Annual_Mean_Temperature >=20,]
new1$tempcat <- '2~15\u00B0C'


new2 <- newdata[newdata$CHELSA_Annual_Mean_Temperature >= 150 & newdata$CHELSA_Annual_Mean_Temperature < 240, ]
new2$tempcat <- '\u226515\u00B0C'

new3 <- newdata[newdata$CHELSA_Annual_Mean_Temperature < 20,]
new3$tempcat <- '<2\u00B0C'

new4 <- newdata[newdata$CHELSA_Annual_Mean_Temperature >= 240,]
new4$tempcat <- '\u226515\u00B0C'
newdata <- rbind(new1,rbind(new2, rbind(new3,new4)))




q14<-ggplot(newdata, aes(x = cnratiocat, y = broad_deciduous, color = tempcat))+
  stat_summary(fun = median, fun.min = function(z){quantile(z, 0.45)}, fun.max = function(z){quantile(z, 0.55)}, size = 1)+
  #stat_summary(fun.data = 'mean_cl_boot', size = 1)+
  stat_summary(fun = median, geom = 'line', size = 1, aes(group = tempcat))+
  #geom_path()+
  scale_color_viridis_d()+
  coord_cartesian(ylim = c(0,100))+
  theme_classic()+
  theme(axis.title = element_blank(), axis.text = element_text(size = 20), axis.text.x = element_text(angle = 45, hjust = 1), legend.text = element_text(size = 20), legend.title = element_blank())


new1 <- newdata[newdata$CHELSA_Annual_Mean_Temperature < 60, ]
new1$tempcat <- '<6\u00B0C'

new2 <- newdata[newdata$CHELSA_Annual_Mean_Temperature >= 60, ]
new2$tempcat <- '\u22656\u00B0C'


newdata <- rbind(new1, new2)





q15<-ggplot(newdata, aes(x = cnratiocat, y = needle, color = tempcat))+
  stat_summary(fun = median, fun.min = function(z){quantile(z, 0.45)}, fun.max = function(z){quantile(z, 0.55)}, size = 1)+
  #stat_summary(fun.data = 'mean_cl_boot', size = 1)+
  stat_summary(fun = median, geom = 'line', size = 1, aes(group = tempcat))+
  #geom_path()+
  scale_color_viridis_d()+
  coord_cartesian(ylim = c(0,100))+
  theme_classic()+
  theme(axis.title = element_blank(), axis.text = element_text(size = 20), axis.text.x = element_text(angle = 45, hjust = 1), legend.text = element_text(size = 20), legend.title = element_blank())

```



```{R}

new1 <- df.fft[df.fft$CHELSA_Annual_Mean_Temperature < 150 & df.fft$CHELSA_Annual_Mean_Temperature >= 40, ]
new1$tempcat <- '4~15\u00B0C'

new2 <- df.fft[df.fft$CHELSA_Annual_Mean_Temperature >= 150, ]
new2$tempcat <- '\u226515\u00B0C'

new3 <- df.fft[df.fft$CHELSA_Annual_Mean_Temperature < 40, ]
new3$tempcat <- '<4\u00B0C'


new1$dens <- col2rgb(densCols(new1$cnratio, new1$broad_evergreen))[1,]+1L

newds1 <- new1[,c('cnratio', 'tempcat', 'broad_evergreen', 'dens')]

newds1$cnratio <- round(newds1$cnratio,1)

newds1 <- newds1[newds1$dens<140,]

new2$dens <- col2rgb(densCols(new2$cnratio, new2$broad_evergreen))[1,]+1L

newds2 <- new2[,c('cnratio', 'tempcat', 'broad_evergreen', 'dens')]

newds2$cnratio <- round(newds2$cnratio,1)

newds2 <- newds2[newds2$dens <140, ]


new3$dens <- col2rgb(densCols(new3$cnratio, new3$broad_evergreen))[1,]+1L

newds3 <- new3[,c('cnratio', 'tempcat', 'broad_evergreen', 'dens')]

newds3$cnratio <- round(newds3$cnratio,1)

newds3 <- newds3[newds3$dens<140,]
library(dplyr)

newds1 <- newds1 %>%
  group_by(cnratio)%>%
  slice(which.min(dens))

newds2 <- newds2 %>%
  group_by(cnratio)%>%
  slice(which.min(dens))


newds3 <- newds3 %>%
  group_by(cnratio)%>%
  slice(which.min(dens))


newdata <- rbind(newds1,rbind(newds2,newds3))


newds1
ggplot(data = newds1, aes(x = cnratio, y = broad_evergreen))+
  geom_point()+
  geom_smooth(method = 'gam', se = FALSE)+
  coord_cartesian(ylim = c(0,100))
  #geom_line()


ggplot(data = newds2, aes(x = cnratio, y = broad_evergreen))+
  geom_point()+
  geom_smooth(method = 'gam',orientation ='x', se = FALSE)+
  coord_cartesian(ylim = c(0,100))


ggplot(data = newds3, aes(x = cnratio, y = broad_evergreen))+
  geom_point()+
  geom_smooth(method = 'gam', se = FALSE)+
  coord_cartesian(ylim = c(0,100))
  #geom_line()


pwd13<-ggplot(newdata, aes(x = cnratio, y = broad_evergreen, color = tempcat))+
  #geom_point(size = 4, alpha = 0.3)+
  geom_smooth(method = 'loess', size = 1.5, span = 0.55,fullrange = TRUE)+
  scale_color_viridis_d()+
  coord_cartesian(ylim = c(0,100))+
  theme_classic()+
  theme(axis.title = element_blank(), axis.text = element_text(size = 20), axis.text.x = element_text(angle = 45, hjust = 1), legend.text = element_text(size = 20), legend.title = element_blank())





```







```{R}

new1 <- df.fft[df.fft$CHELSA_Annual_Mean_Temperature < 150 & df.fft$CHELSA_Annual_Mean_Temperature >= 40, ]
new1$tempcat <- '4~15\u00B0C'

new2 <- df.fft[df.fft$CHELSA_Annual_Mean_Temperature >= 150, ]
new2$tempcat <- '\u226515\u00B0C'

new3 <- df.fft[df.fft$CHELSA_Annual_Mean_Temperature < 40, ]
new3$tempcat <- '<4\u00B0C'


new1$dens <- col2rgb(densCols(new1$cnratio, new1$broad_deciduous))[1,]+1L

newds1 <- new1[,c('cnratio', 'tempcat', 'broad_deciduous', 'dens')]

newds1$cnratio <- round(newds1$cnratio,1)

newds1 <- newds1[newds1$dens<140,]

new2$dens <- col2rgb(densCols(new2$cnratio, new2$broad_deciduous))[1,]+1L

newds2 <- new2[,c('cnratio', 'tempcat', 'broad_deciduous', 'dens')]

newds2$cnratio <- round(newds2$cnratio,1)

newds2 <- newds2[newds2$dens <140, ]


new3$dens <- col2rgb(densCols(new3$cnratio, new3$broad_deciduous))[1,]+1L

newds3 <- new3[,c('cnratio', 'tempcat', 'broad_deciduous', 'dens')]

newds3$cnratio <- round(newds3$cnratio,1)

newds3 <- newds3[newds3$dens<140,]
library(dplyr)

newds1 <- newds1 %>%
  group_by(cnratio)%>%
  slice(which.min(dens))

newds2 <- newds2 %>%
  group_by(cnratio)%>%
  slice(which.min(dens))


newds3 <- newds3 %>%
  group_by(cnratio)%>%
  slice(which.min(dens))


newdata <- rbind(newds1,rbind(newds2,newds3))


newds1
ggplot(data = newds1, aes(x = cnratio, y = broad_deciduous))+
  geom_point()+
  geom_smooth(method = 'gam', se = FALSE)+
  coord_cartesian(ylim = c(0,100))
  #geom_line()


ggplot(data = newds2, aes(x = cnratio, y = broad_deciduous))+
  geom_point()+
  geom_smooth(method = 'gam',orientation ='x', se = FALSE)+
  coord_cartesian(ylim = c(0,100))


ggplot(data = newds3, aes(x = cnratio, y = broad_deciduous))+
  geom_point()+
  geom_smooth(method = 'gam', se = FALSE)+
  coord_cartesian(ylim = c(0,100))
  #geom_line()


pwd14<-ggplot(newdata, aes(x = cnratio, y = broad_deciduous, color = tempcat))+
  #geom_point(size = 4, alpha = 0.3)+
  geom_smooth(method = 'loess', size = 1.5, span = 0.55,fullrange = TRUE)+
  scale_color_viridis_d()+
  coord_cartesian(ylim = c(0,100))+
  theme_classic()+
  theme(axis.title = element_blank(), axis.text = element_text(size = 20), axis.text.x = element_text(angle = 45, hjust = 1), legend.text = element_text(size = 20), legend.title = element_blank())





```


```{R}

new1 <- df.fft[df.fft$CHELSA_Annual_Mean_Temperature < 150 & df.fft$CHELSA_Annual_Mean_Temperature >= 40, ]
new1$tempcat <- '4~15\u00B0C'

new2 <- df.fft[df.fft$CHELSA_Annual_Mean_Temperature >= 150, ]
new2$tempcat <- '\u226515\u00B0C'

new3 <- df.fft[df.fft$CHELSA_Annual_Mean_Temperature < 40, ]
new3$tempcat <- '<4\u00B0C'


new1$dens <- col2rgb(densCols(new1$cnratio, new1$needle))[1,]+1L

newds1 <- new1[,c('cnratio', 'tempcat', 'needle', 'dens')]

#newds1$cnratio <- round(newds1$cnratio)

newds1 <- newds1[newds1$dens<140,]

new2$dens <- col2rgb(densCols(new2$cnratio, new2$needle))[1,]+1L

newds2 <- new2[,c('cnratio', 'tempcat', 'needle', 'dens')]

#newds2$cnratio <- round(newds2$cnratio,1)

newds2 <- newds2[newds2$dens <140, ]


new3$dens <- col2rgb(densCols(new3$cnratio, new3$needle))[1,]+1L

newds3 <- new3[,c('cnratio', 'tempcat', 'needle', 'dens')]

#newds3$cnratio <- round(newds3$cnratio,1)

newds3 <- newds3[newds3$dens<140,]
library(dplyr)

newds1 <- newds1 %>%
  group_by(cnratio)%>%
  slice(which.min(dens))

newds2 <- newds2 %>%
  group_by(cnratio)%>%
  slice(which.min(dens))


newds3 <- newds3 %>%
  group_by(cnratio)%>%
  slice(which.min(dens))


newdata <- rbind(newds1,rbind(newds2,newds3))


newds1
ggplot(data = newds1, aes(x = cnratio, y = needle))+
  geom_point()+
  geom_smooth(method = 'gam', se = FALSE)+
  coord_cartesian(ylim = c(0,100))
  #geom_line()


ggplot(data = newds2, aes(x = cnratio, y = needle))+
  geom_point()+
  geom_smooth(method = 'gam',orientation ='x', se = FALSE)+
  coord_cartesian(ylim = c(0,100))


ggplot(data = newds3, aes(x = cnratio, y = needle))+
  geom_point()+
  geom_smooth(method = 'gam', se = FALSE)+
  coord_cartesian(ylim = c(0,100))
  #geom_line()


pwd15<-ggplot(newdata, aes(x = cnratio, y = needle, color = tempcat))+
  #geom_point(size = 4, alpha = 0.3)+
  geom_smooth(method = 'loess', size = 1.5, span = 0.55,fullrange = TRUE)+
  scale_color_viridis_d()+
  coord_cartesian(ylim = c(0,100))+
  theme_classic()+
  theme(axis.title = element_blank(), axis.text = element_text(size = 20), axis.text.x = element_text(angle = 45, hjust = 1), legend.text = element_text(size = 20), legend.title = element_blank())





```






```{R}
ggplot(df.fft, aes(x = CHELSA_Annual_Mean_Temperature, y = broad_deciduous))+
  geom_point(alpha = 0.01)+
  geom_smooth(method = 'gam')


```



```{R}

nrow(df.fft[df.fft$cnratio<0,])

cnratio1 <- df.fft[df.fft$cnratio>= 0 & df.fft$cnratio < 10, ]
cnratio1$cnratiocat <- '<10'

cnratio2 <- df.fft[df.fft$cnratio>=10 & df.fft$cnratio<15, ]
cnratio2$cnratiocat <- '10~15'

cnratio3 <- df.fft[df.fft$cnratio>= 15 & df.fft$cnratio< 20, ]
cnratio3$cnratiocat <- '15~20'

cnratio4 <- df.fft[df.fft$cnratio >= 20, ]
cnratio4$cnratiocat <- '\u226520'

summary(cnratio4$CHELSA_Annual_Mean_Temperature)
nrow(cnratio4)


newdata <- rbind(cnratio1, rbind(cnratio2,rbind(cnratio3,cnratio4)))

newdata$cnratiocat <- factor(newdata$cnratiocat, levels = c('<10', '10~15', '15~20', '\u226520'))



new1 <- newdata[newdata$CHELSA_Annual_Precipitation < 1000, ]
new1$prepcat <- '<1000mm'

new2 <- newdata[newdata$CHELSA_Annual_Precipitation >= 1000 & newdata$CHELSA_Annual_Precipitation <1800, ]
new2$prepcat <- '\u22651000mm'

new3 <- newdata[newdata$CHELSA_Annual_Precipitation >= 1800, ]
new3$prepcat <- '\u22651000mm'

newdata <- rbind(new1, rbind(new2,new3))


p13<-ggplot(newdata, aes(x = cnratiocat, y = broad_evergreen, color = prepcat))+
  stat_summary(fun = median, fun.min = function(z){quantile(z, 0.45)}, fun.max = function(z){quantile(z, 0.55)}, size = 1)+
  #stat_summary(fun.data = 'mean_cl_boot', size = 1)+
  stat_summary(fun = median, geom = 'line', size = 1, aes(group = prepcat))+
  #geom_path()+
  scale_color_viridis_d()+
  coord_cartesian(ylim = c(0,100))+
  theme_classic()+
  theme(axis.title = element_blank(), axis.text = element_text(size = 20), axis.text.x = element_text(angle = 45, hjust = 1), legend.text = element_text(size = 20), legend.title = element_blank())



new1 <- newdata[newdata$CHELSA_Annual_Precipitation < 400, ]
new1$prepcat <- '<1000mm'

new2 <- newdata[newdata$CHELSA_Annual_Precipitation >= 400 & newdata$CHELSA_Annual_Precipitation < 1000, ]
new2$prepcat <- '<1000mm'

new4 <- newdata[newdata$CHELSA_Annual_Precipitation >= 1000 & newdata$CHELSA_Annual_Precipitation < 1500, ]
new4$prepcat <- '1000~1500mm'

new3 <- newdata[newdata$CHELSA_Annual_Precipitation > 1500, ]
new3$prepcat <- '\u22651500mm'

newdata <- rbind(new1, rbind(new2,rbind(new3, new4)))





p14<-ggplot(newdata, aes(x = cnratiocat, y = broad_deciduous, color = prepcat))+
  stat_summary(fun = median, fun.min = function(z){quantile(z, 0.45)}, fun.max = function(z){quantile(z, 0.55)}, size = 1)+
  #stat_summary(fun.data = 'mean_cl_boot', size = 1)+
  stat_summary(fun = median, geom = 'line', size = 1, aes(group = prepcat))+
  #geom_path()+
  scale_color_viridis_d()+
  coord_cartesian(ylim = c(0,100))+
  theme_classic()+
  theme(axis.title = element_blank(), axis.text = element_text(size = 20), axis.text.x = element_text(angle = 45, hjust = 1), legend.text = element_text(size = 20), legend.title = element_blank())


#new1 <- newdata[newdata$CHELSA_Annual_Precipitation < 400, ]
#new1$prepcat <- '<400'

#new2 <- newdata[newdata$CHELSA_Annual_Precipitation > 800 & newdata$CHELSA_Annual_Precipitation <=1800, ]
#new2$prepcat <- 'less than 1800'

#new3 <- newdata[newdata$CHELSA_Annual_Precipitation >= 400, ]
#new3$prepcat <- '\u2265400'

#newdata <- rbind(new1,new3)

new1 <- newdata[newdata$CHELSA_Annual_Precipitation < 400, ]
new1$prepcat <- '<400mm'

new2 <- newdata[newdata$CHELSA_Annual_Precipitation >= 400 & newdata$CHELSA_Annual_Precipitation < 1000, ]
new2$prepcat <- '400~1000mm'

new4 <- newdata[newdata$CHELSA_Annual_Precipitation >= 1000 & newdata$CHELSA_Annual_Precipitation < 2000, ]
new4$prepcat <- '\u22651000mm'

new3 <- newdata[newdata$CHELSA_Annual_Precipitation > 2000, ]
new3$prepcat <- '\u22651000mm'

newdata <- rbind(new1, rbind(new2,rbind(new3, new4)))




p15<-ggplot(newdata, aes(x = cnratiocat, y = needle, color = prepcat))+
  stat_summary(fun = median, fun.min = function(z){quantile(z, 0.45)}, fun.max = function(z){quantile(z, 0.55)}, size = 1)+
  #stat_summary(fun.data = 'mean_cl_boot', size = 1)+
  stat_summary(fun = median, geom = 'line', size = 1, aes(group = prepcat))+
  #geom_path()+
  scale_color_viridis_d()+
  coord_cartesian(ylim = c(0,100))+
  theme_classic()+
  theme(axis.title = element_blank(), axis.text = element_text(size = 20), axis.text.x = element_text(angle = 45, hjust = 1), legend.text = element_text(size = 20), legend.title = element_blank())
  
  
  
```


```{R}
new1 <- df.fft[df.fft$CHELSA_Annual_Precipitation < 1000, ]
new1$prepcat <- '<1000mm'

new2 <- df.fft[df.fft$CHELSA_Annual_Precipitation >= 1000 & df.fft$CHELSA_Annual_Precipitation <1800, ]
new2$prepcat <- '\u22651000mm'

new3 <- df.fft[df.fft$CHELSA_Annual_Precipitation >= 1800, ]
new3$prepcat <- '\u22651000mm'

#newdata <- rbind(new1, rbind(new2,new3))


new1$dens <- col2rgb(densCols(new1$cnratio, new1$broad_evergreen))[1,]+1L

newds1 <- new1[,c('cnratio', 'prepcat', 'broad_evergreen', 'dens')]

#newds1$cnratio <- round(newds1$cnratio)

newds1 <- newds1[newds1$dens<140,]

new2$dens <- col2rgb(densCols(new2$cnratio, new2$broad_evergreen))[1,]+1L

newds2 <- new2[,c('cnratio', 'prepcat', 'broad_evergreen', 'dens')]

#newds2$cnratio <- round(newds2$cnratio,1)

newds2 <- newds2[newds2$dens <140, ]


new3$dens <- col2rgb(densCols(new3$cnratio, new3$broad_evergreen))[1,]+1L

newds3 <- new3[,c('cnratio', 'prepcat', 'broad_evergreen', 'dens')]

#newds3$cnratio <- round(newds3$cnratio,1)

newds3 <- newds3[newds3$dens<140,]
library(dplyr)

newds1 <- newds1 %>%
  group_by(cnratio)%>%
  slice(which.min(dens))

newds2 <- newds2 %>%
  group_by(cnratio)%>%
  slice(which.min(dens))


newds3 <- newds3 %>%
  group_by(cnratio)%>%
  slice(which.min(dens))


newdata <- rbind(newds1,rbind(newds2,newds3))


newds1
ggplot(data = newds1, aes(x = cnratio, y = broad_evergreen))+
  geom_point()+
  geom_smooth(method = 'gam', se = FALSE)+
  coord_cartesian(ylim = c(0,100))
  #geom_line()


ggplot(data = newds2, aes(x = cnratio, y = broad_evergreen))+
  geom_point()+
  geom_smooth(method = 'gam',orientation ='x', se = FALSE)+
  coord_cartesian(ylim = c(0,100))


ggplot(data = newds3, aes(x = cnratio, y = broad_evergreen))+
  geom_point()+
  geom_smooth(method = 'gam', se = FALSE)+
  coord_cartesian(ylim = c(0,100))
  #geom_line()


pwd16<-ggplot(newdata, aes(x = cnratio, y = broad_evergreen, color = prepcat))+
  #geom_point(size = 4, alpha = 0.3)+
  geom_smooth(method = 'loess', size = 1.5, span = 0.55,fullrange = TRUE)+
  scale_color_viridis_d()+
  coord_cartesian(ylim = c(0,100))+
  theme_classic()+
  theme(axis.title = element_blank(), axis.text = element_text(size = 20), axis.text.x = element_text(angle = 45, hjust = 1), legend.text = element_text(size = 20), legend.title = element_blank())



```


```{R}
new1 <- df.fft[df.fft$CHELSA_Annual_Precipitation < 1000, ]
new1$prepcat <- '<1000mm'

new2 <- df.fft[df.fft$CHELSA_Annual_Precipitation >= 1000 & df.fft$CHELSA_Annual_Precipitation <1800, ]
new2$prepcat <- '\u22651000mm'

new3 <- df.fft[df.fft$CHELSA_Annual_Precipitation >= 1800, ]
new3$prepcat <- '\u22651000mm'

#newdata <- rbind(new1, rbind(new2,new3))


new1$dens <- col2rgb(densCols(new1$cnratio, new1$broad_deciduous))[1,]+1L

newds1 <- new1[,c('cnratio', 'prepcat', 'broad_deciduous', 'dens')]

#newds1$cnratio <- round(newds1$cnratio)

newds1 <- newds1[newds1$dens<140,]

new2$dens <- col2rgb(densCols(new2$cnratio, new2$broad_deciduous))[1,]+1L

newds2 <- new2[,c('cnratio', 'prepcat', 'broad_deciduous', 'dens')]

#newds2$cnratio <- round(newds2$cnratio,1)

newds2 <- newds2[newds2$dens <140, ]


new3$dens <- col2rgb(densCols(new3$cnratio, new3$broad_deciduous))[1,]+1L

newds3 <- new3[,c('cnratio', 'prepcat', 'broad_deciduous', 'dens')]

#newds3$cnratio <- round(newds3$cnratio,1)

newds3 <- newds3[newds3$dens<140,]
library(dplyr)

newds1 <- newds1 %>%
  group_by(cnratio)%>%
  slice(which.min(dens))

newds2 <- newds2 %>%
  group_by(cnratio)%>%
  slice(which.min(dens))


newds3 <- newds3 %>%
  group_by(cnratio)%>%
  slice(which.min(dens))


newdata <- rbind(newds1,rbind(newds2,newds3))


newds1
ggplot(data = newds1, aes(x = cnratio, y = broad_deciduous))+
  geom_point()+
  geom_smooth(method = 'gam', se = FALSE)+
  coord_cartesian(ylim = c(0,100))
  #geom_line()


ggplot(data = newds2, aes(x = cnratio, y = broad_deciduous))+
  geom_point()+
  geom_smooth(method = 'gam',orientation ='x', se = FALSE)+
  coord_cartesian(ylim = c(0,100))


ggplot(data = newds3, aes(x = cnratio, y = broad_deciduous))+
  geom_point()+
  geom_smooth(method = 'gam', se = FALSE)+
  coord_cartesian(ylim = c(0,100))
  #geom_line()


pwd17<-ggplot(newdata, aes(x = cnratio, y = broad_deciduous, color = prepcat))+
  #geom_point(size = 4, alpha = 0.3)+
  geom_smooth(method = 'loess', size = 1.5, span = 0.55,fullrange = TRUE)+
  scale_color_viridis_d()+
  coord_cartesian(ylim = c(0,100))+
  theme_classic()+
  theme(axis.title = element_blank(), axis.text = element_text(size = 20), axis.text.x = element_text(angle = 45, hjust = 1), legend.text = element_text(size = 20), legend.title = element_blank())



```

```{R}
new1 <- df.fft[df.fft$CHELSA_Annual_Precipitation < 1000, ]
new1$prepcat <- '<1000mm'

new2 <- df.fft[df.fft$CHELSA_Annual_Precipitation >= 1000 & df.fft$CHELSA_Annual_Precipitation <1800, ]
new2$prepcat <- '\u22651000mm'

new3 <- df.fft[df.fft$CHELSA_Annual_Precipitation >= 1800, ]
new3$prepcat <- '\u22651000mm'

#newdata <- rbind(new1, rbind(new2,new3))


new1$dens <- col2rgb(densCols(new1$cnratio, new1$needle))[1,]+1L

newds1 <- new1[,c('cnratio', 'prepcat', 'needle', 'dens')]

#newds1$cnratio <- round(newds1$cnratio)

newds1 <- newds1[newds1$dens<140,]

new2$dens <- col2rgb(densCols(new2$cnratio, new2$needle))[1,]+1L

newds2 <- new2[,c('cnratio', 'prepcat', 'needle', 'dens')]

#newds2$cnratio <- round(newds2$cnratio,1)

newds2 <- newds2[newds2$dens <140, ]


new3$dens <- col2rgb(densCols(new3$cnratio, new3$needle))[1,]+1L

newds3 <- new3[,c('cnratio', 'prepcat', 'needle', 'dens')]

#newds3$cnratio <- round(newds3$cnratio,1)

newds3 <- newds3[newds3$dens<140,]
library(dplyr)

newds1 <- newds1 %>%
  group_by(cnratio)%>%
  slice(which.min(dens))

newds2 <- newds2 %>%
  group_by(cnratio)%>%
  slice(which.min(dens))


newds3 <- newds3 %>%
  group_by(cnratio)%>%
  slice(which.min(dens))


newdata <- rbind(newds1,rbind(newds2,newds3))


newds1
ggplot(data = newds1, aes(x = cnratio, y = needle))+
  geom_point()+
  geom_smooth(method = 'gam', se = FALSE)+
  coord_cartesian(ylim = c(0,100))
  #geom_line()


ggplot(data = newds2, aes(x = cnratio, y = needle))+
  geom_point()+
  geom_smooth(method = 'gam',orientation ='x', se = FALSE)+
  coord_cartesian(ylim = c(0,100))


ggplot(data = newds3, aes(x = cnratio, y = needle))+
  geom_point()+
  geom_smooth(method = 'gam', se = FALSE)+
  coord_cartesian(ylim = c(0,100))
  #geom_line()


pwd18<-ggplot(newdata, aes(x = cnratio, y = needle, color = prepcat))+
  #geom_point(size = 4, alpha = 0.3)+
  geom_smooth(method = 'loess', size = 1.5, span = 0.55,fullrange = TRUE)+
  scale_color_viridis_d()+
  coord_cartesian(ylim = c(0,100))+
  theme_classic()+
  theme(axis.title = element_blank(), axis.text = element_text(size = 20), axis.text.x = element_text(angle = 45, hjust = 1), legend.text = element_text(size = 20), legend.title = element_blank())



```


```{R}
ggarrange(pwd13, pwd14, pwd15,
          pwd16, pwd17, pwd18,
          ncol = 3,
          nrow = 2)




```






```{R}
ggplot(df.fft, aes(x = CHELSA_Annual_Precipitation, y = needle))+
  geom_point(alpha = 0.1)+
  geom_smooth(method = 'gam')

ggplot(df.fft, aes(x = cnratio, y = needle))+
  geom_point(alpha = 0.1)+
  geom_smooth(method = 'gam')

```




```{R}

ggplot(df.fft[df.fft$broad_deciduous ==100, ], aes(x = CHELSA_Annual_Precipitation))+
  geom_histogram()

ggplot(df.fft[df.fft$broad_deciduous ==100, ], aes(x = cnratio))+
  geom_histogram()


ggplot(df.fft[df.fft$broad_deciduous <= 20, ], aes(x = CHELSA_Annual_Precipitation))+
  geom_histogram()


ggplot(df.fft[df.fft$broad_deciduous ==100, ], aes(x = CHELSA_Annual_Precipitation, y = cnratio))+
  geom_point()


ggplot(df.fft[df.fft$broad_deciduous <=20, ], aes(x = CHELSA_Annual_Precipitation, y = cnratio))+
  geom_point()


ggplot(df.fft, aes(x = CHELSA_Annual_Precipitation, y = cnratio))+
  geom_point()


ggplot(df.fft, aes(x = CHELSA_Annual_Mean_Temperature, y = cnratio))+
  geom_point()


```









```{R}

ph1 <- df.fft[ df.fft$SG_Soil_pH_H2O_0_100cm < 50, ]
ph1$phcat <- '<5'

ph2 <- df.fft[df.fft$SG_Soil_pH_H2O_0_100cm>=50 & df.fft$SG_Soil_pH_H2O_0_100cm<60, ]
ph2$phcat <- '5~6'

ph3 <- df.fft[df.fft$SG_Soil_pH_H2O_0_100cm>= 60 & df.fft$SG_Soil_pH_H2O_0_100cm< 70, ]
ph3$phcat <- '6~7'

ph4 <- df.fft[df.fft$SG_Soil_pH_H2O_0_100cm >= 70, ]
ph4$phcat <- '\u22657'




newdata <- rbind(ph1, rbind(ph2,rbind(ph3,ph4)))

newdata$phcat <- factor(newdata$phcat, levels = c('<5', '5~6', '6~7', '\u22657'))



new1 <- newdata[newdata$CHELSA_Annual_Mean_Temperature < 150 & newdata$CHELSA_Annual_Mean_Temperature >= 40, ]
new1$tempcat <- '4~15\u00B0C'

new2 <- newdata[newdata$CHELSA_Annual_Mean_Temperature >= 150, ]
new2$tempcat <- '\u226515\u00B0C'

new3 <- newdata[newdata$CHELSA_Annual_Mean_Temperature < 40, ]
new3$tempcat <- '<4\u00B0C'

newdata <- rbind(new1, rbind(new2,new3))


p16<-ggplot(newdata, aes(x = phcat, y = broad_evergreen, color = tempcat))+
  stat_summary(fun = median, fun.min = function(z){quantile(z, 0.45)}, fun.max = function(z){quantile(z, 0.55)}, size = 1)+
  #stat_summary(fun.data = 'mean_cl_boot', size = 1)+
  stat_summary(fun = median, geom = 'line', size = 1, aes(group = tempcat))+
  #geom_path()+
  scale_color_viridis_d()+
  coord_cartesian(ylim = c(0,100))+
  theme_classic()+
  theme(axis.title = element_blank(), axis.text = element_text(size = 20), axis.text.x = element_text(angle = 45, hjust = 1), legend.text = element_text(size = 20), legend.title = element_blank())




new1 <- newdata[newdata$CHELSA_Annual_Mean_Temperature <150 & newdata$CHELSA_Annual_Mean_Temperature >= 40,]
new1$tempcat <- '4~15\u00B0C'


new2 <- newdata[newdata$CHELSA_Annual_Mean_Temperature >= 150, ]
new2$tempcat <- '\u226515\u00B0C'

new3 <- newdata[newdata$CHELSA_Annual_Mean_Temperature < 40,]
new3$tempcat <- '<4\u00B0C'

newdata <- rbind(new1,rbind(new2, new3))




p17<-ggplot(newdata, aes(x = phcat, y = broad_deciduous, color = tempcat))+
  stat_summary(fun = median, fun.min = function(z){quantile(z, 0.45)}, fun.max = function(z){quantile(z, 0.55)}, size = 1)+
  #stat_summary(fun.data = 'mean_cl_boot', size = 1)+
  stat_summary(fun = median, geom = 'line', size = 1, aes(group = tempcat))+
  #geom_path()+
  scale_color_viridis_d()+
  coord_cartesian(ylim = c(0,100))+
  theme_classic()+
  theme(axis.title = element_blank(), axis.text = element_text(size = 20), axis.text.x = element_text(angle = 45, hjust = 1), legend.text = element_text(size = 20), legend.title = element_blank())


#new1 <- newdata[newdata$CHELSA_Annual_Mean_Temperature < 60, ]
#new1$tempcat <- '6\u00B0C'

#new2 <- newdata[newdata$CHELSA_Annual_Mean_Temperature >= 60, ]
#new2$tempcat <- '\u22656\u00B0C'


#newdata <- rbind(new1, new2)


new1 <- newdata[newdata$CHELSA_Annual_Mean_Temperature <150 & newdata$CHELSA_Annual_Mean_Temperature >= 40,]
new1$tempcat <- '\u22654\u00B0C'


new2 <- newdata[newdata$CHELSA_Annual_Mean_Temperature >= 150, ]
new2$tempcat <- '\u22654\u00B0C'

new3 <- newdata[newdata$CHELSA_Annual_Mean_Temperature < 40,]
new3$tempcat <- '<4\u00B0C'

newdata <- rbind(new1,rbind(new2, new3))


p18<-ggplot(newdata, aes(x = phcat, y = needle, color = tempcat))+
  stat_summary(fun = median, fun.min = function(z){quantile(z, 0.45)}, fun.max = function(z){quantile(z, 0.55)}, size = 1)+
  #stat_summary(fun.data = 'mean_cl_boot', size = 1)+
  stat_summary(fun = median, geom = 'line', size = 1, aes(group = tempcat))+
  #geom_path()+
  scale_color_viridis_d()+
  coord_cartesian(ylim = c(0,100))+
  theme_classic()+
  theme(axis.title = element_blank(), axis.text = element_text(size = 20), axis.text.x = element_text(angle = 45, hjust = 1), legend.text = element_text(size = 20), legend.title = element_blank())

```


```{R}

new1 <- df.fft[df.fft$CHELSA_Annual_Mean_Temperature < 150 & df.fft$CHELSA_Annual_Mean_Temperature >= 40, ]
new1$tempcat <- '<15\u00B0C'

new2 <- df.fft[df.fft$CHELSA_Annual_Mean_Temperature >= 150, ]
new2$tempcat <- '\u226515\u00B0C'

new3 <- df.fft[df.fft$CHELSA_Annual_Mean_Temperature < 40, ]
new3$tempcat <- '<15\u00B0C'


new1$dens <- col2rgb(densCols(new1$SG_Soil_pH_H2O_0_100cm, new1$broad_evergreen))[1,]+1L

newds1 <- new1[,c('SG_Soil_pH_H2O_0_100cm', 'tempcat', 'broad_evergreen', 'dens')]

newds1$SG_Soil_pH_H2O_0_100cm <- round(newds1$SG_Soil_pH_H2O_0_100cm,1)

newds1 <- newds1[newds1$dens<140,]

new2$dens <- col2rgb(densCols(new2$SG_Soil_pH_H2O_0_100cm, new2$broad_evergreen))[1,]+1L

newds2 <- new2[,c('SG_Soil_pH_H2O_0_100cm', 'tempcat', 'broad_evergreen', 'dens')]

newds2$SG_Soil_pH_H2O_0_100cm <- round(newds2$SG_Soil_pH_H2O_0_100cm,1)

newds2 <- newds2[newds2$dens <140, ]


new3$dens <- col2rgb(densCols(new3$SG_Soil_pH_H2O_0_100cm, new3$broad_evergreen))[1,]+1L

newds3 <- new3[,c('SG_Soil_pH_H2O_0_100cm', 'tempcat', 'broad_evergreen', 'dens')]

newds3$SG_Soil_pH_H2O_0_100cm <- round(newds3$SG_Soil_pH_H2O_0_100cm,1)

newds3 <- newds3[newds3$dens<140,]
library(dplyr)

newds1 <- newds1 %>%
  group_by(SG_Soil_pH_H2O_0_100cm)%>%
  slice(which.min(dens))

newds2 <- newds2 %>%
  group_by(SG_Soil_pH_H2O_0_100cm)%>%
  slice(which.min(dens))


newds3 <- newds3 %>%
  group_by(SG_Soil_pH_H2O_0_100cm)%>%
  slice(which.min(dens))


newdata <- rbind(newds1,rbind(newds2,newds3))


newds1
ggplot(data = newds1, aes(x = SG_Soil_pH_H2O_0_100cm, y = broad_evergreen))+
  geom_point()+
  geom_smooth(method = 'gam', se = FALSE)
  #geom_line()


ggplot(data = newds2, aes(x = SG_Soil_pH_H2O_0_100cm, y = broad_evergreen))+
  geom_point()+
  geom_smooth(method = 'gam',orientation ='x', se = FALSE)


ggplot(data = newds3, aes(x = SG_Soil_pH_H2O_0_100cm, y = broad_evergreen))+
  geom_point()+
  geom_smooth(method = 'gam', se = FALSE)
  #geom_line()


pwd19<-ggplot(newdata, aes(x = SG_Soil_pH_H2O_0_100cm, y = broad_evergreen, color = tempcat))+
  #geom_point(size = 4, alpha = 0.3)+
  geom_smooth(method = 'loess', size = 1.5, span = 0.55,fullrange = TRUE)+
  scale_color_viridis_d()+
  coord_cartesian(ylim = c(0,100))+
  theme_classic()+
  theme(axis.title = element_blank(), axis.text = element_text(size = 20), axis.text.x = element_text(angle = 45, hjust = 1), legend.text = element_text(size = 20), legend.title = element_blank())




```


```{R}

new1 <- df.fft[df.fft$CHELSA_Annual_Mean_Temperature < 150 & df.fft$CHELSA_Annual_Mean_Temperature >= 40, ]
new1$tempcat <- '<15\u00B0C'

new2 <- df.fft[df.fft$CHELSA_Annual_Mean_Temperature >= 150, ]
new2$tempcat <- '\u226515\u00B0C'

new3 <- df.fft[df.fft$CHELSA_Annual_Mean_Temperature < 40, ]
new3$tempcat <- '<15\u00B0C'


new1$dens <- col2rgb(densCols(new1$SG_Soil_pH_H2O_0_100cm, new1$broad_deciduous))[1,]+1L

newds1 <- new1[,c('SG_Soil_pH_H2O_0_100cm', 'tempcat', 'broad_deciduous', 'dens')]

newds1$SG_Soil_pH_H2O_0_100cm <- round(newds1$SG_Soil_pH_H2O_0_100cm,1)

newds1 <- newds1[newds1$dens<140,]

new2$dens <- col2rgb(densCols(new2$SG_Soil_pH_H2O_0_100cm, new2$broad_deciduous))[1,]+1L

newds2 <- new2[,c('SG_Soil_pH_H2O_0_100cm', 'tempcat', 'broad_deciduous', 'dens')]

newds2$SG_Soil_pH_H2O_0_100cm <- round(newds2$SG_Soil_pH_H2O_0_100cm,1)

newds2 <- newds2[newds2$dens <140, ]


new3$dens <- col2rgb(densCols(new3$SG_Soil_pH_H2O_0_100cm, new3$broad_deciduous))[1,]+1L

newds3 <- new3[,c('SG_Soil_pH_H2O_0_100cm', 'tempcat', 'broad_deciduous', 'dens')]

newds3$SG_Soil_pH_H2O_0_100cm <- round(newds3$SG_Soil_pH_H2O_0_100cm,1)

newds3 <- newds3[newds3$dens<140,]
library(dplyr)

newds1 <- newds1 %>%
  group_by(SG_Soil_pH_H2O_0_100cm)%>%
  slice(which.min(dens))

newds2 <- newds2 %>%
  group_by(SG_Soil_pH_H2O_0_100cm)%>%
  slice(which.min(dens))


newds3 <- newds3 %>%
  group_by(SG_Soil_pH_H2O_0_100cm)%>%
  slice(which.min(dens))


newdata <- rbind(newds1,rbind(newds2,newds3))


newds1
ggplot(data = newds1, aes(x = SG_Soil_pH_H2O_0_100cm, y = broad_deciduous))+
  geom_point()+
  geom_smooth(method = 'gam', se = FALSE)
  #geom_line()


ggplot(data = newds2, aes(x = SG_Soil_pH_H2O_0_100cm, y = broad_deciduous))+
  geom_point()+
  geom_smooth(method = 'gam',orientation ='x', se = FALSE)


ggplot(data = newds3, aes(x = SG_Soil_pH_H2O_0_100cm, y = broad_deciduous))+
  geom_point()+
  geom_smooth(method = 'gam', se = FALSE)
  #geom_line()


pwd20<-ggplot(newdata, aes(x = SG_Soil_pH_H2O_0_100cm, y = broad_deciduous, color = tempcat))+
  #geom_point(size = 4, alpha = 0.3)+
  geom_smooth(method = 'loess', size = 1.5, span = 0.55,fullrange = TRUE)+
  scale_color_viridis_d()+
  coord_cartesian(ylim = c(0,100))+
  theme_classic()+
  theme(axis.title = element_blank(), axis.text = element_text(size = 20), axis.text.x = element_text(angle = 45, hjust = 1), legend.text = element_text(size = 20), legend.title = element_blank())




```



```{R}

new1 <- df.fft[df.fft$CHELSA_Annual_Mean_Temperature < 150 & df.fft$CHELSA_Annual_Mean_Temperature >= 40, ]
new1$tempcat <- '4-15\u00B0C'

new2 <- df.fft[df.fft$CHELSA_Annual_Mean_Temperature >= 150, ]
new2$tempcat <- '\u226515\u00B0C'

new3 <- df.fft[df.fft$CHELSA_Annual_Mean_Temperature < 40, ]
new3$tempcat <- '<15\u00B0C'


new1$dens <- col2rgb(densCols(new1$SG_Soil_pH_H2O_0_100cm, new1$needle))[1,]+1L

newds1 <- new1[,c('SG_Soil_pH_H2O_0_100cm', 'tempcat', 'needle', 'dens')]

newds1$SG_Soil_pH_H2O_0_100cm <- round(newds1$SG_Soil_pH_H2O_0_100cm,1)

newds1 <- newds1[newds1$dens<140,]

new2$dens <- col2rgb(densCols(new2$SG_Soil_pH_H2O_0_100cm, new2$needle))[1,]+1L

newds2 <- new2[,c('SG_Soil_pH_H2O_0_100cm', 'tempcat', 'needle', 'dens')]

newds2$SG_Soil_pH_H2O_0_100cm <- round(newds2$SG_Soil_pH_H2O_0_100cm,1)

newds2 <- newds2[newds2$dens <140, ]


new3$dens <- col2rgb(densCols(new3$SG_Soil_pH_H2O_0_100cm, new3$needle))[1,]+1L

newds3 <- new3[,c('SG_Soil_pH_H2O_0_100cm', 'tempcat', 'needle', 'dens')]

newds3$SG_Soil_pH_H2O_0_100cm <- round(newds3$SG_Soil_pH_H2O_0_100cm,1)

newds3 <- newds3[newds3$dens<140,]
library(dplyr)

newds1 <- newds1 %>%
  group_by(SG_Soil_pH_H2O_0_100cm)%>%
  slice(which.min(dens))

newds2 <- newds2 %>%
  group_by(SG_Soil_pH_H2O_0_100cm)%>%
  slice(which.min(dens))


newds3 <- newds3 %>%
  group_by(SG_Soil_pH_H2O_0_100cm)%>%
  slice(which.min(dens))


newdata <- rbind(newds1,rbind(newds2,newds3))


newds1
ggplot(data = newds1, aes(x = SG_Soil_pH_H2O_0_100cm, y = needle))+
  geom_point()+
  geom_smooth(method = 'gam', se = FALSE)
  #geom_line()


ggplot(data = newds2, aes(x = SG_Soil_pH_H2O_0_100cm, y = needle))+
  geom_point()+
  geom_smooth(method = 'gam',orientation ='x', se = FALSE)


ggplot(data = newds3, aes(x = SG_Soil_pH_H2O_0_100cm, y = needle))+
  geom_point()+
  geom_smooth(method = 'gam', se = FALSE)
  #geom_line()


pwd21<-ggplot(newdata, aes(x = SG_Soil_pH_H2O_0_100cm, y = needle, color = tempcat))+
  #geom_point(size = 4, alpha = 0.3)+
  geom_smooth(method = 'loess', size = 1.5, span = 0.55,fullrange = TRUE)+
  scale_color_viridis_d()+
  coord_cartesian(ylim = c(0,100))+
  theme_classic()+
  theme(axis.title = element_blank(), axis.text = element_text(size = 20), axis.text.x = element_text(angle = 45, hjust = 1), legend.text = element_text(size = 20), legend.title = element_blank())




```







```{R}
moist1 <- df.fft[ df.fft$soil_moisture < 600, ]
moist1$moistcat <- 'less than 60'

moist2 <- df.fft[df.fft$soil_moisture>=600 & df.fft$soil_moisture<800, ]
moist2$moistcat <- '60 to 80'

moist3 <- df.fft[df.fft$soil_moisture>= 800, ] 
moist3$moistcat <- 'higher than 80'


newdata <- rbind(moist1, rbind(moist2,moist3))

newdata$moistcat <- factor(newdata$moistcat, levels = c('less than 60', '60 to 80', 'higher than 80'))



new1 <- newdata[newdata$CHELSA_Annual_Mean_Temperature <= 150 & newdata$CHELSA_Annual_Mean_Temperature > 40, ]
new1$tempcat <- '4 to 15'

new2 <- newdata[newdata$CHELSA_Annual_Mean_Temperature > 150, ]
new2$tempcat <- 'higher than 15'

new3 <- newdata[newdata$CHELSA_Annual_Mean_Temperature <= 40, ]
new3$tempcat <- 'lower than 4'

newdata <- rbind(new1, rbind(new2,new3))


ggplot(newdata, aes(x = moistcat, y = broad_evergreen, color = tempcat))+
  stat_summary(fun = median, fun.min = function(z){quantile(z, 0.45)}, fun.max = function(z){quantile(z, 0.55)}, size = 1)+
  #stat_summary(fun.data = 'mean_cl_boot', size = 1)+
  stat_summary(fun = median, geom = 'line', size = 1, aes(group = tempcat))+
  #geom_path()+
  scale_color_viridis_d()+
  coord_cartesian(ylim = c(0,100))



new1 <- newdata[newdata$CHELSA_Annual_Mean_Temperature <=150 & newdata$CHELSA_Annual_Mean_Temperature > 40,]
new1$tempcat <- '4 to 15'


new2 <- newdata[newdata$CHELSA_Annual_Mean_Temperature > 150, ]
new2$tempcat <- 'higher than 15'

new3 <- newdata[newdata$CHELSA_Annual_Mean_Temperature <= 40,]
new3$tempcat <- 'lower than 4'

newdata <- rbind(new1,rbind(new2, new3))




ggplot(newdata, aes(x = moistcat, y = broad_deciduous, color = tempcat))+
  stat_summary(fun = median, fun.min = function(z){quantile(z, 0.45)}, fun.max = function(z){quantile(z, 0.55)}, size = 1)+
  #stat_summary(fun.data = 'mean_cl_boot', size = 1)+
  stat_summary(fun = median, geom = 'line', size = 1, aes(group = tempcat))+
  #geom_path()+
  scale_color_viridis_d()+
  coord_cartesian(ylim = c(0,100))


new1 <- newdata[newdata$CHELSA_Annual_Mean_Temperature <= 40, ]
new1$tempcat <- 'lower than 4'

new2 <- newdata[newdata$CHELSA_Annual_Mean_Temperature > 40, ]
new2$tempcat <- 'higher than 4'


newdata <- rbind(new1, new2)





ggplot(newdata, aes(x = moistcat, y = needle, color = tempcat))+
  stat_summary(fun = median, fun.min = function(z){quantile(z, 0.45)}, fun.max = function(z){quantile(z, 0.55)}, size = 1)+
  #stat_summary(fun.data = 'mean_cl_boot', size = 1)+
  stat_summary(fun = median, geom = 'line', size = 1, aes(group = tempcat))+
  #geom_path()+
  scale_color_viridis_d()+
  coord_cartesian(ylim = c(0,100))


```



```{R}
ggplot(df.fft, aes(x = soil_nitrogen))+
  geom_histogram()


```


```{R}
nitro1 <- df.fft[ df.fft$soil_nitrogen < 1200, ]
nitro1$ncat <- 'less than 1200'

nitro2 <- df.fft[df.fft$soil_nitrogen>=1200 & df.fft$soil_nitrogen<2400, ]
nitro2$ncat <- '1200 to 2400'

nitro3 <- df.fft[df.fft$soil_nitrogen>= 2400, ] 
nitro3$ncat <- 'higher than 2400'


newdata <- rbind(nitro1, rbind(nitro2,nitro3))

newdata$ncat <- factor(newdata$ncat, levels = c('less than 1200', '1200 to 2400', 'higher than 2400'))



new1 <- newdata[newdata$CHELSA_Annual_Mean_Temperature <= 160 & newdata$CHELSA_Annual_Mean_Temperature > 40, ]
new1$tempcat <- '4 to 16'

new2 <- newdata[newdata$CHELSA_Annual_Mean_Temperature > 160, ]
new2$tempcat <- 'higher than 16'

new3 <- newdata[newdata$CHELSA_Annual_Mean_Temperature <= 40, ]
new3$tempcat <- 'lower than 4'

newdata <- rbind(new1, rbind(new2,new3))


ggplot(newdata, aes(x = ncat, y = broad_evergreen, color = tempcat))+
  stat_summary(fun = median, fun.min = function(z){quantile(z, 0.45)}, fun.max = function(z){quantile(z, 0.55)}, size = 1)+
  #stat_summary(fun.data = 'mean_cl_boot', size = 1)+
  stat_summary(fun = median, geom = 'line', size = 1, aes(group = tempcat))+
  #geom_path()+
  scale_color_viridis_d()+
  coord_cartesian(ylim = c(0,100))



new1 <- newdata[newdata$CHELSA_Annual_Mean_Temperature <=160 & newdata$CHELSA_Annual_Mean_Temperature > 40,]
new1$tempcat <- '4 to 16'


new2 <- newdata[newdata$CHELSA_Annual_Mean_Temperature > 160, ]
new2$tempcat <- 'higher than 16'

new3 <- newdata[newdata$CHELSA_Annual_Mean_Temperature <= 40,]
new3$tempcat <- 'lower than 4'

newdata <- rbind(new1,rbind(new2, new3))




ggplot(newdata, aes(x = ncat, y = broad_deciduous, color = tempcat))+
  stat_summary(fun = median, fun.min = function(z){quantile(z, 0.45)}, fun.max = function(z){quantile(z, 0.55)}, size = 1)+
  #stat_summary(fun.data = 'mean_cl_boot', size = 1)+
  stat_summary(fun = median, geom = 'line', size = 1, aes(group = tempcat))+
  #geom_path()+
  scale_color_viridis_d()+
  coord_cartesian(ylim = c(0,100))


new1 <- newdata[newdata$CHELSA_Annual_Mean_Temperature <= 40, ]
new1$tempcat <- 'lower than 4'

new2 <- newdata[newdata$CHELSA_Annual_Mean_Temperature > 40, ]
new2$tempcat <- 'higher than 4'


newdata <- rbind(new1, new2)





ggplot(newdata, aes(x = ncat, y = needle, color = tempcat))+
  stat_summary(fun = median, fun.min = function(z){quantile(z, 0.45)}, fun.max = function(z){quantile(z, 0.55)}, size = 1)+
  #stat_summary(fun.data = 'mean_cl_boot', size = 1)+
  stat_summary(fun = median, geom = 'line', size = 1, aes(group = tempcat))+
  #geom_path()+
  scale_color_viridis_d()+
  coord_cartesian(ylim = c(0,100))


```


```{R}
nitro1 <- df.fft[ df.fft$soil_nitrogen < 1200, ]
nitro1$ncat <- 'less than 1200'

nitro2 <- df.fft[df.fft$soil_nitrogen>=1200 & df.fft$soil_nitrogen<2400, ]
nitro2$ncat <- '1200 to 2400'

nitro3 <- df.fft[df.fft$soil_nitrogen>= 2400, ] 
nitro3$ncat <- 'higher than 2400'


newdata <- rbind(nitro1, rbind(nitro2,nitro3))

newdata$ncat <- factor(newdata$ncat, levels = c('less than 1200', '1200 to 2400', 'higher than 2400'))



new1 <- newdata[newdata$CHELSA_Annual_Precipitation <= 1600 & newdata$CHELSA_Annual_Precipitation > 400, ]
new1$prepcat <- '400 to 1600'

new2 <- newdata[newdata$CHELSA_Annual_Precipitation > 1600, ]
new2$prepcat <- 'higher than 1600'

new3 <- newdata[newdata$CHELSA_Annual_Precipitation <= 400, ]
new3$prepcat <- 'lower than 400'

newdata <- rbind(new1, rbind(new2,new3))


ggplot(newdata, aes(x = ncat, y = broad_evergreen, color = prepcat))+
  stat_summary(fun = median, fun.min = function(z){quantile(z, 0.45)}, fun.max = function(z){quantile(z, 0.55)}, size = 1)+
  #stat_summary(fun.data = 'mean_cl_boot', size = 1)+
  stat_summary(fun = median, geom = 'line', size = 1, aes(group = prepcat))+
  #geom_path()+
  scale_color_viridis_d()+
  coord_cartesian(ylim = c(0,100))



new1 <- newdata[newdata$CHELSA_Annual_Precipitation <=1600 & newdata$CHELSA_Annual_Precipitation > 400,]
new1$prepcat <- '400 to 1600'


new2 <- newdata[newdata$CHELSA_Annual_Precipitation > 1600, ]
new2$prepcat <- 'higher than 1600'

new3 <- newdata[newdata$CHELSA_Annual_Precipitation <= 400,]
new3$prepcat <- 'lower than 400'

newdata <- rbind(new1,rbind(new2, new3))




ggplot(newdata, aes(x = ncat, y = broad_deciduous, color = prepcat))+
  stat_summary(fun = median, fun.min = function(z){quantile(z, 0.45)}, fun.max = function(z){quantile(z, 0.55)}, size = 1)+
  #stat_summary(fun.data = 'mean_cl_boot', size = 1)+
  stat_summary(fun = median, geom = 'line', size = 1, aes(group = prepcat))+
  #geom_path()+
  scale_color_viridis_d()+
  coord_cartesian(ylim = c(0,100))


new1 <- newdata[newdata$CHELSA_Annual_Precipitation <= 400, ]
new1$prepcat <- 'lower than 400'

new2 <- newdata[newdata$CHELSA_Annual_Precipitation > 400, ]
new2$prepcat <- 'higher than 400'


newdata <- rbind(new1, new2)





ggplot(newdata, aes(x = ncat, y = needle, color = prepcat))+
  stat_summary(fun = median, fun.min = function(z){quantile(z, 0.45)}, fun.max = function(z){quantile(z, 0.55)}, size = 1)+
  #stat_summary(fun.data = 'mean_cl_boot', size = 1)+
  stat_summary(fun = median, geom = 'line', size = 1, aes(group = prepcat))+
  #geom_path()+
  scale_color_viridis_d()+
  coord_cartesian(ylim = c(0,100))


```



```{R}
ggplot(df.fft, aes(x = SG_Sand_Content_0_100cm))+
  geom_histogram()



```


```{R}
sand1 <- df.fft[ df.fft$SG_Sand_Content_0_100cm < 25, ]
sand1$sandcat <- 'less than 25'

sand2 <- df.fft[df.fft$SG_Sand_Content_0_100cm>=25 & df.fft$SG_Sand_Content_0_100cm<50, ]
sand2$sandcat <- '25 to 50'

sand3 <- df.fft[df.fft$SG_Sand_Content_0_100cm>= 50 & df.fft$SG_Sand_Content_0_100cm<75, ] 
sand3$sandcat <- '50 to 75'

sand4 <- df.fft[ df.fft$SG_Sand_Content_0_100cm >= 75, ]
sand4$sandcat <- 'higher than 75'



newdata <- rbind(sand1, rbind(sand2,rbind(sand3,sand4)))

newdata$sandcat <- factor(newdata$sandcat, levels = c('less than 25', '25 to 50', '50 to 75', 'higher than 75'))



new1 <- newdata[newdata$CHELSA_Annual_Precipitation <= 800 & newdata$CHELSA_Annual_Precipitation > 400, ]
new1$prepcat <- 'less than 800'

new2 <- newdata[newdata$CHELSA_Annual_Precipitation > 800, ]
new2$prepcat <- 'higher than 800'

new3 <- newdata[newdata$CHELSA_Annual_Precipitation <= 400, ]
new3$prepcat <- 'less than 800'

newdata <- rbind(new1, rbind(new2,new3))


ggplot(newdata, aes(x = sandcat, y = broad_evergreen, color = prepcat))+
  stat_summary(fun = median, fun.min = function(z){quantile(z, 0.45)}, fun.max = function(z){quantile(z, 0.55)}, size = 1)+
  #stat_summary(fun.data = 'mean_cl_boot', size = 1)+
  stat_summary(fun = median, geom = 'line', size = 1, aes(group = prepcat))+
  #geom_path()+
  scale_color_viridis_d()+
  coord_cartesian(ylim = c(0,100))+
  theme(axis.title = element_text(size = 20, color = 'black'), axis.text = element_text(size = 20), axis.text.x = element_text(angle = 45, hjust = 1))



new1 <- newdata[newdata$CHELSA_Annual_Precipitation <=800 & newdata$CHELSA_Annual_Precipitation > 400,]
new1$prepcat <- 'less than 800'


new2 <- newdata[newdata$CHELSA_Annual_Precipitation > 800, ]
new2$prepcat <- 'higher than 800'

new3 <- newdata[newdata$CHELSA_Annual_Precipitation <= 400,]
new3$prepcat <- 'less than 800'

newdata <- rbind(new1,rbind(new2, new3))




ggplot(newdata, aes(x = sandcat, y = broad_deciduous, color = prepcat))+
  stat_summary(fun = median, fun.min = function(z){quantile(z, 0.45)}, fun.max = function(z){quantile(z, 0.55)}, size = 1)+
  #stat_summary(fun.data = 'mean_cl_boot', size = 1)+
  stat_summary(fun = median, geom = 'line', size = 1, aes(group = prepcat))+
  #geom_path()+
  scale_color_viridis_d()+
  coord_cartesian(ylim = c(0,100))+
  theme(axis.title = element_text(size = 20, color = 'black'), axis.text = element_text(size = 20), axis.text.x = element_text(angle = 45, hjust = 1))



new1 <- newdata[newdata$CHELSA_Annual_Precipitation <= 1200, ]
new1$prepcat <- 'less than 1200'

new2 <- newdata[newdata$CHELSA_Annual_Precipitation > 1200, ]
new2$prepcat <- 'higher than 1200'


newdata <- rbind(new1, new2)





ggplot(newdata, aes(x = sandcat, y = needle, color = prepcat))+
  stat_summary(fun = median, fun.min = function(z){quantile(z, 0.45)}, fun.max = function(z){quantile(z, 0.55)}, size = 1)+
  #stat_summary(fun.data = 'mean_cl_boot', size = 1)+
  stat_summary(fun = median, geom = 'line', size = 1, aes(group = prepcat))+
  #geom_path()+
  scale_color_viridis_d()+
  coord_cartesian(ylim = c(0,100))+
  theme(axis.title = element_text(size = 20, color = 'black'), axis.text = element_text(size = 20), axis.text.x = element_text(angle = 45, hjust = 1))





```

```{R}
sand1 <- df.fft[ df.fft$SG_Sand_Content_0_100cm < 25, ]
sand1$sandcat <- 'less than 25'

sand2 <- df.fft[df.fft$SG_Sand_Content_0_100cm>=25 & df.fft$SG_Sand_Content_0_100cm<50, ]
sand2$sandcat <- '25 to 50'

sand3 <- df.fft[df.fft$SG_Sand_Content_0_100cm>= 50 & df.fft$SG_Sand_Content_0_100cm<75, ] 
sand3$sandcat <- '50 to 75'

sand4 <- df.fft[ df.fft$SG_Sand_Content_0_100cm >= 75, ]
sand4$sandcat <- 'higher than 75'



newdata <- rbind(sand1, rbind(sand2,rbind(sand3,sand4)))

newdata$sandcat <- factor(newdata$sandcat, levels = c('less than 25', '25 to 50', '50 to 75', 'higher than 75'))



new1 <- newdata[newdata$CHELSA_Annual_Mean_Temperature <= 160 & newdata$CHELSA_Annual_Mean_Temperature > 40, ]
new1$prepcat <- 'lower than 16'

new2 <- newdata[newdata$CHELSA_Annual_Mean_Temperature > 160, ]
new2$prepcat <- 'higher than 16'

new3 <- newdata[newdata$CHELSA_Annual_Mean_Temperature <= 40, ]
new3$prepcat <- 'lower than 16'

newdata <- rbind(new1, rbind(new2,new3))


p19<-ggplot(newdata, aes(x = sandcat, y = broad_evergreen, color = prepcat))+
  stat_summary(fun = median, fun.min = function(z){quantile(z, 0.45)}, fun.max = function(z){quantile(z, 0.55)}, size = 1)+
  #stat_summary(fun.data = 'mean_cl_boot', size = 1)+
  stat_summary(fun = median, geom = 'line', size = 1, aes(group = prepcat))+
  #geom_path()+
  scale_color_viridis_d()+
  coord_cartesian(ylim = c(0,100))+
  theme(axis.title = element_text(size = 20, color = 'black'), axis.text = element_text(size = 20), axis.text.x = element_text(angle = 45, hjust = 1))



new1 <- newdata[newdata$CHELSA_Annual_Mean_Temperature <= 160 & newdata$CHELSA_Annual_Mean_Temperature > 60, ]
new1$prepcat <- '6 to 16'

new2 <- newdata[newdata$CHELSA_Annual_Mean_Temperature > 160, ]
new2$prepcat <- 'higher than 16'

new3 <- newdata[newdata$CHELSA_Annual_Mean_Temperature <= 60, ]
new3$prepcat <- 'lower than 6'

newdata <- rbind(new1, rbind(new2,new3))



p20<-ggplot(newdata, aes(x = sandcat, y = broad_deciduous, color = prepcat))+
  stat_summary(fun = median, fun.min = function(z){quantile(z, 0.45)}, fun.max = function(z){quantile(z, 0.55)}, size = 1)+
  #stat_summary(fun.data = 'mean_cl_boot', size = 1)+
  stat_summary(fun = median, geom = 'line', size = 1, aes(group = prepcat))+
  #geom_path()+
  scale_color_viridis_d()+
  coord_cartesian(ylim = c(0,100))+
  theme(axis.title = element_text(size = 20, color = 'black'), axis.text = element_text(size = 20), axis.text.x = element_text(angle = 45, hjust = 1))


new1 <- newdata[newdata$CHELSA_Annual_Mean_Temperature <= 160 & newdata$CHELSA_Annual_Mean_Temperature > 40, ]
new1$prepcat <- 'lower than 16'

new2 <- newdata[newdata$CHELSA_Annual_Mean_Temperature > 160, ]
new2$prepcat <- 'higher than 16'

new3 <- newdata[newdata$CHELSA_Annual_Mean_Temperature <= 40, ]
new3$prepcat <- 'lower than 16'

newdata <- rbind(new1, rbind(new2,new3))



p21<-ggplot(newdata, aes(x = sandcat, y = needle, color = prepcat))+
  stat_summary(fun = median, fun.min = function(z){quantile(z, 0.45)}, fun.max = function(z){quantile(z, 0.55)}, size = 1)+
  #stat_summary(fun.data = 'mean_cl_boot', size = 1)+
  stat_summary(fun = median, geom = 'line', size = 1, aes(group = prepcat))+
  #geom_path()+
  scale_color_viridis_d()+
  coord_cartesian(ylim = c(0,100))+
  theme(axis.title = element_text(size = 20, color = 'black'), axis.text = element_text(size = 20), axis.text.x = element_text(angle = 45, hjust = 1))




```


```{R}
new1 <- df.fft[df.fft$CHELSA_Annual_Mean_Temperature <= 160 & df.fft$CHELSA_Annual_Mean_Temperature > 40, ]
new1$tempcat <- 'lower than 16'

new2 <- df.fft[df.fft$CHELSA_Annual_Mean_Temperature > 160, ]
new2$tempcat <- 'higher than 16'

new3 <- df.fft[df.fft$CHELSA_Annual_Mean_Temperature <= 40, ]
new3$tempcat <- 'lower than 16'



new1$dens <- col2rgb(densCols(new1$SG_Sand_Content_0_100cm, new1$broad_evergreen))[1,]+1L

newds1 <- new1[,c('SG_Sand_Content_0_100cm', 'tempcat', 'broad_evergreen', 'dens')]

newds1$SG_Sand_Content_0_100cm <- round(newds1$SG_Sand_Content_0_100cm,1)

newds1 <- newds1[newds1$dens<140,]

new2$dens <- col2rgb(densCols(new2$SG_Sand_Content_0_100cm, new2$broad_evergreen))[1,]+1L

newds2 <- new2[,c('SG_Sand_Content_0_100cm', 'tempcat', 'broad_evergreen', 'dens')]

newds2$SG_Sand_Content_0_100cm <- round(newds2$SG_Sand_Content_0_100cm,1)

newds2 <- newds2[newds2$dens <140, ]


new3$dens <- col2rgb(densCols(new3$SG_Sand_Content_0_100cm, new3$broad_evergreen))[1,]+1L

newds3 <- new3[,c('SG_Sand_Content_0_100cm', 'tempcat', 'broad_evergreen', 'dens')]

newds3$SG_Sand_Content_0_100cm <- round(newds3$SG_Sand_Content_0_100cm,1)

newds3 <- newds3[newds3$dens<140,]
library(dplyr)

newds1 <- newds1 %>%
  group_by(SG_Sand_Content_0_100cm)%>%
  slice(which.min(dens))

newds2 <- newds2 %>%
  group_by(SG_Sand_Content_0_100cm)%>%
  slice(which.min(dens))


newds3 <- newds3 %>%
  group_by(SG_Sand_Content_0_100cm)%>%
  slice(which.min(dens))


newdata <- rbind(newds1,rbind(newds2,newds3))


newds1
ggplot(data = newds1, aes(x = SG_Sand_Content_0_100cm, y = broad_evergreen))+
  geom_point()+
  geom_smooth(method = 'gam', se = FALSE)
  #geom_line()


ggplot(data = newds2, aes(x = SG_Sand_Content_0_100cm, y = broad_evergreen))+
  geom_point()+
  geom_smooth(method = 'gam',orientation ='x', se = FALSE)


ggplot(data = newds3, aes(x = SG_Sand_Content_0_100cm, y = broad_evergreen))+
  geom_point()+
  geom_smooth(method = 'gam', se = FALSE)
  #geom_line()


pwd22<-ggplot(newdata, aes(x = SG_Sand_Content_0_100cm, y = broad_evergreen, color = tempcat))+
  #geom_point(size = 4, alpha = 0.3)+
  geom_smooth(method = 'loess', size = 1.5, span = 0.55,fullrange = TRUE)+
  scale_color_viridis_d()+
  coord_cartesian(ylim = c(0,100))+
  theme_classic()+
  theme(axis.title = element_blank(), axis.text = element_text(size = 20), axis.text.x = element_text(angle = 45, hjust = 1), legend.text = element_text(size = 20), legend.title = element_blank())



```




```{R}
new1 <- df.fft[df.fft$CHELSA_Annual_Mean_Temperature <= 160 & df.fft$CHELSA_Annual_Mean_Temperature > 40, ]
new1$tempcat <- '4-16\u00B0C'

new2 <- df.fft[df.fft$CHELSA_Annual_Mean_Temperature > 160, ]
new2$tempcat <- 'higher than 16'

new3 <- df.fft[df.fft$CHELSA_Annual_Mean_Temperature <= 40, ]
new3$tempcat <- 'lower than 4'



new1$dens <- col2rgb(densCols(new1$SG_Sand_Content_0_100cm, new1$broad_deciduous))[1,]+1L

newds1 <- new1[,c('SG_Sand_Content_0_100cm', 'tempcat', 'broad_deciduous', 'dens')]

newds1$SG_Sand_Content_0_100cm <- round(newds1$SG_Sand_Content_0_100cm,1)

newds1 <- newds1[newds1$dens<140,]

new2$dens <- col2rgb(densCols(new2$SG_Sand_Content_0_100cm, new2$broad_deciduous))[1,]+1L

newds2 <- new2[,c('SG_Sand_Content_0_100cm', 'tempcat', 'broad_deciduous', 'dens')]

newds2$SG_Sand_Content_0_100cm <- round(newds2$SG_Sand_Content_0_100cm,1)

newds2 <- newds2[newds2$dens <140, ]


new3$dens <- col2rgb(densCols(new3$SG_Sand_Content_0_100cm, new3$broad_deciduous))[1,]+1L

newds3 <- new3[,c('SG_Sand_Content_0_100cm', 'tempcat', 'broad_deciduous', 'dens')]

newds3$SG_Sand_Content_0_100cm <- round(newds3$SG_Sand_Content_0_100cm,1)

newds3 <- newds3[newds3$dens<140,]
library(dplyr)

newds1 <- newds1 %>%
  group_by(SG_Sand_Content_0_100cm)%>%
  slice(which.min(dens))

newds2 <- newds2 %>%
  group_by(SG_Sand_Content_0_100cm)%>%
  slice(which.min(dens))


newds3 <- newds3 %>%
  group_by(SG_Sand_Content_0_100cm)%>%
  slice(which.min(dens))


newdata <- rbind(newds1,rbind(newds2,newds3))


newds1
ggplot(data = newds1, aes(x = SG_Sand_Content_0_100cm, y = broad_deciduous))+
  geom_point()+
  geom_smooth(method = 'gam', se = FALSE)
  #geom_line()


ggplot(data = newds2, aes(x = SG_Sand_Content_0_100cm, y = broad_deciduous))+
  geom_point()+
  geom_smooth(method = 'gam',orientation ='x', se = FALSE)


ggplot(data = newds3, aes(x = SG_Sand_Content_0_100cm, y = broad_deciduous))+
  geom_point()+
  geom_smooth(method = 'gam', se = FALSE)
  #geom_line()


pwd23<-ggplot(newdata, aes(x = SG_Sand_Content_0_100cm, y = broad_deciduous, color = tempcat))+
  #geom_point(size = 4, alpha = 0.3)+
  geom_smooth(method = 'loess', size = 1.5, span = 0.55,fullrange = TRUE)+
  scale_color_viridis_d()+
  coord_cartesian(ylim = c(0,100))+
  theme_classic()+
  theme(axis.title = element_blank(), axis.text = element_text(size = 20), axis.text.x = element_text(angle = 45, hjust = 1), legend.text = element_text(size = 20), legend.title = element_blank())



```



```{R}
new1 <- df.fft[df.fft$CHELSA_Annual_Mean_Temperature <= 160 & df.fft$CHELSA_Annual_Mean_Temperature > 40, ]
new1$tempcat <- '4-16\u00B0C'

new2 <- df.fft[df.fft$CHELSA_Annual_Mean_Temperature > 160, ]
new2$tempcat <- 'higher than 16'

new3 <- df.fft[df.fft$CHELSA_Annual_Mean_Temperature <= 40, ]
new3$tempcat <- 'lower than 4'



new1$dens <- col2rgb(densCols(new1$SG_Sand_Content_0_100cm, new1$needle))[1,]+1L

newds1 <- new1[,c('SG_Sand_Content_0_100cm', 'tempcat', 'needle', 'dens')]

newds1$SG_Sand_Content_0_100cm <- round(newds1$SG_Sand_Content_0_100cm,1)

newds1 <- newds1[newds1$dens<140,]

new2$dens <- col2rgb(densCols(new2$SG_Sand_Content_0_100cm, new2$needle))[1,]+1L

newds2 <- new2[,c('SG_Sand_Content_0_100cm', 'tempcat', 'needle', 'dens')]

newds2$SG_Sand_Content_0_100cm <- round(newds2$SG_Sand_Content_0_100cm,1)

newds2 <- newds2[newds2$dens <140, ]


new3$dens <- col2rgb(densCols(new3$SG_Sand_Content_0_100cm, new3$needle))[1,]+1L

newds3 <- new3[,c('SG_Sand_Content_0_100cm', 'tempcat', 'needle', 'dens')]

newds3$SG_Sand_Content_0_100cm <- round(newds3$SG_Sand_Content_0_100cm,1)

newds3 <- newds3[newds3$dens<140,]
library(dplyr)

newds1 <- newds1 %>%
  group_by(SG_Sand_Content_0_100cm)%>%
  slice(which.min(dens))

newds2 <- newds2 %>%
  group_by(SG_Sand_Content_0_100cm)%>%
  slice(which.min(dens))


newds3 <- newds3 %>%
  group_by(SG_Sand_Content_0_100cm)%>%
  slice(which.min(dens))


newdata <- rbind(newds1,rbind(newds2,newds3))


newds1
ggplot(data = newds1, aes(x = SG_Sand_Content_0_100cm, y = needle))+
  geom_point()+
  geom_smooth(method = 'gam', se = FALSE)
  #geom_line()


ggplot(data = newds2, aes(x = SG_Sand_Content_0_100cm, y = needle))+
  geom_point()+
  geom_smooth(method = 'gam',orientation ='x', se = FALSE)


ggplot(data = newds3, aes(x = SG_Sand_Content_0_100cm, y = needle))+
  geom_point()+
  geom_smooth(method = 'gam', se = FALSE)
  #geom_line()


pwd24<-ggplot(newdata, aes(x = SG_Sand_Content_0_100cm, y = needle, color = tempcat))+
  #geom_point(size = 4, alpha = 0.3)+
  geom_smooth(method = 'loess', size = 1.5, span = 0.55,fullrange = TRUE)+
  scale_color_viridis_d()+
  coord_cartesian(ylim = c(0,100))+
  theme_classic()+
  theme(axis.title = element_blank(), axis.text = element_text(size = 20), axis.text.x = element_text(angle = 45, hjust = 1), legend.text = element_text(size = 20), legend.title = element_blank())



```








```{R}

library(ggpubr)


ggarrange(pwd4, pwd5, pwd6,
          pwd7, pwd8, pwd9,
          
          ncol = 3, 
          nrow = 2)



ggarrange(pwd10, pwd11, pwd12,
          pwd16, pwd17, pwd18,
          pwd19, pwd20, pwd21,
          pwd22, pwd23, pwd24,
          ncol = 3,
          nrow = 4)






```
















```{R}
library(data.table)
library(h2o)
library(raster)
library(tictoc)
library(foreach)
library(doParallel)
library(dplyr)
library(ggplot2)
library(tidyverse)


```



```{R}
bandnames <- c('Aridity_Index',
  'CHELSA_Annual_Mean_Temperature',
  'CHELSA_Annual_Precipitation',
  'CHELSA_Isothermality',
  'CHELSA_Max_Temperature_of_Warmest_Month',
  'CHELSA_Mean_Diurnal_Range',
  'CHELSA_Mean_Temperature_of_Coldest_Quarter',
  'CHELSA_Mean_Temperature_of_Driest_Quarter',
  'CHELSA_Mean_Temperature_of_Warmest_Quarter',
  'CHELSA_Mean_Temperature_of_Wettest_Quarter',
  'CHELSA_Min_Temperature_of_Coldest_Month',
  'CHELSA_Precipitation_Seasonality',
  'CHELSA_Precipitation_of_Coldest_Quarter',
  'CHELSA_Precipitation_of_Driest_Month',
  'CHELSA_Precipitation_of_Driest_Quarter',
  'CHELSA_Precipitation_of_Warmest_Quarter',
  'CHELSA_Precipitation_of_Wettest_Month',
  'CHELSA_Precipitation_of_Wettest_Quarter',
  'CHELSA_Temperature_Annual_Range',
  'CHELSA_Temperature_Seasonality',
  #'Depth_to_Water_Table',
  #'EarthEnvTopoMed_Eastness',
  #'EarthEnvTopoMed_Elevation',
  #'EarthEnvTopoMed_Northness',
  #'EarthEnvTopoMed_ProfileCurvature',
  #'EarthEnvTopoMed_Roughness',
  #'EarthEnvTopoMed_Slope'
  'PET'
  #'SG_Absolute_depth_to_bedrock',
  #'WorldClim2_SolarRadiation_AnnualMean',
  #'WorldClim2_WindSpeed_AnnualMean',
  #'EarthEnvCloudCover_MODCF_interannualSD',
  #'EarthEnvCloudCover_MODCF_intraannualSD',
  #'EarthEnvCloudCover_MODCF_meanannual',
  #'EarthEnvTopoMed_AspectCosine',
  #'EarthEnvTopoMed_AspectSine',
  #'SG_Clay_Content_0_100cm',
  #'SG_Coarse_fragments_0_100cm',
  #'SG_Sand_Content_0_100cm',
  #'SG_Silt_Content_0_100cm',
  #'SG_Soil_pH_H2O_0_100cm',
  #'SG_Nitrogen_Mean_0_100cm',
  #'cnRatio',
  #'Tree_Density',
  #'Human_Development_Percentage',
  #'HumanFootprint'
  #'soil_moisture'
  #'soil_nitrogen'
  #'cropland',
  #'grazing',
  #'Lai'
  #"pasture",
  #"rangeland")
)
```


```{R}
vartomodel<-'de_prop_dbh'
```



```{R}

climdf <- df.fft %>%
  dplyr::select(bandnames)

climpca <- prcomp(climdf, center = T, scale. = T)


summary(climpca)
```


```{R}

climmatrix <- climpca$x

climmatrix <- as.data.frame.matrix(climmatrix)


subclim <- climmatrix[,1:6]

names(subclim) <- c('climpc1','climpc2','climpc3','climpc4','climpc5','climpc6')




```




```{R}
bandnames <- c(#'Aridity_Index',
  #'CHELSA_Annual_Mean_Temperature',
  #'CHELSA_Annual_Precipitation',
  #'CHELSA_Isothermality',
  #'CHELSA_Max_Temperature_of_Warmest_Month',
  #'CHELSA_Mean_Diurnal_Range',
  #'CHELSA_Mean_Temperature_of_Coldest_Quarter',
  #'CHELSA_Mean_Temperature_of_Driest_Quarter',
  #'CHELSA_Mean_Temperature_of_Warmest_Quarter',
  #'CHELSA_Mean_Temperature_of_Wettest_Quarter',
  #'CHELSA_Min_Temperature_of_Coldest_Month',
  #'CHELSA_Precipitation_Seasonality',
  #'CHELSA_Precipitation_of_Coldest_Quarter',
  #'CHELSA_Precipitation_of_Driest_Month',
  #'CHELSA_Precipitation_of_Driest_Quarter',
  #'CHELSA_Precipitation_of_Warmest_Quarter',
  #'CHELSA_Precipitation_of_Wettest_Month',
  #'CHELSA_Precipitation_of_Wettest_Quarter',
  #'CHELSA_Temperature_Annual_Range',
  #'CHELSA_Temperature_Seasonality',
  #'Depth_to_Water_Table',
  #'EarthEnvTopoMed_Eastness',
  #'EarthEnvTopoMed_Elevation',
  #'EarthEnvTopoMed_Northness',
  #'EarthEnvTopoMed_ProfileCurvature',
  #'EarthEnvTopoMed_Roughness',
  #'EarthEnvTopoMed_Slope'
  #'PET'
  'SG_Absolute_depth_to_bedrock',
  #'WorldClim2_SolarRadiation_AnnualMean',
  #'WorldClim2_WindSpeed_AnnualMean',
  #'EarthEnvCloudCover_MODCF_interannualSD',
  #'EarthEnvCloudCover_MODCF_intraannualSD',
  #'EarthEnvCloudCover_MODCF_meanannual',
  #'EarthEnvTopoMed_AspectCosine',
  #'EarthEnvTopoMed_AspectSine',
  'SG_Clay_Content_0_100cm',
  'SG_Coarse_fragments_0_100cm',
  'SG_Sand_Content_0_100cm',
  'SG_Silt_Content_0_100cm',
  'SG_Soil_pH_H2O_0_100cm',
  'SG_Nitrogen_Mean_0_100cm',
  'cnRatio',
  #'Tree_Density',
  #'Human_Development_Percentage',
  #'HumanFootprint'
  'soil_moisture'
  #'soil_nitrogen'
  #'cropland',
  #'grazing',
  #'Lai'
  #"pasture",
  #"rangeland")
)
```



```{R}
soildf <- df.fft %>%
  dplyr::select(bandnames)


soilpca <- prcomp(soildf, center = T, scale. = T)

summary(soilpca)


```

```{R}
soilmatrix <- soilpca$x

soilmatrix <- as.data.frame.matrix(soilmatrix)

subsoil <- soilmatrix[,1:6]

names(subsoil) <- c('soilpc1','soilpc2','soilpc3','soilpc4','soilpc5','soilpc6')

```



```{R}
bandnames <- c(#'Aridity_Index',
  #'CHELSA_Annual_Mean_Temperature',
  #'CHELSA_Annual_Precipitation',
  #'CHELSA_Isothermality',
  #'CHELSA_Max_Temperature_of_Warmest_Month',
  #'CHELSA_Mean_Diurnal_Range',
  #'CHELSA_Mean_Temperature_of_Coldest_Quarter',
  #'CHELSA_Mean_Temperature_of_Driest_Quarter',
  #'CHELSA_Mean_Temperature_of_Warmest_Quarter',
  #'CHELSA_Mean_Temperature_of_Wettest_Quarter',
  #'CHELSA_Min_Temperature_of_Coldest_Month',
  #'CHELSA_Precipitation_Seasonality',
  #'CHELSA_Precipitation_of_Coldest_Quarter',
  #'CHELSA_Precipitation_of_Driest_Month',
  #'CHELSA_Precipitation_of_Driest_Quarter',
  #'CHELSA_Precipitation_of_Warmest_Quarter',
  #'CHELSA_Precipitation_of_Wettest_Month',
  #'CHELSA_Precipitation_of_Wettest_Quarter',
  #'CHELSA_Temperature_Annual_Range',
  #'CHELSA_Temperature_Seasonality',
  #'Depth_to_Water_Table',
  'EarthEnvTopoMed_Eastness',
  'EarthEnvTopoMed_Elevation',
  'EarthEnvTopoMed_Northness',
  'EarthEnvTopoMed_ProfileCurvature',
  'EarthEnvTopoMed_Roughness',
  'EarthEnvTopoMed_Slope',
  #'PET'
  #'SG_Absolute_depth_to_bedrock',
  #'WorldClim2_SolarRadiation_AnnualMean',
  #'WorldClim2_WindSpeed_AnnualMean',
  #'EarthEnvCloudCover_MODCF_interannualSD',
  #'EarthEnvCloudCover_MODCF_intraannualSD',
  #'EarthEnvCloudCover_MODCF_meanannual',
  'EarthEnvTopoMed_AspectCosine',
  'EarthEnvTopoMed_AspectSine'
  #'SG_Clay_Content_0_100cm',
  #'SG_Coarse_fragments_0_100cm',
  #'SG_Sand_Content_0_100cm',
  #'SG_Silt_Content_0_100cm',
  #'SG_Soil_pH_H2O_0_100cm',
  #'SG_Nitrogen_Mean_0_100cm',
  #'cnRatio',
  #'Tree_Density',
  #'Human_Development_Percentage',
  #'HumanFootprint'
  #'soil_moisture'
  #'soil_nitrogen'
  #'cropland',
  #'grazing',
  #'Lai'
  #"pasture",
  #"rangeland")
)
```


```{R}
topodf <- df.fft %>%
  dplyr::select(bandnames)


topopca <- prcomp(topodf, center = T, scale. = T)

summary(topopca)


```

```{R}
topomatrix <- topopca$x

topomatrix <- as.data.frame.matrix(topomatrix)

subtopo <- topomatrix[,1:6]

names(subtopo) <- c('topopc1', 'topopc2', 'topopc3', 'topopc4', 'topopc5', 'topopc6');


```



```{R}



```



```{R}

#totalregression <- 



```



```{R}
vartomodel<-'broad_prop_dbh'
```





select the bands from the regression matrix
```{R}
regressionmatrix<- bind_cols(subclim,subsoil,subtopo,df.fft$broad_prop_dbh)


names(regressionmatrix) <- c('climpc1','climpc2','climpc3','climpc4','climpc5','climpc6', 
                             'soilpc1','soilpc2','soilpc3','soilpc4','soilpc5','soilpc6',
                             'topopc1', 'topopc2', 'topopc3', 'topopc4', 'topopc5', 'topopc6',
                             vartomodel)

```




```{R}
#library(HH)
#library(car)
cor.matrix <- cor(regressionmatrix[,c(1:18)], use = 'complete.obs', method = 'pearson')
cor.dist <- abs(as.dist(cor.matrix))
cor.cluster <- hclust(1-cor.dist)

plot(cor.cluster)


```


```{R}

library(HH)

ds <- regressionmatrix[,c(1:18)]
ds <- as.data.frame(ds)
vif(ds)


```




```{R}
localH2O<-h2o.init(nthreads = 7, max_mem_size = '10g', ignore_config = TRUE)
```

import the regression matrix
```{R}
regmatrixh2o<-as.h2o(regressionmatrix, destination_frame = 'regMatrixH2O')
```


Run the model


```{R}
rf_model<-h2o.randomForest(
  #x = c('NDVI'),
  y = vartomodel,
  training_frame = regmatrixh2o,
  ntrees = 250,
  sample_rate = 0.632,
  nfolds = 10,
  min_rows = 3,
  mtries = 3,
  fold_assignment = 'AUTO',
  keep_cross_validation_predictions = TRUE,
  keep_cross_validation_fold_assignment = TRUE,
  seed = 0
)

```









```{R}
p1<-h2o.varimp_plot(rf_model)

t1<-h2o.varimp(rf_model)

t1
```

```{R}
h2o.r2(rf_model)


```

```{R}

library(readr)

write_csv(t1, 'C:\\Users\\haozh\\Desktop\\LL\\cor\\varimp_soil_topo_pc_broad.csv')

```



```{R}

shapsummary <- h2o.shap_summary_plot(rf_model, regmatrixh2o)

print(shapsummary)
```

```{R}
head(shapsummary$data)

shapdata <- shapsummary$data

```


```{R}
rf.params<-list(ntrees = 250,
                mtries = c(1:12),
                min_rows = c(1:10)
                )
```

set grsearch criteria

```{R}
search.criteria<-list(strategy = 'RandomDiscrete', max_models = 150, seed = 0, max_runtime_secs = 1800)
```



perform rf grsearch across parameters

Here we should keep cross validation predictions, these predictions will be used for calculating coefficients of determination values. 
```{R}
rf.grid<-h2o.grid('randomForest',
                  y = vartomodel,
                  grid_id = 'rf.grid',
                  training_frame = regmatrixh2o,
                  seed = 0,
                  hyper_params = rf.params,
                  sample_rate = 0.632,
                  nfolds = 10,
                  fold_assignment = 'AUTO',
                  keep_cross_validation_predictions = TRUE, # Important!
                  keep_cross_validation_fold_assignment = TRUE, # Important!
                  search_criteria = search.criteria)

```



retrieve grid searched model performance sort by RMSE/R2


```{R}
rf.grid.perf<-h2o.getGrid(grid_id = 'rf.grid',
                          sort_by = 'R2', # This is also coefficient of determinaion values
                          decreasing = TRUE)
```





```{R}
print(rf.grid.perf@summary_table)
```


```{R}

for(i in 1:10){

rfmodel <- h2o.getModel(rf.grid.perf@model_ids[[i]])

p1<-h2o.varimp_plot(rfmodel)

print(p1)

varip<-h2o.varimp(rfmodel)

varip

library(readr)

write_csv(varip, paste0('C:\\Users\\haozh\\Desktop\\LL\\cor\\bestmodel_broad_all',i,'_varip_20221028.csv'))


print(h2o.r2(rfmodel))
#h2o.rmse(rfmodel)

}

```






```{R}
h2o.shutdown(prompt = FALSE)

```

```{R}

#shapdata$original_value <- as.double(shapdata$original_value)


q1<-ggplot(data = shapdata[shapdata$feature == 'CHELSA_Mean_Temperature_of_Coldest_Quarter',], aes(x = normalized_value, y = contribution))+
  geom_point()+
  labs(title = 'Temperature')+
  geom_smooth(method = 'gam')+
  coord_cartesian(ylim = c(-40,40))+
  #theme(axis.title = element_text(size = 20), axis.text = element_text(size = 20, color = 'black'))+
  theme_classic()+
  theme(axis.title = element_text(size = 20), axis.text = element_text(size = 20, color = 'black'), title = element_text(size = 20))


q3<-ggplot(data = shapdata[shapdata$feature == "CHELSA_Annual_Precipitation",], aes(x = normalized_value, y = contribution))+
  geom_point()+
  labs(title = "Annual precipitation")+
  geom_smooth(method = 'gam')+
  coord_cartesian(ylim = c(-40,40))+
  #theme(axis.title = element_text(size = 20), axis.text = element_text(size = 20, color = 'black'))+
  theme_classic()+
  theme(axis.title = element_text(size = 20), axis.text = element_text(size = 20, color = 'black'), title = element_text(size = 20))

q4<-ggplot(data = shapdata[shapdata$feature == "CHELSA_Precipitation_of_Driest_Quarter" ,], aes(x = normalized_value, y = contribution))+
  geom_point()+
  labs(title = "prep dry" )+
  geom_smooth(method = 'gam')+
  coord_cartesian(ylim = c(-40,40))+
  #theme(axis.title = element_text(size = 20), axis.text = element_text(size = 20, color = 'black'))+
  theme_classic()+
  theme(axis.title = element_text(size = 20), axis.text = element_text(size = 20, color = 'black'), title = element_text(size = 20))


q2<-ggplot(data = shapdata[shapdata$feature == "cnRatio" ,], aes(x = normalized_value, y = contribution))+
  geom_point()+
  labs(title = "C:N ratio" )+
  geom_smooth(method = 'gam')+
  coord_cartesian(ylim = c(-40,40))+
  #theme(axis.title = element_text(size = 20), axis.text = element_text(size = 20, color = 'black'))+
  theme_classic()+
  theme(axis.title = element_text(size = 20), axis.text = element_text(size = 20, color = 'black'), title = element_text(size = 20))




q5<-ggplot(data = shapdata[shapdata$feature == "HumanFootprint" ,], aes(x = normalized_value, y = contribution))+
  geom_point()+
  labs(title = "HumanFootprint" )+
  geom_smooth(method = 'gam')+
  coord_cartesian(ylim = c(-40,40))+
  #theme(axis.title = element_text(size = 20), axis.text = element_text(size = 20, color = 'black'))+
  theme_classic()+
  theme(axis.title = element_text(size = 20), axis.text = element_text(size = 20, color = 'black'), title = element_text(size = 20))




q6<- ggplot(data = shapdata[shapdata$feature == "SG_Soil_pH_H2O_0_100cm" ,], aes(x = normalized_value, y = contribution))+
  geom_point()+
  labs(title = "Soil pH" )+
  geom_smooth(method = 'gam')+
  coord_cartesian(ylim = c(-40,40))+
  #theme(axis.title = element_text(size = 20), axis.text = element_text(size = 20, color = 'black'))+
  theme_classic()+
  theme(axis.title = element_text(size = 20), axis.text = element_text(size = 20, color = 'black'), title = element_text(size = 20))


q7 <- ggplot(data = shapdata[shapdata$feature == "SG_Sand_Content_0_100cm" ,], aes(x = normalized_value, y = contribution))+
  geom_point()+
  labs(title = "Soil sand content" )+
  geom_smooth(method = 'gam')+
  coord_cartesian(ylim = c(-40,40))+
  #theme(axis.title = element_text(size = 20), axis.text = element_text(size = 20, color = 'black'))+
  theme_classic()+
  theme(axis.title = element_text(size = 20), axis.text = element_text(size = 20, color = 'black'), title = element_text(size = 20))


q8 <- ggplot(data = shapdata[shapdata$feature == "Depth_to_Water_Table" ,], aes(x = normalized_value, y = contribution))+
  geom_point()+
  labs(title = "Depth_to_Water_Table" )+
  geom_smooth(method = 'gam')+
  coord_cartesian(ylim = c(-40,40))+
  #theme(axis.title = element_text(size = 20), axis.text = element_text(size = 20, color = 'black'))+
  theme_classic()+
  theme(axis.title = element_text(size = 20), axis.text = element_text(size = 20, color = 'black'), title = element_text(size = 20))



```


```{R}



library(ggpubr)


ggarrange(shapsummary, q1,
          q3, q4,
          q2, q5,
          ncol = 2,
          nrow = 3)

```





```{R}
library(ggparty)

library(partykit)


```


```{R}
set.seed(0)
ffttree <- ctree(broad_evergreen ~ CHELSA_Mean_Temperature_of_Coldest_Quarter +SG_Soil_pH_H2O_0_100cm+CHELSA_Annual_Precipitation+cnRatio, data = df.fft, control = ctree_control(minsplit = 1700, maxdepth = 3, mtry = 2))

ffttree
plot(ffttree)

ggparty(ffttree)+
  geom_edge()+
  geom_edge_label()+
  geom_node_splitvar()+
  geom_node_plot(gglist = list(
                               geom_boxplot(aes(y = broad_evergreen),outlier.alpha = 0),
                               theme_classic(),
                               theme(axis.text = element_text(size = 20), axis.title = element_text(size = 20))
 
                 )
  )


```
```{R}

plottheme <- theme(axis.title = element_text(color = 'black', size = 30), axis.text = element_text(color = 'black', size = 20))

besca1<-ggplot(df.fft, aes(x = cnRatio, y = broad_evergreen))+
  geom_point(alpha = 0.01)+
  geom_smooth()+
  coord_cartesian(ylim = c(0,100))+
  theme_classic()+
  plottheme

besca2<-ggplot(df.fft, aes(x = CHELSA_Mean_Temperature_of_Coldest_Quarter, y = broad_evergreen))+
  geom_point(alpha = 0.01)+
  geom_smooth()+
  coord_cartesian(ylim = c(0,100))+
  theme_classic()+
  plottheme

besca3<-ggplot(df.fft, aes(x = CHELSA_Annual_Precipitation, y = broad_evergreen))+
  geom_point(alpha = 0.01)+
  geom_smooth()+
  scale_x_continuous(trans = 'log10')+
  coord_cartesian(ylim = c(0,100))+
  theme_classic()+
  plottheme


besca4<-ggplot(df.fft, aes(x = SG_Soil_pH_H2O_0_100cm, y = broad_evergreen))+
  geom_point(alpha = 0.01)+
  geom_smooth()+
  scale_x_continuous(trans = 'log10')+
  coord_cartesian(ylim = c(0,100))+
  theme_classic()+
  plottheme



```


```{R}

library(ggpubr)


ggarrange(besca1, besca2,
          besca3, besca4,
          labels = c('A','B',
                     'C','D'),
          ncol = 2,
          nrow = 2)

```







```{R}
set.seed(0)
ffttree <- ctree(broad_deciduous ~ CHELSA_Mean_Temperature_of_Coldest_Quarter + SG_Sand_Content_0_100cm+CHELSA_Precipitation_of_Driest_Quarter+SG_Soil_pH_H2O_0_100cm+CHELSA_Annual_Precipitation+HumanFootprint+Depth_to_Water_Table+cnRatio, data = df.fft, control = ctree_control(minsplit = 1700, maxdepth = 3, mtry = 4))

ffttree
plot(ffttree)


ggparty(ffttree)+
  geom_edge()+
  geom_edge_label()+
  geom_node_splitvar()+
  geom_node_plot(gglist = list(
                               geom_boxplot(aes(y = broad_deciduous),outlier.alpha = 0),
                               theme_classic(),
                               theme(axis.text = element_text(size = 20),axis.title = element_text(size = 20))
                 )
  )


```

```{R}
bdsca1<-ggplot(df.fft, aes(x = CHELSA_Temperature_Seasonality, y = broad_deciduous))+
  geom_point(alpha = 0.01)+
  geom_smooth()+
  coord_cartesian(ylim = c(0,100))+
  theme_classic()+
  plottheme

bdsca2<-ggplot(df.fft, aes(x = CHELSA_Annual_Mean_Temperature, y = broad_deciduous))+
  geom_point(alpha = 0.01)+
  geom_smooth()+
  coord_cartesian(ylim = c(0,100))+
  theme_classic()+
  plottheme

bdsca3<-ggplot(df.fft, aes(x = CHELSA_Annual_Precipitation, y = broad_deciduous))+
  geom_point(alpha = 0.01)+
  geom_smooth()+
  scale_x_continuous(trans = 'log10')+
  coord_cartesian(ylim = c(0,100))+
  theme_classic()+
  plottheme


bdsca4<-ggplot(df.fft, aes(x = Aridity_Index, y = broad_deciduous))+
  geom_point(alpha = 0.01)+
  geom_smooth()+
  scale_x_continuous(trans = 'log10')+
  coord_cartesian(ylim = c(0,100))+
  theme_classic()+
  plottheme


bdsca5<-ggplot(df.fft, aes(x = SG_Soil_pH_H2O_0_100cm, y = broad_deciduous))+
  geom_point(alpha = 0.01)+
  geom_smooth()+
  #scale_x_continuous(trans = 'log10')+
  coord_cartesian(ylim = c(0,100))+
  theme_classic()+
  plottheme


bdsca6<-ggplot(df.fft, aes(x = SG_Sand_Content_0_100cm, y = broad_deciduous))+
  geom_point(alpha = 0.01)+
  geom_smooth()+
  #scale_x_continuous(trans = 'log10')+
  coord_cartesian(ylim = c(0,100))+
  theme_classic()+
  plottheme
```


```{R}

ggarrange(bdsca1, bdsca2,
          bdsca3, bdsca4,
          bdsca5, bdsca6,          
          labels = c('A', 'B',
                     'C', 'D',
                     'E', 'F'),
          ncol = 2,
          nrow = 3)


```




```{R}
set.seed(0)
ffttree <- ctree(needle ~  CHELSA_Mean_Temperature_of_Coldest_Quarter + CHELSA_Precipitation_of_Driest_Quarter+CHELSA_Annual_Precipitation+cnRatio+HumanFootprint, data = df.fft, control = ctree_control(minsplit = 1700, maxdepth = 3, mtry = Inf))

ffttree
plot(ffttree)

ggparty(ffttree)+
  geom_edge()+
  geom_edge_label()+
  geom_node_splitvar()+
  geom_node_plot(gglist = list(
                               geom_boxplot(aes(y = needle),outlier.alpha = 0),
                               theme_classic(),
                               theme(axis.text = element_text(size = 20),axis.title = element_text(size = 20))
 
                 )
  )


  
```


```{R}
nsca1<-ggplot(df.fft, aes(x = CHELSA_Temperature_Seasonality, y = needle))+
  geom_point(alpha = 0.01)+
  geom_smooth()+
  coord_cartesian(ylim = c(0,100))+
  theme_classic()+
  plottheme

nsca2<-ggplot(df.fft, aes(x = CHELSA_Annual_Mean_Temperature, y = needle))+
  geom_point(alpha = 0.01)+
  geom_smooth()+
  coord_cartesian(ylim = c(0,100))+
  theme_classic()+
  plottheme

nsca3<-ggplot(df.fft, aes(x = CHELSA_Annual_Precipitation, y = needle))+
  geom_point(alpha = 0.01)+
  geom_smooth()+
  scale_x_continuous(trans = 'log10')+
  coord_cartesian(ylim = c(0,100))+
  theme_classic()+
  plottheme


nsca4<-ggplot(df.fft[df.fft$cnratio>0,], aes(x = cnratio, y = needle))+
  geom_point(alpha = 0.01)+
  geom_smooth()+
  #scale_x_continuous(trans = 'log10')+
  coord_cartesian(ylim = c(0,100))+
  theme_classic()+
  plottheme
```


```{R}

ggarrange(nsca1, nsca2,
          nsca3, nsca4,
          labels = c('A', 'B',
                     'C', 'D'),
          ncol = 2,
          nrow = 2)



```



```{R}
ftwithclass <- read.csv('C:\\Users\\haozh\\Desktop\\LL\\functional_type_grid_search\\random_occurrence_with_env_dbh_seed10_recent_withfold_20220515.csv')

#for(i in c(100,1000, 9000, 500, 5000, 250, 2500, 1500, 1200)){
#  addon <- read.csv(paste0('C:\\Users\\haozh\\Desktop\\LL\\functional_type_grid_search\\random_occurrence_with_env_dbh_seed',i,'_recent_withfold_20220515.csv'))
#  ftwithclass <- rbind(ftwithclass,addon)
#}

ftwithclass$class[ftwithclass$class == 3 ] <- 2

```

```{R}
ggplot(ftwithclass, aes(x = '',fill = as.factor(class)))+
  geom_bar(position = 'fill')



```





```{R}
newds <- ftwithclass

newds$class <- as.factor(newds$class)

set.seed(0)
ffttree <- ctree(class ~ CHELSA_Mean_Temperature_of_Coldest_Quarter + CHELSA_Precipitation_of_Driest_Quarter+SG_Soil_pH_H2O_0_100cm+CHELSA_Annual_Precipitation+SG_Sand_Content_0_100cm+cnRatio+HumanFootprint+Depth_to_Water_Table, data = newds, control = ctree_control(minsplit = 600, maxdepth = 3, mtry = 4))

ffttree
plot(ffttree)


ggparty(ffttree) +
  geom_edge() +
  geom_edge_label() +
  geom_node_splitvar() +
  # pass list to gglist containing all ggplot components we want to plot for each
  # (default: terminal) node
  geom_node_plot(gglist = list(geom_bar( aes(x = '',fill = class),
                                        position ='fill'),
                               theme_classic(),
                               theme(axis.text = element_text(size = 20))))
```


```{R}

set.seed(0)
ffttree <- lmtree(broad_evergreen ~ CHELSA_Annual_Mean_Temperature | Aridity_Index+CHELSA_Temperature_Seasonality+SG_Soil_pH_H2O_0_100cm+CHELSA_Annual_Precipitation+cnratio+SG_Sand_Content_0_100cm, data = df.fft, caseweights = FALSE,minsplit = 900, maxdepth = 4, mtry = Inf)
ffttree
ggparty(ffttree)+
  geom_edge()+
  geom_edge_label()+
  geom_node_splitvar()+
  geom_node_plot(gglist = list(
                               geom_smooth(aes(x = CHELSA_Annual_Mean_Temperature,
                                               y = broad_evergreen),
                                           inherit.aes = FALSE,
                                           method = 'lm',color = 'blue'),
                               theme_classic()
 
                 )
  )

```



```{R}

set.seed(0)
ffttree <- lmtree(broad_evergreen ~ CHELSA_Annual_Mean_Temperature | Aridity_Index+CHELSA_Temperature_Seasonality+CHELSA_Annual_Precipitation, data = df.fft, caseweights = FALSE,minsplit = 1700, maxdepth = 4, mtry = Inf)
ffttree
beparty2<-ggparty(ffttree)+
  geom_edge()+
  geom_edge_label()+
  geom_node_splitvar()+
  geom_node_plot(gglist = list(geom_point(aes(x = CHELSA_Annual_Mean_Temperature,
                                              y = broad_evergreen),
                                          inherit.aes = FALSE,
                                          alpha = 0.01),
                               geom_smooth(aes(x = CHELSA_Annual_Mean_Temperature,
                                               y = broad_evergreen),
                                           inherit.aes = FALSE,
                                           method = 'gam',color = 'blue'),
                               coord_cartesian(ylim = c(0,100)),
                               labs(x = 'Annual mean temperature (\u00B0C)', y = 'Coverage (%)'),
                               theme(axis.title = element_text(size = 30), axis.text = element_text(size = 30)),
                               theme_classic()
 
                 )
  )

```



```{R}

set.seed(0)
ffttree <- lmtree(scale(broad_evergreen) ~ scale(CHELSA_Annual_Mean_Temperature) | Aridity_Index+CHELSA_Temperature_Seasonality+SG_Soil_pH_H2O_0_100cm+CHELSA_Annual_Precipitation+cnratio+SG_Sand_Content_0_100cm, data = df.fft, caseweights = FALSE,minsplit = 900, maxdepth = 4, mtry = Inf)
ffttree


```



```{R}
set.seed(0)
ffttree <- lmtree(broad_evergreen ~ CHELSA_Annual_Precipitation | Aridity_Index+CHELSA_Temperature_Seasonality+SG_Soil_pH_H2O_0_100cm+CHELSA_Annual_Mean_Temperature+cnratio+SG_Sand_Content_0_100cm, data = df.fft, caseweights = FALSE,minsplit = 900, maxdepth = 4, mtry = Inf)
ffttree
ggparty(ffttree)+
  geom_edge()+
  geom_edge_label()+
  geom_node_splitvar()+
  geom_node_plot(gglist = list(
                               geom_smooth(aes(x = CHELSA_Annual_Precipitation,
                                               y = broad_evergreen),
                                           inherit.aes = FALSE,
                                           method = 'lm',color = 'blue'),
                               theme_classic()
 
                 )
  )

```

```{R}
set.seed(0)
ffttree <- lmtree(broad_evergreen ~ CHELSA_Annual_Precipitation | Aridity_Index+CHELSA_Temperature_Seasonality+CHELSA_Annual_Mean_Temperature, data = df.fft, caseweights = FALSE,minsplit = 1700, maxdepth = 4, mtry = Inf)
ffttree
beparty3<-ggparty(ffttree)+
  geom_edge()+
  geom_edge_label()+
  geom_node_splitvar()+
  geom_node_plot(gglist = list(geom_point(aes(x = CHELSA_Annual_Precipitation,
                                              y = broad_evergreen),
                                          inherit.aes = FALSE,
                                          alpha = 0.01),
                               geom_smooth(aes(x = CHELSA_Annual_Precipitation,
                                               y = broad_evergreen),
                                           inherit.aes = FALSE,
                                           method = 'gam',color = 'blue'),
                               coord_cartesian(ylim = c(0,100)),
                               labs(x = 'Annual precipitation (mm)', y = 'Coverage (%)'),
                               theme(axis.title = element_text(size = 30), axis.text = element_text(size = 30)),
  
                               theme_classic()
 
                 )
  )

```




```{R}
set.seed(0)
ffttree <- lmtree(scale(broad_evergreen) ~ scale(CHELSA_Annual_Precipitation) | Aridity_Index+CHELSA_Temperature_Seasonality+SG_Soil_pH_H2O_0_100cm+CHELSA_Annual_Mean_Temperature+cnratio+SG_Sand_Content_0_100cm, data = df.fft, caseweights = FALSE, minsplit = 900, maxdepth = 4, mtry = Inf)
ffttree


```




```{R}
set.seed(0)
ffttree <- lmtree(broad_evergreen ~ Aridity_Index | CHELSA_Annual_Mean_Temperature+CHELSA_Temperature_Seasonality+SG_Soil_pH_H2O_0_100cm+CHELSA_Annual_Precipitation+cnratio+SG_Sand_Content_0_100cm, data = df.fft, caseweights = FALSE, minsplit = 900, maxdepth = 4, mtry = Inf)
ffttree
ggparty(ffttree)+
  geom_edge()+
  geom_edge_label()+
  geom_node_splitvar()+
  geom_node_plot(gglist = list(
                               geom_smooth(aes(x = Aridity_Index,
                                               y = broad_evergreen),
                                           inherit.aes = FALSE,
                                           method = 'lm',color = 'blue'),
                               theme_classic()
 
                 )
  )

```

```{R}
set.seed(0)
ffttree <- lmtree(broad_evergreen ~ Aridity_Index | CHELSA_Annual_Mean_Temperature+CHELSA_Temperature_Seasonality+CHELSA_Annual_Precipitation, data = df.fft, caseweights = FALSE, minsplit = 1700, maxdepth = 4, mtry = Inf)
ffttree
beparty4<-ggparty(ffttree)+
  geom_edge()+
  geom_edge_label()+
  geom_node_splitvar()+
  geom_node_plot(gglist = list(geom_point(aes(x = Aridity_Index,
                                              y = broad_evergreen),
                                          inherit.aes = FALSE,
                                          alpha = 0.01),
                               geom_smooth(aes(x = Aridity_Index,
                                               y = broad_evergreen),
                                           inherit.aes = FALSE,
                                           method = 'gam',color = 'blue'),
                               coord_cartesian(ylim = c(0,100)),
                               labs(x = 'Aridity index', y = 'Coverage (%)'),
                               theme(axis.text = element_text(size = 30), axis.title = element_text(size = 30)),
                               theme_classic()
 
                 )
  )

```




```{R}
set.seed(0)
ffttree <- lmtree(scale(broad_evergreen) ~ scale(Aridity_Index) | CHELSA_Annual_Mean_Temperature+CHELSA_Temperature_Seasonality+SG_Soil_pH_H2O_0_100cm+CHELSA_Annual_Precipitation+cnratio+SG_Sand_Content_0_100cm, data = df.fft, caseweights = FALSE, minsplit = 900, maxdepth = 4, mtry = Inf)
ffttree


```


```{R}
set.seed(0)
ffttree <- lmtree(broad_evergreen ~ SG_Sand_Content_0_100cm | Aridity_Index+CHELSA_Temperature_Seasonality+SG_Soil_pH_H2O_0_100cm+CHELSA_Annual_Precipitation+cnratio+CHELSA_Annual_Mean_Temperature, data = df.fft, caseweights = FALSE, minsplit = 900, maxdepth = 4, mtry = Inf)
ffttree
ggparty(ffttree)+
  geom_edge()+
  geom_edge_label()+
  geom_node_splitvar()+
  geom_node_plot(gglist = list(
                               geom_smooth(aes(x = SG_Sand_Content_0_100cm,
                                               y = broad_evergreen),
                                           inherit.aes = FALSE,
                                           method = 'lm',color = 'blue'),
                               theme_classic()
 
                 )
  )

```

```{R}
set.seed(0)
ffttree <- lmtree(broad_evergreen ~ SG_Sand_Content_0_100cm | Aridity_Index+CHELSA_Temperature_Seasonality+SG_Soil_pH_H2O_0_100cm+CHELSA_Annual_Precipitation+cnratio+CHELSA_Annual_Mean_Temperature, data = df.fft, caseweights = FALSE, minsplit = 1700, maxdepth = 4, mtry = Inf)
ffttree
ggparty(ffttree)+
  geom_edge()+
  geom_edge_label()+
  geom_node_splitvar()+
  geom_node_plot(gglist = list(geom_point(aes(x = SG_Sand_Content_0_100cm,
                                              y = broad_evergreen),
                                          inherit.aes = FALSE,
                                          alpha = 0.01),
                               geom_smooth(aes(x = SG_Sand_Content_0_100cm,
                                               y = broad_evergreen),
                                           inherit.aes = FALSE,
                                           method = 'gam',color = 'blue'),
                               theme_classic()
 
                 )
  )

```




```{R}
set.seed(0)
ffttree <- lmtree(scale(broad_evergreen) ~ scale(SG_Sand_Content_0_100cm) | Aridity_Index+CHELSA_Temperature_Seasonality+SG_Soil_pH_H2O_0_100cm+CHELSA_Annual_Precipitation+cnratio+CHELSA_Annual_Mean_Temperature, data = df.fft, caseweights = FALSE, minsplit = 900, maxdepth = 4, mtry = Inf)
ffttree


```



```{R}
set.seed(0)
ffttree <- lmtree(broad_evergreen ~ cnratio | Aridity_Index+CHELSA_Temperature_Seasonality+SG_Soil_pH_H2O_0_100cm+CHELSA_Annual_Precipitation+CHELSA_Annual_Mean_Temperature+SG_Sand_Content_0_100cm, data = df.fft[df.fft$cnratio>0,], caseweights = FALSE, minsplit = 900, maxdepth = 4, mtry = Inf)
ffttree
ggparty(ffttree)+
  geom_edge()+
  geom_edge_label()+
  geom_node_splitvar()+
  geom_node_plot(gglist = list(
                               geom_smooth(aes(x = cnratio,
                                               y = broad_evergreen),
                                           inherit.aes = FALSE,
                                           method = 'lm',color = 'blue'),
                               theme_classic()
 
                 )
  )

```

```{R}
set.seed(0)
ffttree <- lmtree(broad_evergreen ~ cnratio | Aridity_Index+CHELSA_Temperature_Seasonality+SG_Soil_pH_H2O_0_100cm+CHELSA_Annual_Precipitation+CHELSA_Annual_Mean_Temperature+SG_Sand_Content_0_100cm, data = df.fft, caseweights = FALSE, minsplit = 1700, maxdepth = 4, mtry = Inf)
ffttree
ggparty(ffttree)+
  geom_edge()+
  geom_edge_label()+
  geom_node_splitvar()+
  geom_node_plot(gglist = list(geom_point(aes(x = cnratio,
                                              y = broad_evergreen),
                                          inherit.aes = FALSE,
                                          alpha = 0.01),
                               geom_smooth(aes(x = cnratio,
                                               y = broad_evergreen),
                                           inherit.aes = FALSE,
                                           method = 'gam',color = 'blue'),
                               theme_classic()
 
                 )
  )

```




```{R}
set.seed(0)
ffttree <- lmtree(scale(broad_evergreen) ~ scale(cnratio) | Aridity_Index+CHELSA_Temperature_Seasonality+SG_Soil_pH_H2O_0_100cm+CHELSA_Annual_Precipitation+CHELSA_Annual_Mean_Temperature+SG_Sand_Content_0_100cm, data = df.fft, caseweights = FALSE, minsplit = 900, maxdepth = 4, mtry = Inf)
ffttree


```





```{R}
set.seed(0)
ffttree <- lmtree(broad_evergreen ~ SG_Soil_pH_H2O_0_100cm | Aridity_Index+CHELSA_Temperature_Seasonality+cnratio+CHELSA_Annual_Precipitation+CHELSA_Annual_Mean_Temperature+SG_Sand_Content_0_100cm, data = df.fft, caseweights = FALSE, minsplit = 900, maxdepth = 4, mtry = Inf)
ffttree
ggparty(ffttree)+
  geom_edge()+
  geom_edge_label()+
  geom_node_splitvar()+
  geom_node_plot(gglist = list(
                               geom_smooth(aes(x = SG_Soil_pH_H2O_0_100cm,
                                               y = broad_evergreen),
                                           inherit.aes = FALSE,
                                           method = 'lm',color = 'blue'),
                               theme_classic()
 
                 )
  )

```


```{R}
set.seed(0)
ffttree <- lmtree(broad_evergreen ~ SG_Soil_pH_H2O_0_100cm | Aridity_Index+CHELSA_Temperature_Seasonality+cnratio+CHELSA_Annual_Precipitation+CHELSA_Annual_Mean_Temperature+SG_Sand_Content_0_100cm, data = df.fft, caseweights = FALSE, minsplit = 900, maxdepth = 4, mtry = Inf)
ffttree
ggparty(ffttree)+
  geom_edge()+
  geom_edge_label()+
  geom_node_splitvar()+
  geom_node_plot(gglist = list(geom_point(aes(x = SG_Soil_pH_H2O_0_100cm,
                                              y = broad_evergreen),
                                          inherit.aes = FALSE,
                                          alpha = 0.01),
                               geom_smooth(aes(x = SG_Soil_pH_H2O_0_100cm,
                                               y = broad_evergreen),
                                           inherit.aes = FALSE,
                                           method = 'gam',color = 'blue'),
                               theme_classic()
 
                 )
  )

```




```{R}
set.seed(0)
ffttree <- lmtree(scale(broad_evergreen) ~ scale(SG_Soil_pH_H2O_0_100cm) | Aridity_Index+CHELSA_Temperature_Seasonality+cnratio+CHELSA_Annual_Precipitation+CHELSA_Annual_Mean_Temperature+SG_Sand_Content_0_100cm, data = df.fft, caseweights = FALSE, minsplit = 900, maxdepth = 4, mtry = Inf)
ffttree


```




```{R}
set.seed(0)
ffttree <- lmtree(broad_evergreen ~ CHELSA_Temperature_Seasonality | Aridity_Index+cnratio+SG_Soil_pH_H2O_0_100cm+CHELSA_Annual_Precipitation+CHELSA_Annual_Mean_Temperature+SG_Sand_Content_0_100cm, data = df.fft, caseweights = FALSE, minsplit = 1700, maxdepth = 4, mtry = Inf)
ffttree
ggparty(ffttree)+
  geom_edge()+
  geom_edge_label()+
  geom_node_splitvar()+
  geom_node_plot(gglist = list(
                               geom_smooth(aes(x = CHELSA_Temperature_Seasonality,
                                               y = broad_evergreen),
                                           inherit.aes = FALSE,
                                           method = 'lm',color = 'blue'),
                               theme_classic()
 
                 )
  )

```


```{R}
set.seed(0)
ffttree <- lmtree(broad_evergreen ~ CHELSA_Temperature_Seasonality | Aridity_Index+CHELSA_Annual_Precipitation+CHELSA_Annual_Mean_Temperature, data = df.fft, caseweights = FALSE, minsplit = 1700, maxdepth = 4, mtry = Inf)
ffttree
beparty1<-ggparty(ffttree)+
  geom_edge()+
  geom_edge_label()+
  geom_node_splitvar()+
  geom_node_plot(gglist = list(geom_point(aes(x = CHELSA_Temperature_Seasonality,
                                              y = broad_evergreen),
                                          inherit.aes = FALSE,
                                          alpha = 0.01),
                               geom_smooth(aes(x = CHELSA_Temperature_Seasonality,
                                               y = broad_evergreen),
                                           inherit.aes = FALSE,
                                           method = 'gam',color = 'blue'),
                               coord_cartesian(ylim = c(0,100)),
                               labs(x = 'Temperature seasonality', y = 'Coverage (%)'),
                               theme(axis.title = element_text(size = 30), axis.text = element_text(size = 30)),
                               theme_classic()
 
                 )
  )

```



```{R}
set.seed(0)
ffttree <- lmtree(scale(broad_evergreen) ~ scale(CHELSA_Temperature_Seasonality) | Aridity_Index+cnratio+SG_Soil_pH_H2O_0_100cm+CHELSA_Annual_Precipitation+CHELSA_Annual_Mean_Temperature+SG_Sand_Content_0_100cm, data = df.fft, caseweights = FALSE, minsplit = 900, maxdepth = 4, mtry = Inf)
ffttree


```






```{R}
library(ggpubr)

ggarrange(beparty1, 
          beparty2,
          beparty3,
          beparty4,
          ncol = 1,
          nrow = 4)






```




##############################################################################################################################################################
Broad deciduous

```{R}

set.seed(0)
ffttree <- lmtree(broad_deciduous ~ CHELSA_Annual_Mean_Temperature | Aridity_Index+CHELSA_Temperature_Seasonality+SG_Soil_pH_H2O_0_100cm+CHELSA_Annual_Precipitation+cnratio+SG_Sand_Content_0_100cm, data = df.fft, caseweights = FALSE,minsplit = 900, maxdepth = 4, mtry = Inf)
ffttree
ggparty(ffttree)+
  geom_edge()+
  geom_edge_label()+
  geom_node_splitvar()+
  geom_node_plot(gglist = list(geom_point(aes(x = CHELSA_Annual_Mean_Temperature,
                                              y = broad_deciduous),
                                          alpha = 0.1,
                                          inherit.aes = FALSE),
                               geom_smooth(aes(x = CHELSA_Annual_Mean_Temperature,
                                               y = broad_deciduous),
                                           inherit.aes = FALSE,
                                           method = 'lm',color = 'blue'),
                               theme_classic()
 
                 )
  )

```


```{R}

set.seed(0)
ffttree <- lmtree(broad_deciduous ~ CHELSA_Annual_Mean_Temperature | Aridity_Index+CHELSA_Temperature_Seasonality+SG_Sand_Content_0_100cm, data = df.fft, caseweights = FALSE,minsplit = 1700, maxdepth = 4, mtry = Inf)
ffttree
bdparty2<-ggparty(ffttree)+
  geom_edge()+
  geom_edge_label()+
  geom_node_splitvar()+
  geom_node_plot(gglist = list(geom_point(aes(x = CHELSA_Annual_Mean_Temperature,
                                              y = broad_deciduous),
                                          alpha = 0.01,
                                          inherit.aes = FALSE),
                               geom_smooth(aes(x = CHELSA_Annual_Mean_Temperature,
                                               y = broad_deciduous),
                                           inherit.aes = FALSE,
                                           method = 'gam',color = 'blue'),
                               coord_cartesian(ylim = c(0,100)),
                               labs(x = 'Annual mean temperature (\u00B0C)', y = 'Coverage (%)'),
                               theme(axis.title = element_text(size = 30), axis.text = element_text(size = 30)),
                               theme_classic()
 
                 )
  )

```




```{R}

set.seed(0)
ffttree <- lmtree(scale(broad_deciduous) ~ scale(CHELSA_Annual_Mean_Temperature) | Aridity_Index+CHELSA_Temperature_Seasonality+SG_Soil_pH_H2O_0_100cm+CHELSA_Annual_Precipitation+cnratio+SG_Sand_Content_0_100cm, data = df.fft, caseweights = FALSE,minsplit = 900, maxdepth = 4, mtry = Inf)
ffttree


```



```{R}
set.seed(0)
ffttree <- lmtree(broad_deciduous ~ CHELSA_Annual_Precipitation | Aridity_Index+CHELSA_Temperature_Seasonality+SG_Soil_pH_H2O_0_100cm+CHELSA_Annual_Mean_Temperature+cnratio+SG_Sand_Content_0_100cm, data = df.fft, caseweights = FALSE,minsplit = 900, maxdepth = 4, mtry = Inf)
ffttree
ggparty(ffttree)+
  geom_edge()+
  geom_edge_label()+
  geom_node_splitvar()+
  geom_node_plot(gglist = list(geom_point(aes(x = CHELSA_Annual_Precipitation,
                                              y = broad_deciduous),
                                          inherit.aes = FALSE,
                                          alpha = 0.01),
                               geom_smooth(aes(x = CHELSA_Annual_Precipitation,
                                               y = broad_deciduous),
                                           inherit.aes = FALSE,
                                           method = 'gam',color = 'blue',span = 0.1),
                               theme_classic()
 
                 )
  )

```


```{R}
set.seed(0)
ffttree <- lmtree(scale(broad_deciduous) ~ scale(CHELSA_Annual_Precipitation) | Aridity_Index+CHELSA_Temperature_Seasonality+SG_Soil_pH_H2O_0_100cm+CHELSA_Annual_Mean_Temperature+cnratio+SG_Sand_Content_0_100cm, data = df.fft, caseweights = FALSE, minsplit = 900, maxdepth = 4, mtry = Inf)
ffttree


```




```{R}
set.seed(0)
ffttree <- lmtree(broad_deciduous ~ Aridity_Index | CHELSA_Annual_Mean_Temperature+CHELSA_Temperature_Seasonality+SG_Sand_Content_0_100cm, data = df.fft, caseweights = FALSE, minsplit = 1700, maxdepth = 4, mtry = Inf)
ffttree
bdparty4<-ggparty(ffttree)+
  geom_edge()+
  geom_edge_label()+
  geom_node_splitvar()+
  geom_node_plot(gglist = list(geom_point(aes(x = Aridity_Index,
                                              y = broad_deciduous),
                                          inherit.aes = FALSE,
                                          alpha = 0.01),
                               geom_smooth(aes(x = Aridity_Index,
                                               y = broad_deciduous),
                                           inherit.aes = FALSE,
                                           method = 'gam',color = 'blue',n = 100),
                               coord_cartesian(ylim = c(0,100)),
                               labs(x = 'Aridity index', y = 'Coverage (%)'),
                               theme(axis.title = element_text(size = 30), axis.text = element_text(size = 30)),
                               theme_classic()
 
                 )
  )

```



```{R}
set.seed(0)
ffttree <- lmtree(scale(broad_deciduous) ~ scale(Aridity_Index) | CHELSA_Annual_Mean_Temperature+CHELSA_Temperature_Seasonality+SG_Soil_pH_H2O_0_100cm+CHELSA_Annual_Precipitation+cnratio+SG_Sand_Content_0_100cm, data = df.fft, caseweights = FALSE, minsplit = 900, maxdepth = 4, mtry = Inf)
ffttree


```


```{R}
set.seed(0)
ffttree <- lmtree(broad_deciduous ~ SG_Sand_Content_0_100cm | Aridity_Index+CHELSA_Temperature_Seasonality+CHELSA_Annual_Mean_Temperature, data = df.fft, caseweights = FALSE, minsplit = 1700, maxdepth = 4, mtry = Inf)
ffttree
bdparty3<-ggparty(ffttree)+
  geom_edge()+
  geom_edge_label()+
  geom_node_splitvar()+
  geom_node_plot(gglist = list(geom_point(aes(x = SG_Sand_Content_0_100cm,
                                              y = broad_deciduous),
                                          inherit.aes = FALSE,
                                          alpha = 0.01),
                               geom_smooth(aes(x = SG_Sand_Content_0_100cm,
                                               y = broad_deciduous),
                                           inherit.aes = FALSE,
                                           method = 'gam',color = 'blue'),
                               coord_cartesian(ylim = c(0,100)),
                               labs(x = 'Soil sand content (%)', y = 'Coverage (%)'),
                               theme(axis.title = element_text(size = 30), axis.text = element_text(size = 30)),
                               theme_classic()
 
                 )
  )

```


```{R}
set.seed(0)
ffttree <- lmtree(scale(broad_deciduous) ~ scale(SG_Sand_Content_0_100cm) | Aridity_Index+CHELSA_Temperature_Seasonality+SG_Soil_pH_H2O_0_100cm+CHELSA_Annual_Precipitation+cnratio+CHELSA_Annual_Mean_Temperature, data = df.fft, caseweights = FALSE, minsplit = 900, maxdepth = 4, mtry = Inf)
ffttree


```



```{R}
set.seed(0)
ffttree <- lmtree(broad_deciduous ~ cnratio | Aridity_Index+CHELSA_Temperature_Seasonality+SG_Soil_pH_H2O_0_100cm+CHELSA_Annual_Precipitation+CHELSA_Annual_Mean_Temperature+SG_Sand_Content_0_100cm, data = df.fft[df.fft$cnratio>0,], caseweights = FALSE, minsplit = 900, maxdepth = 4, mtry = Inf)
ffttree
ggparty(ffttree)+
  geom_edge()+
  geom_edge_label()+
  geom_node_splitvar()+
  geom_node_plot(gglist = list(geom_point(aes(x = cnratio,
                                              y = broad_deciduous),
                                          inherit.aes = FALSE,
                                          alpha = 0.01),
                               geom_smooth(aes(x = cnratio,
                                               y = broad_deciduous),
                                           inherit.aes = FALSE,
                                           method = 'gam',color = 'blue'),
                               theme_classic()
 
                 )
  )

```


```{R}
set.seed(0)
ffttree <- lmtree(scale(broad_deciduous) ~ scale(cnratio) | Aridity_Index+CHELSA_Temperature_Seasonality+SG_Soil_pH_H2O_0_100cm+CHELSA_Annual_Precipitation+CHELSA_Annual_Mean_Temperature+SG_Sand_Content_0_100cm, data = df.fft, caseweights = FALSE, minsplit = 900, maxdepth = 4, mtry = Inf)
ffttree


```





```{R}
set.seed(0)
ffttree <- lmtree(broad_deciduous ~ SG_Soil_pH_H2O_0_100cm | Aridity_Index+CHELSA_Temperature_Seasonality+cnratio+CHELSA_Annual_Precipitation+CHELSA_Annual_Mean_Temperature+SG_Sand_Content_0_100cm, data = df.fft, caseweights = FALSE, minsplit = 900, maxdepth = 4, mtry = Inf)
ffttree
ggparty(ffttree)+
  geom_edge()+
  geom_edge_label()+
  geom_node_splitvar()+
  geom_node_plot(gglist = list(geom_point(aes(x  = SG_Soil_pH_H2O_0_100cm,
                                              y = broad_deciduous),
                                          inherit.aes = FALSE,
                                          alpha = 0.01),
                               geom_smooth(aes(x = SG_Soil_pH_H2O_0_100cm,
                                               y = broad_deciduous),
                                           inherit.aes = FALSE,
                                           method = 'gam',color = 'blue'),
                               theme_classic()
 
                 )
  )

```


```{R}
set.seed(0)
ffttree <- lmtree(scale(broad_deciduous) ~ scale(SG_Soil_pH_H2O_0_100cm) | Aridity_Index+CHELSA_Temperature_Seasonality+cnratio+CHELSA_Annual_Precipitation+CHELSA_Annual_Mean_Temperature+SG_Sand_Content_0_100cm, data = df.fft, caseweights = FALSE, minsplit = 900, maxdepth = 4, mtry = Inf)
ffttree


```




```{R}
set.seed(0)
ffttree <- lmtree(broad_deciduous ~ CHELSA_Temperature_Seasonality | Aridity_Index+CHELSA_Annual_Mean_Temperature+SG_Sand_Content_0_100cm, data = df.fft, caseweights = FALSE, minsplit = 1700, maxdepth = 4, mtry = Inf)
ffttree
bdparty1<-ggparty(ffttree)+
  geom_edge()+
  geom_edge_label()+
  geom_node_splitvar()+
  geom_node_plot(gglist = list(geom_point(aes(x = CHELSA_Temperature_Seasonality,
                                              y = broad_deciduous),
                                          inherit.aes = FALSE,
                                          alpha = 0.01),
                               geom_smooth(aes(x = CHELSA_Temperature_Seasonality,
                                               y = broad_deciduous),
                                           inherit.aes = FALSE,
                                           method = 'gam',color = 'blue'),
                               coord_cartesian(ylim = c(0,100)),
                               labs(x = 'Temperature seasonality', y = 'Coverage (%)'),
                               theme(axis.title = element_text(size = 30), axis.text = element_text(size = 30)),
                               theme_classic()
 
                 )
  )

```


```{R}
set.seed(0)
ffttree <- lmtree(scale(broad_deciduous) ~ scale(CHELSA_Temperature_Seasonality) | Aridity_Index+cnratio+SG_Soil_pH_H2O_0_100cm+CHELSA_Annual_Precipitation+CHELSA_Annual_Mean_Temperature+SG_Sand_Content_0_100cm, data = df.fft, caseweights = FALSE, minsplit = 900, maxdepth = 4, mtry = Inf)
ffttree


```



```{R}
set.seed(0)
ffttree <- lmtree(broad_deciduous ~ nplimitation | Aridity_Index+cnratio+SG_Soil_pH_H2O_0_100cm+CHELSA_Annual_Precipitation+CHELSA_Annual_Mean_Temperature+SG_Sand_Content_0_100cm+CHELSA_Temperature_Seasonality, data = df.fft, caseweights = FALSE, minsplit = 900, maxdepth = 4, mtry = Inf)
ffttree
ggparty(ffttree)+
  geom_edge()+
  geom_edge_label()+
  geom_node_splitvar()+
  geom_node_plot(gglist = list(geom_point(aes(x = nplimitation,
                                              y = broad_deciduous),
                                          inherit.aes = FALSE,
                                          alpha = 0.01),
                               geom_smooth(aes(x = nplimitation,
                                               y = broad_deciduous),
                                           inherit.aes = FALSE,
                                           method = 'gam',color = 'blue'),
                               theme_classic()
 
                 )
  )

```


```{R}

ggarrange(bdparty1,
          bdparty2,
          bdparty3,
          bdparty4,
          ncol = 1,
          nrow = 4)


```








###########################################################################################################################################################
needle

```{R}

set.seed(0)
ffttree <- lmtree(needle ~ CHELSA_Annual_Mean_Temperature | CHELSA_Temperature_Seasonality+CHELSA_Annual_Precipitation+cnratio, data = df.fft, caseweights = FALSE,minsplit = 1700, maxdepth = 4, mtry = Inf)
ffttree
nparty1<-ggparty(ffttree)+
  geom_edge()+
  geom_edge_label()+
  geom_node_splitvar()+
  geom_node_plot(gglist = list(geom_point(aes(x = CHELSA_Annual_Mean_Temperature,
                                              y = needle),
                                          inherit.aes = FALSE,
                                          alpha = 0.01),
                               geom_smooth(aes(x = CHELSA_Annual_Mean_Temperature,
                                               y = needle),
                                           inherit.aes = FALSE,
                                           method = 'gam',color = 'blue'),
                               coord_cartesian(ylim = c(0,100)),
                               labs(x = 'Annual mean temperature (\u00B0C)', y = 'Coverage (%)'),
                               theme(axis.title = element_text(size = 30), axis.text = element_text(size = 30)),
                               theme_classic()
 
                 )
  )

```

```{R}

set.seed(0)
ffttree <- lmtree(scale(needle) ~ scale(CHELSA_Annual_Mean_Temperature) | Aridity_Index+CHELSA_Temperature_Seasonality+SG_Soil_pH_H2O_0_100cm+CHELSA_Annual_Precipitation+cnratio+SG_Sand_Content_0_100cm, data = df.fft, caseweights = FALSE,minsplit = 900, maxdepth = 4, mtry = Inf)
ffttree


```



```{R}
set.seed(0)
ffttree <- lmtree(needle ~ CHELSA_Annual_Precipitation | CHELSA_Temperature_Seasonality+CHELSA_Annual_Mean_Temperature+cnratio, data = df.fft, caseweights = FALSE,minsplit = 1700, maxdepth = 4, mtry = Inf)
ffttree
nparty4<-ggparty(ffttree)+
  geom_edge()+
  geom_edge_label()+
  geom_node_splitvar()+
  geom_node_plot(gglist = list(geom_point(aes(x = CHELSA_Annual_Precipitation,
                                              y = needle),
                                          inherit.aes = FALSE,
                                          alpha = 0.01),
                               geom_smooth(aes(x = CHELSA_Annual_Precipitation,
                                               y = needle),
                                           inherit.aes = FALSE,
                                           method = 'gam',color = 'blue'),
                               coord_cartesian(ylim = c(0,100)),
                               labs(x = 'Annual precipitation (mm)', y = 'Coverage (%)'),
                               theme(axis.title = element_text(size = 30), axis.text = element_text(size = 30)),
                               theme_classic()
 
                 )
  )

```


```{R}
set.seed(0)
ffttree <- lmtree(scale(needle) ~ scale(CHELSA_Annual_Precipitation) | Aridity_Index+CHELSA_Temperature_Seasonality+SG_Soil_pH_H2O_0_100cm+CHELSA_Annual_Mean_Temperature+cnratio+SG_Sand_Content_0_100cm, data = df.fft, caseweights = FALSE, minsplit = 900, maxdepth = 4, mtry = Inf)
ffttree


```




```{R}
set.seed(0)
ffttree <- lmtree(needle ~ Aridity_Index | CHELSA_Annual_Mean_Temperature+CHELSA_Temperature_Seasonality+SG_Soil_pH_H2O_0_100cm+CHELSA_Annual_Precipitation+cnratio+SG_Sand_Content_0_100cm, data = df.fft, caseweights = FALSE, minsplit = 900, maxdepth = 4, mtry = Inf)
ffttree
ggparty(ffttree)+
  geom_edge()+
  geom_edge_label()+
  geom_node_splitvar()+
  geom_node_plot(gglist = list(geom_point(aes(x = Aridity_Index,
                                              y = needle),
                                          inherit.aes = FALSE,
                                          alpha = 0.01),
                               geom_smooth(aes(x = Aridity_Index,
                                               y = needle),
                                           inherit.aes = FALSE,
                                           method = 'gam',color = 'blue'),
                               theme_classic()
 
                 )
  )

```


```{R}
set.seed(0)
ffttree <- lmtree(scale(needle) ~ scale(Aridity_Index) | CHELSA_Annual_Mean_Temperature+CHELSA_Temperature_Seasonality+SG_Soil_pH_H2O_0_100cm+CHELSA_Annual_Precipitation+cnratio+SG_Sand_Content_0_100cm, data = df.fft, caseweights = FALSE, minsplit = 900, maxdepth = 4, mtry = Inf)
ffttree


```


```{R}
set.seed(0)
ffttree <- lmtree(needle ~ SG_Sand_Content_0_100cm | Aridity_Index+CHELSA_Temperature_Seasonality+SG_Soil_pH_H2O_0_100cm+CHELSA_Annual_Precipitation+cnratio+CHELSA_Annual_Mean_Temperature, data = df.fft, caseweights = FALSE, minsplit = 900, maxdepth = 4, mtry = Inf)
ffttree
ggparty(ffttree)+
  geom_edge()+
  geom_edge_label()+
  geom_node_splitvar()+
  geom_node_plot(gglist = list(geom_point(aes(x = SG_Sand_Content_0_100cm,
                                              y = needle),
                                          inherit.aes = FALSE,
                                          alpha = 0.01),
                               geom_smooth(aes(x = SG_Sand_Content_0_100cm,
                                               y = needle),
                                           inherit.aes = FALSE,
                                           method = 'gam',color = 'blue'),
                               theme_classic()
 
                 )
  )

```


```{R}
set.seed(0)
ffttree <- lmtree(scale(needle) ~ scale(SG_Sand_Content_0_100cm) | Aridity_Index+CHELSA_Temperature_Seasonality+SG_Soil_pH_H2O_0_100cm+CHELSA_Annual_Precipitation+cnratio+CHELSA_Annual_Mean_Temperature, data = df.fft, caseweights = FALSE, minsplit = 900, maxdepth = 4, mtry = Inf)
ffttree


```



```{R}
set.seed(0)
ffttree <- lmtree(needle ~ cnratio | CHELSA_Temperature_Seasonality+CHELSA_Annual_Precipitation+CHELSA_Annual_Mean_Temperature, data = df.fft[df.fft$cnratio>0,], caseweights = FALSE, minsplit = 1700, maxdepth = 4, mtry = Inf)
ffttree
nparty3<-ggparty(ffttree)+
  geom_edge()+
  geom_edge_label()+
  geom_node_splitvar()+
  geom_node_plot(gglist = list(geom_point(aes(x=cnratio,
                                              y = needle),
                                          inherit.aes = FALSE,
                                          alpha = 0.01),
                               geom_smooth(aes(x = cnratio,
                                               y = needle),
                                           inherit.aes = FALSE,
                                           method = 'gam',color = 'blue'),
                               coord_cartesian(ylim = c(0,100)),
                               labs(x = 'Soil C:N ratio', y = 'Coverage (%)'),
                               theme(axis.title = element_text(size = 30), axis.text = element_text(size = 30)),
                               theme_classic()
 
                 )
  )

```


```{R}
set.seed(0)
ffttree <- lmtree(scale(needle) ~ scale(cnratio) | Aridity_Index+CHELSA_Temperature_Seasonality+SG_Soil_pH_H2O_0_100cm+CHELSA_Annual_Precipitation+CHELSA_Annual_Mean_Temperature+SG_Sand_Content_0_100cm, data = df.fft, caseweights = FALSE, minsplit = 900, maxdepth = 4, mtry = 3)
ffttree


```





```{R}
set.seed(0)
ffttree <- lmtree(needle ~ SG_Soil_pH_H2O_0_100cm | Aridity_Index+CHELSA_Temperature_Seasonality+cnratio+CHELSA_Annual_Precipitation+CHELSA_Annual_Mean_Temperature+SG_Sand_Content_0_100cm, data = df.fft, caseweights = FALSE, minsplit = 900, maxdepth = 4, mtry = Inf)
ffttree
ggparty(ffttree)+
  geom_edge()+
  geom_edge_label()+
  geom_node_splitvar()+
  geom_node_plot(gglist = list(geom_point(aes(x = SG_Soil_pH_H2O_0_100cm,
                                              y = needle),
                                          inherit.aes = FALSE,
                                          alpha = 0.01),
                               geom_smooth(aes(x = SG_Soil_pH_H2O_0_100cm,
                                               y = needle),
                                           inherit.aes = FALSE,
                                           method = 'gam',color = 'blue'),
                               theme_classic()
 
                 )
  )

```


```{R}
set.seed(0)
ffttree <- lmtree(scale(needle) ~ scale(SG_Soil_pH_H2O_0_100cm) | Aridity_Index+CHELSA_Temperature_Seasonality+cnratio+CHELSA_Annual_Precipitation+CHELSA_Annual_Mean_Temperature+SG_Sand_Content_0_100cm, data = df.fft, caseweights = FALSE, minsplit = 900, maxdepth = 4, mtry = Inf)
ffttree


```




```{R}
set.seed(0)
ffttree <- lmtree(needle ~ CHELSA_Temperature_Seasonality | cnratio+CHELSA_Annual_Precipitation+CHELSA_Annual_Mean_Temperature, data = df.fft, caseweights = FALSE, minsplit = 1700, maxdepth = 4, mtry = Inf)
ffttree
nparty2<-ggparty(ffttree)+
  geom_edge()+
  geom_edge_label()+
  geom_node_splitvar()+
  geom_node_plot(gglist = list(geom_point(aes(x = CHELSA_Temperature_Seasonality,
                                              y = needle),
                                          inherit.aes = FALSE,
                                          alpha = 0.01),
                               geom_smooth(aes(x = CHELSA_Temperature_Seasonality,
                                               y = needle),
                                           inherit.aes = FALSE,
                                           method = 'gam',color = 'blue'),
                               coord_cartesian(ylim = c(0,100)),
                               labs(x = 'Temperature seasonality', y = 'Coverage (%)'),
                               theme(axis.title = element_text(size = 30), axis.text = element_text(size = 30)),
                               theme_classic()
 
                 )
  )

```


```{R}
set.seed(0)
ffttree <- lmtree(scale(needle) ~ scale(CHELSA_Temperature_Seasonality) | Aridity_Index+cnratio+SG_Soil_pH_H2O_0_100cm+CHELSA_Annual_Precipitation+CHELSA_Annual_Mean_Temperature+SG_Sand_Content_0_100cm, data = df.fft, caseweights = FALSE, minsplit = 900, maxdepth = 4, mtry = Inf)
ffttree


```



```{R}
set.seed(0)
ffttree <- lmtree(needle ~ nplimitation | Aridity_Index+cnratio+SG_Soil_pH_H2O_0_100cm+CHELSA_Annual_Precipitation+CHELSA_Annual_Mean_Temperature+SG_Sand_Content_0_100cm+CHELSA_Temperature_Seasonality, data = df.fft, caseweights = FALSE, minsplit = 900, maxdepth = 4, mtry = Inf)
ffttree
ggparty(ffttree)+
  geom_edge()+
  geom_edge_label()+
  geom_node_splitvar()+
  geom_node_plot(gglist = list(geom_point(aes(x = nplimitation,
                                              y = needle),
                                          inherit.aes = FALSE,
                                          alpha = 0.01),
                               geom_smooth(aes(x = nplimitation,
                                               y = needle),
                                           inherit.aes = FALSE,
                                           method = 'gam',color = 'blue'),
                               theme_classic()
 
                 )
  )

```


```{R}
ggarrange(nparty1,
          nparty2,
          nparty3,
          nparty4,
          ncol = 1,
          nrow = 4)



```



###########################################################################################################################################################































```{R}

dfwithclass <- read.csv('C:\\Users\\haozh\\Desktop\\LL\\functional_type_grid_search\\dswithcovariate_with_class_with_fold_20210621.csv')


names(dfwithclass)

```


```{R}



dfwithclass <- dfwithclass[dfwithclass$class == 0 | dfwithclass$class == 1 | dfwithclass$class == 2, ]

dfwithclass$class <- as.factor(dfwithclass$class)

```


```{R}
library(ggplot2)
library(ggridges)
theme_set(theme_minimal())
```


```{R}

ggplot(dfwithclass, aes(x = CHELSA_Annual_Mean_Temperature, color = class))+
  geom_density(alpha = 0.4)


ggplot(dfwithclass, aes(x = CHELSA_Annual_Mean_Temperature, fill = class))+
  geom_histogram(alpha = 0.4, position = 'identity')+
  theme_classic()



ggplot(dfwithclass, aes(x = CHELSA_Annual_Mean_Temperature))+
  geom_histogram()

```


```{R}

ggplot(dfwithclass, aes(x = log(CHELSA_Annual_Precipitation), color = class))+
  geom_density(alpha = 0.4)




ggplot(dfwithclass, aes(x = log(CHELSA_Annual_Precipitation), fill = class))+
  geom_histogram(alpha = 0.5, position = 'identity')+
  scale_fill_viridis_d()


ggplot(dfwithclass, aes(x = CHELSA_Annual_Precipitation))+
  geom_histogram()

```

```{R}
prep1<-dfwithclass[dfwithclass$CHELSA_Annual_Precipitation<400,]
prep1$prepcat <- 'less than 400'

prep2 <- dfwithclass[dfwithclass$CHELSA_Annual_Precipitation >=400 & dfwithclass$CHELSA_Annual_Precipitation < 800,]
prep2$prepcat <- '400 to 800'

prep3 <- dfwithclass[dfwithclass$CHELSA_Annual_Precipitation >=800 & dfwithclass$CHELSA_Annual_Precipitation < 1200, ]
prep3$prepcat <- '800 to 1200'
prep4 <- dfwithclass[dfwithclass$CHELSA_Annual_Precipitation >=1200 & dfwithclass$CHELSA_Annual_Precipitation < 2000,]
prep4$prepcat <- 'higher than 1200'


prep5 <- dfwithclass[dfwithclass$CHELSA_Annual_Precipitation >=2000 & dfwithclass$CHELSA_Annual_Precipitation <2500, ]
prep5$prepcat <- 'higher than 1200'

prep6 <- dfwithclass[dfwithclass$CHELSA_Annual_Precipitation >=2500, ]
prep6$prepcat <- 'higher than 1200'


newdata <- rbind(prep1, rbind(prep2, rbind(prep3, rbind(prep4, rbind(prep5, prep6)))))

newdata$prepcat <- factor(newdata$prepcat, levels = c('less than 400', '400 to 800', '800 to 1200', 'higher than 1200'))


ggplot(newdata, aes(x = CHELSA_Annual_Mean_Temperature, y = prepcat, fill = class))+
  geom_density_ridges(rel_min_height = 0.01, alpha = 0.3)


ggplot(newdata, aes(x = CHELSA_Annual_Mean_Temperature, fill = class))+
  geom_histogram(alpha = 0.5, position = 'identity')+
  geom_density(alpha = 0.2)+
  scale_fill_viridis_d()+
  facet_wrap(~prepcat, ncol = 1)


ggplot(newdata, aes(x = prepcat, y = CHELSA_Annual_Mean_Temperature, color = class))+
  stat_summary(fun.data = 'mean_cl_boot', size = 1)+
  stat_summary(fun = mean, geom = 'line', size = 1, aes(group = class))+
  scale_color_viridis_d()


```

```{R}
ggplot(dfwithclass, aes(x = EarthEnvTopoMed_Elevation))+
  geom_histogram()





```

```{R}

ele1 <- dfwithclass[dfwithclass$EarthEnvTopoMed_Elevation < 500, ]
ele1$elecat <- 'less than 500'

ele2 <- dfwithclass[dfwithclass$EarthEnvTopoMed_Elevation >=500 & dfwithclass$EarthEnvTopoMed_Elevation<1000, ]
ele2$elecat <-'500 to 1000'

ele3 <- dfwithclass[dfwithclass$EarthEnvTopoMed_Elevation >=1000 & dfwithclass$EarthEnvTopoMed_Elevation < 1500, ]
ele3$elecat <- '1000 to 1500'

ele4 <- dfwithclass[dfwithclass$EarthEnvTopoMed_Elevation >=1500 & dfwithclass$EarthEnvTopoMed_Elevation < 2000, ]
ele4$elecat <- '1500 to 2000'

ele5 <- dfwithclass[dfwithclass$EarthEnvTopoMed_Elevation >= 2000, ]
ele5$elecat <- 'higher than 2000'


newdata <- rbind(ele1, rbind(ele2, rbind(ele3, rbind(ele4, ele5))))

newdata$elecat <- factor(newdata$elecat, levels = c('less than 500', '500 to 1000', '1000 to 1500', '1500 to 2000', 'higher than 2000'))


ggplot(newdata, aes(x = CHELSA_Annual_Mean_Temperature, y = elecat, fill = class))+
  geom_density_ridges(rel_min_height = 0.01, alpha = 0.3)

ggplot(newdata, aes(x = CHELSA_Annual_Mean_Temperature, fill = class))+
  geom_histogram(alpha = 0.5, position = 'identity')+
  scale_fill_viridis_d()+
  facet_wrap(~elecat, ncol = 1)


ggplot(newdata, aes(x = elecat, y = CHELSA_Annual_Mean_Temperature, color = class))+
  stat_summary(fun.data = 'mean_cl_boot', size = 1)+
  stat_summary(fun = mean, geom = 'line', size = 1, aes(group = class))+
  scale_color_viridis_d()


```


```{R}
prep1<-dfwithclass[dfwithclass$CHELSA_Annual_Precipitation<400,]
prep1$prepcat <- 'less than 400'

prep2 <- dfwithclass[dfwithclass$CHELSA_Annual_Precipitation >=400 & dfwithclass$CHELSA_Annual_Precipitation < 800,]
prep2$prepcat <- '400 to 800'

prep3 <- dfwithclass[dfwithclass$CHELSA_Annual_Precipitation >=800 & dfwithclass$CHELSA_Annual_Precipitation < 1200, ]
prep3$prepcat <- '800 to 1200'
prep4 <- dfwithclass[dfwithclass$CHELSA_Annual_Precipitation >=1200 & dfwithclass$CHELSA_Annual_Precipitation < 2000,]
prep4$prepcat <- 'higher than 1200'


prep5 <- dfwithclass[dfwithclass$CHELSA_Annual_Precipitation >=2000 & dfwithclass$CHELSA_Annual_Precipitation <2500, ]
prep5$prepcat <- 'higher than 1200'

prep6 <- dfwithclass[dfwithclass$CHELSA_Annual_Precipitation >=2500, ]
prep6$prepcat <- 'higher than 1200'


newdata <- rbind(prep1, rbind(prep2, rbind(prep3, rbind(prep4, rbind(prep5, prep6)))))

newdata$prepcat <- factor(newdata$prepcat, levels = c('less than 400', '400 to 800', '800 to 1200', 'higher than 1200'))


ggplot(newdata, aes(x = CHELSA_Temperature_Seasonality, y = prepcat, fill = class))+
  geom_density_ridges(rel_min_height = 0.01, alpha = 0.3)


ggplot(newdata, aes(x = CHELSA_Temperature_Seasonality, fill = class))+
  geom_histogram(alpha = 0.5, position = 'identity')+
  geom_density(alpha = 0.2)+
  scale_fill_viridis_d()+
  facet_wrap(~prepcat, ncol = 1)


ggplot(newdata, aes(x = prepcat, y = CHELSA_Temperature_Seasonality, color = class))+
  stat_summary(fun.data = 'mean_cl_boot', size = 1)+
  stat_summary(fun = mean, geom = 'line', size = 1, aes(group = class))+
  scale_color_viridis_d()


```


```{R}
prep1<-dfwithclass[dfwithclass$CHELSA_Annual_Precipitation<400,]
prep1$prepcat <- 'less than 400'

prep2 <- dfwithclass[dfwithclass$CHELSA_Annual_Precipitation >=400 & dfwithclass$CHELSA_Annual_Precipitation < 800,]
prep2$prepcat <- '400 to 800'

prep3 <- dfwithclass[dfwithclass$CHELSA_Annual_Precipitation >=800 & dfwithclass$CHELSA_Annual_Precipitation < 1200, ]
prep3$prepcat <- '800 to 1200'
prep4 <- dfwithclass[dfwithclass$CHELSA_Annual_Precipitation >=1200 & dfwithclass$CHELSA_Annual_Precipitation < 2000,]
prep4$prepcat <- 'higher than 1200'


prep5 <- dfwithclass[dfwithclass$CHELSA_Annual_Precipitation >=2000 & dfwithclass$CHELSA_Annual_Precipitation <2500, ]
prep5$prepcat <- 'higher than 1200'

prep6 <- dfwithclass[dfwithclass$CHELSA_Annual_Precipitation >=2500, ]
prep6$prepcat <- 'higher than 1200'


newdata <- rbind(prep1, rbind(prep2, rbind(prep3, rbind(prep4, rbind(prep5, prep6)))))

newdata$prepcat <- factor(newdata$prepcat, levels = c('less than 400', '400 to 800', '800 to 1200', 'higher than 1200'))


ggplot(newdata, aes(x = log(Aridity_Index+1), y = prepcat, fill = class))+
  geom_density_ridges(rel_min_height = 0.01, alpha = 0.3)


ggplot(newdata, aes(x = log(Aridity_Index+1), fill = class))+
  geom_histogram(alpha = 0.5, position = 'identity')+
  geom_density(alpha = 0.2)+
  scale_fill_viridis_d()+
  facet_wrap(~prepcat, ncol = 1)


ggplot(newdata, aes(x = prepcat, y = log(Aridity_Index+1), color = class))+
  stat_summary(fun.data = 'mean_cl_boot', size = 1)+
  stat_summary(fun = mean, geom = 'line', size = 1, aes(group = class))+
  scale_color_viridis_d()


```

```{R}
prep1<-dfwithclass[dfwithclass$CHELSA_Annual_Precipitation<400,]
prep1$prepcat <- 'less than 400'

prep2 <- dfwithclass[dfwithclass$CHELSA_Annual_Precipitation >=400 & dfwithclass$CHELSA_Annual_Precipitation < 800,]
prep2$prepcat <- '400 to 800'

prep3 <- dfwithclass[dfwithclass$CHELSA_Annual_Precipitation >=800 & dfwithclass$CHELSA_Annual_Precipitation < 1200, ]
prep3$prepcat <- '800 to 1200'
prep4 <- dfwithclass[dfwithclass$CHELSA_Annual_Precipitation >=1200 & dfwithclass$CHELSA_Annual_Precipitation < 2000,]
prep4$prepcat <- 'higher than 1200'


prep5 <- dfwithclass[dfwithclass$CHELSA_Annual_Precipitation >=2000 & dfwithclass$CHELSA_Annual_Precipitation <2500, ]
prep5$prepcat <- 'higher than 1200'

prep6 <- dfwithclass[dfwithclass$CHELSA_Annual_Precipitation >=2500, ]
prep6$prepcat <- 'higher than 1200'


newdata <- rbind(prep1, rbind(prep2, rbind(prep3, rbind(prep4, rbind(prep5, prep6)))))

newdata$prepcat <- factor(newdata$prepcat, levels = c('less than 400', '400 to 800', '800 to 1200', 'higher than 1200'))


ggplot(newdata, aes(x = SG_Sand_Content_0_100cm, y = prepcat, fill = class))+
  geom_density_ridges(rel_min_height = 0.01, alpha = 0.3)


ggplot(newdata, aes(x = SG_Sand_Content_0_100cm, fill = class))+
  geom_histogram(alpha = 0.5, position = 'identity')+
  geom_density(alpha = 0.2)+
  scale_fill_viridis_d()+
  facet_wrap(~prepcat, ncol = 1)


ggplot(newdata, aes(x = prepcat, y = SG_Sand_Content_0_100cm, color = class))+
  stat_summary(fun.data = 'mean_cl_boot', size = 1)+
  stat_summary(fun = mean, geom = 'line', size = 1, aes(group = class))+
  scale_color_viridis_d()


```



```{R}
prep1<-dfwithclass[dfwithclass$CHELSA_Annual_Precipitation<400,]
prep1$prepcat <- 'less than 400'

prep2 <- dfwithclass[dfwithclass$CHELSA_Annual_Precipitation >=400 & dfwithclass$CHELSA_Annual_Precipitation < 800,]
prep2$prepcat <- '400 to 800'

prep3 <- dfwithclass[dfwithclass$CHELSA_Annual_Precipitation >=800 & dfwithclass$CHELSA_Annual_Precipitation < 1200, ]
prep3$prepcat <- '800 to 1200'
prep4 <- dfwithclass[dfwithclass$CHELSA_Annual_Precipitation >=1200 & dfwithclass$CHELSA_Annual_Precipitation < 2000,]
prep4$prepcat <- 'higher than 1200'


prep5 <- dfwithclass[dfwithclass$CHELSA_Annual_Precipitation >=2000 & dfwithclass$CHELSA_Annual_Precipitation <2500, ]
prep5$prepcat <- 'higher than 1200'

prep6 <- dfwithclass[dfwithclass$CHELSA_Annual_Precipitation >=2500, ]
prep6$prepcat <- 'higher than 1200'


newdata <- rbind(prep1, rbind(prep2, rbind(prep3, rbind(prep4, rbind(prep5, prep6)))))

newdata$prepcat <- factor(newdata$prepcat, levels = c('less than 400', '400 to 800', '800 to 1200', 'higher than 1200'))


ggplot(newdata, aes(x = SG_Soil_pH_H2O_0_100cm, y = prepcat, fill = class))+
  geom_density_ridges(rel_min_height = 0.01, alpha = 0.3)


ggplot(newdata, aes(x = SG_Soil_pH_H2O_0_100cm, fill = class))+
  geom_histogram(alpha = 0.5, position = 'identity')+
  geom_density(alpha = 0.2)+
  scale_fill_viridis_d()+
  facet_wrap(~prepcat, ncol = 1)


ggplot(newdata, aes(x = prepcat, y = SG_Soil_pH_H2O_0_100cm, color = class))+
  stat_summary(fun.data = 'mean_cl_boot', size = 1)+
  stat_summary(fun = mean, geom = 'line', size = 1, aes(group = class))+
  scale_color_viridis_d()


```












```{R}

ggplot(dfwithclass, aes(x = CHELSA_Annual_Mean_Temperature))+
  geom_histogram()



```


```{R}
temp1 <- dfwithclass[dfwithclass$CHELSA_Annual_Mean_Temperature<0, ]
temp1$tempcat <- 'less than 0'

temp2 <- dfwithclass[dfwithclass$CHELSA_Annual_Mean_Temperature>=0 & dfwithclass$CHELSA_Annual_Mean_Temperature<50, ]
temp2$tempcat <- '0 to 10'

temp3 <- dfwithclass[dfwithclass$CHELSA_Annual_Mean_Temperature>=50 & dfwithclass$CHELSA_Annual_Mean_Temperature<100, ]
temp3$tempcat <- '0 to 10'

temp4 <- dfwithclass[dfwithclass$CHELSA_Annual_Mean_Temperature >= 100 & dfwithclass$CHELSA_Annual_Mean_Temperature<150, ]
temp4$tempcat <- '10 to 20'

temp5 <- dfwithclass[dfwithclass$CHELSA_Annual_Mean_Temperature >= 150 & dfwithclass$CHELSA_Annual_Mean_Temperature <200, ]
temp5$tempcat <- '10 to 20'

temp6 <- dfwithclass[dfwithclass$CHELSA_Annual_Mean_Temperature >=200, ]
temp6$tempcat <- 'higher than 20'

newdata <- rbind(temp1, rbind(temp2, rbind(temp3, rbind(temp4, rbind(temp5, temp6)))))

newdata$tempcat <- factor(newdata$tempcat, levels = c('less than 0', '0 to 10', '10 to 20', 'higher than 20'))

ggplot(newdata, aes(x = log(CHELSA_Annual_Precipitation), y = tempcat, fill = class))+
  geom_density_ridges(rel_min_height = 0.01, alpha = 0.3)


ggplot(newdata, aes(x = log(CHELSA_Annual_Precipitation), fill = class))+
  geom_histogram(alpha = 0.5, position = 'identity', bins = 50)+
  scale_fill_viridis_d()+
  facet_wrap(~tempcat, ncol = 1)

ggplot(newdata, aes(x = tempcat, y = log(CHELSA_Annual_Precipitation), color = class))+
  stat_summary(fun.data = 'mean_cl_boot', size = 1)+
  stat_summary(fun = mean, geom = 'line', size = 1, aes(group = class))+
  scale_color_viridis_d()

```
```{R}
temp1 <- dfwithclass[dfwithclass$CHELSA_Annual_Mean_Temperature<0, ]
temp1$tempcat <- 'less than 0'

temp2 <- dfwithclass[dfwithclass$CHELSA_Annual_Mean_Temperature>=0 & dfwithclass$CHELSA_Annual_Mean_Temperature<50, ]
temp2$tempcat <- '0 to 10'

temp3 <- dfwithclass[dfwithclass$CHELSA_Annual_Mean_Temperature>=50 & dfwithclass$CHELSA_Annual_Mean_Temperature<100, ]
temp3$tempcat <- '0 to 10'

temp4 <- dfwithclass[dfwithclass$CHELSA_Annual_Mean_Temperature >= 100 & dfwithclass$CHELSA_Annual_Mean_Temperature<150, ]
temp4$tempcat <- '10 to 20'

temp5 <- dfwithclass[dfwithclass$CHELSA_Annual_Mean_Temperature >= 150 & dfwithclass$CHELSA_Annual_Mean_Temperature <200, ]
temp5$tempcat <- '10 to 20'

temp6 <- dfwithclass[dfwithclass$CHELSA_Annual_Mean_Temperature >=200, ]
temp6$tempcat <- 'higher than 20'

newdata <- rbind(temp1, rbind(temp2, rbind(temp3, rbind(temp4, rbind(temp5, temp6)))))

newdata$tempcat <- factor(newdata$tempcat, levels = c('less than 0', '0 to 10', '10 to 20', 'higher than 20'))

ggplot(newdata, aes(x = EarthEnvTopoMed_Elevation, y = tempcat, fill = class))+
  geom_density_ridges(rel_min_height = 0.01, alpha = 0.3)


ggplot(newdata, aes(x = EarthEnvTopoMed_Elevation, fill = class))+
  geom_histogram(alpha = 0.5, position = 'identity', bins = 50)+
  scale_fill_viridis_d()+
  facet_wrap(~tempcat, ncol = 1)

ggplot(newdata, aes(x = tempcat, y = EarthEnvTopoMed_Elevation, color = class))+
  stat_summary(fun.data = 'mean_cl_boot', size = 1)+
  stat_summary(fun = mean, geom = 'line', size = 1, aes(group = class))+
  scale_color_viridis_d()




```
















```{R}
ggplot(dfwithclass, aes(x = CHELSA_Mean_Temperature_of_Warmest_Quarter))+
  geom_histogram()


```


```{R}
warm1 <- dfwithclass[dfwithclass$CHELSA_Mean_Temperature_of_Warmest_Quarter < 150, ]
warm1$warmcat <- 'less than 15'



```











```{R}
temp1 <- dfwithclass[dfwithclass$CHELSA_Annual_Mean_Temperature<0, ]
temp1$tempcat <- 'less than 5'

temp2 <- dfwithclass[dfwithclass$CHELSA_Annual_Mean_Temperature>=0 & dfwithclass$CHELSA_Annual_Mean_Temperature<50, ]
temp2$tempcat <- 'less than 5'

temp3 <- dfwithclass[dfwithclass$CHELSA_Annual_Mean_Temperature>=50 & dfwithclass$CHELSA_Annual_Mean_Temperature<100, ]
temp3$tempcat <- '5 to 10'

temp4 <- dfwithclass[dfwithclass$CHELSA_Annual_Mean_Temperature >= 100 & dfwithclass$CHELSA_Annual_Mean_Temperature<150, ]
temp4$tempcat <- '10 to 15'

temp5 <- dfwithclass[dfwithclass$CHELSA_Annual_Mean_Temperature >= 150 & dfwithclass$CHELSA_Annual_Mean_Temperature <200, ]
temp5$tempcat <- '15 to 20'

temp6 <- dfwithclass[dfwithclass$CHELSA_Annual_Mean_Temperature >=200, ]
temp6$tempcat <- 'higher than 20'

newdata <- rbind(temp1, rbind(temp2, rbind(temp3, rbind(temp4, rbind(temp5, temp6)))))

newdata$tempcat <- factor(newdata$tempcat, levels = c('less than 5', '5 to 10', '10 to 15', '15 to 20', 'higher than 20'))

ggplot(newdata, aes(x = log(CHELSA_Precipitation_of_Driest_Quarter+1), y = tempcat, fill = class))+
  geom_density_ridges(rel_min_height = 0.01, alpha = 0.3)

ggplot(newdata, aes(x = log(CHELSA_Precipitation_of_Driest_Quarter+1), fill = class))+
  geom_histogram(alpha = 0.5, position = 'identity')+
  scale_fill_viridis_d()+
  facet_wrap(~tempcat, ncol = 1)



```





```{R}
temp1 <- dfwithclass[dfwithclass$CHELSA_Annual_Mean_Temperature<0, ]
temp1$tempcat <- 'less than 0'

temp2 <- dfwithclass[dfwithclass$CHELSA_Annual_Mean_Temperature>=0 & dfwithclass$CHELSA_Annual_Mean_Temperature<50, ]
temp2$tempcat <- '0 to 10'

temp3 <- dfwithclass[dfwithclass$CHELSA_Annual_Mean_Temperature>=50 & dfwithclass$CHELSA_Annual_Mean_Temperature<100, ]
temp3$tempcat <- '0 to 10'

temp4 <- dfwithclass[dfwithclass$CHELSA_Annual_Mean_Temperature >= 100 & dfwithclass$CHELSA_Annual_Mean_Temperature<150, ]
temp4$tempcat <- '10 to 20'

temp5 <- dfwithclass[dfwithclass$CHELSA_Annual_Mean_Temperature >= 150 & dfwithclass$CHELSA_Annual_Mean_Temperature <200, ]
temp5$tempcat <- '10 to 20'

temp6 <- dfwithclass[dfwithclass$CHELSA_Annual_Mean_Temperature >=200, ]
temp6$tempcat <- 'higher than 20'

newdata <- rbind(temp1, rbind(temp2, rbind(temp3, rbind(temp4, rbind(temp5, temp6)))))

newdata$tempcat <- factor(newdata$tempcat, levels = c('less than 0', '0 to 10', '10 to 20', 'higher than 20'))

ggplot(newdata, aes(x = Aridity_Index, y = tempcat, fill = class))+
  geom_density_ridges(rel_min_height = 0.01, alpha = 0.3)


ggplot(newdata, aes(x = Aridity_Index, fill = class))+
  geom_histogram(alpha = 0.5, position = 'identity', bins = 50)+
  scale_fill_viridis_d()+
  facet_wrap(~tempcat, ncol = 1)

ggplot(newdata, aes(x = tempcat, y = Aridity_Index, color = class))+
  stat_summary(fun.data = 'mean_cl_boot', size = 1)+
  stat_summary(fun = mean, geom = 'line', size = 1, aes(group = class))+
  scale_color_viridis_d()




```
```{R}
temp1 <- dfwithclass[dfwithclass$CHELSA_Annual_Mean_Temperature<0, ]
temp1$tempcat <- 'less than 0'

temp2 <- dfwithclass[dfwithclass$CHELSA_Annual_Mean_Temperature>=0 & dfwithclass$CHELSA_Annual_Mean_Temperature<50, ]
temp2$tempcat <- '0 to 10'

temp3 <- dfwithclass[dfwithclass$CHELSA_Annual_Mean_Temperature>=50 & dfwithclass$CHELSA_Annual_Mean_Temperature<100, ]
temp3$tempcat <- '0 to 10'

temp4 <- dfwithclass[dfwithclass$CHELSA_Annual_Mean_Temperature >= 100 & dfwithclass$CHELSA_Annual_Mean_Temperature<150, ]
temp4$tempcat <- '10 to 20'

temp5 <- dfwithclass[dfwithclass$CHELSA_Annual_Mean_Temperature >= 150 & dfwithclass$CHELSA_Annual_Mean_Temperature <200, ]
temp5$tempcat <- '10 to 20'

temp6 <- dfwithclass[dfwithclass$CHELSA_Annual_Mean_Temperature >=200, ]
temp6$tempcat <- 'higher than 20'

newdata <- rbind(temp1, rbind(temp2, rbind(temp3, rbind(temp4, rbind(temp5, temp6)))))

newdata$tempcat <- factor(newdata$tempcat, levels = c('less than 0', '0 to 10', '10 to 20', 'higher than 20'))

ggplot(newdata, aes(x = CHELSA_Precipitation_Seasonality, y = tempcat, fill = class))+
  geom_density_ridges(rel_min_height = 0.01, alpha = 0.3)


ggplot(newdata, aes(x = CHELSA_Precipitation_Seasonality, fill = class))+
  geom_histogram(alpha = 0.5, position = 'identity', bins = 50)+
  scale_fill_viridis_d()+
  facet_wrap(~tempcat, ncol = 1)

ggplot(newdata, aes(x = tempcat, y = CHELSA_Precipitation_Seasonality, color = class))+
  stat_summary(fun.data = 'mean_cl_boot', size = 1)+
  stat_summary(fun = mean, geom = 'line', size = 1, aes(group = class))+
  scale_color_viridis_d()




```


```{R}
temp1 <- dfwithclass[dfwithclass$CHELSA_Annual_Mean_Temperature<0, ]
temp1$tempcat <- 'less than 0'

temp2 <- dfwithclass[dfwithclass$CHELSA_Annual_Mean_Temperature>=0 & dfwithclass$CHELSA_Annual_Mean_Temperature<50, ]
temp2$tempcat <- '0 to 10'

temp3 <- dfwithclass[dfwithclass$CHELSA_Annual_Mean_Temperature>=50 & dfwithclass$CHELSA_Annual_Mean_Temperature<100, ]
temp3$tempcat <- '0 to 10'

temp4 <- dfwithclass[dfwithclass$CHELSA_Annual_Mean_Temperature >= 100 & dfwithclass$CHELSA_Annual_Mean_Temperature<150, ]
temp4$tempcat <- '10 to 20'

temp5 <- dfwithclass[dfwithclass$CHELSA_Annual_Mean_Temperature >= 150 & dfwithclass$CHELSA_Annual_Mean_Temperature <200, ]
temp5$tempcat <- '10 to 20'

temp6 <- dfwithclass[dfwithclass$CHELSA_Annual_Mean_Temperature >=200, ]
temp6$tempcat <- 'higher than 20'

newdata <- rbind(temp1, rbind(temp2, rbind(temp3, rbind(temp4, rbind(temp5, temp6)))))

newdata$tempcat <- factor(newdata$tempcat, levels = c('less than 0', '0 to 10', '10 to 20', 'higher than 20'))

ggplot(newdata, aes(x = SG_Sand_Content_0_100cm, y = tempcat, fill = class))+
  geom_density_ridges(rel_min_height = 0.01, alpha = 0.3)


ggplot(newdata, aes(x = SG_Sand_Content_0_100cm, fill = class))+
  geom_histogram(alpha = 0.5, position = 'identity', bins = 50)+
  scale_fill_viridis_d()+
  facet_wrap(~tempcat, ncol = 1)

ggplot(newdata, aes(x = tempcat, y = SG_Sand_Content_0_100cm, color = class))+
  stat_summary(fun.data = 'mean_cl_boot', size = 1)+
  stat_summary(fun = mean, geom = 'line', size = 1, aes(group = class))+
  scale_color_viridis_d()




```



```{R}
ggplot(dfwithclass, aes(x = CHELSA_Temperature_Seasonality, color = class))+
  geom_density(alpha = 0.4)

ggplot(dfwithclass, aes(x = CHELSA_Temperature_Seasonality, fill = class))+
  geom_histogram(alpha = 0.4, position = 'identity')+
  theme_classic()+
  scale_fill_viridis_d()
```
```{R}

ggplot(dfwithclass, aes(x = log(Aridity_Index), color = class))+
  geom_density(alpha = 0.4)


ggplot(dfwithclass, aes(x = log(Aridity_Index), fill = class))+
  geom_histogram(alpha = 0.4, position = 'identity')+
  theme_classic()





```
```{R}

ggplot(dfwithclass, aes(x = CHELSA_Mean_Temperature_of_Warmest_Quarter, color = class))+
  geom_density(alpha = 0.4)


ggplot(dfwithclass, aes(x = CHELSA_Mean_Temperature_of_Warmest_Quarter, fill = class))+
  geom_histogram(alpha = 0.4, position = 'identity')+
  theme_classic()+
  scale_fill_viridis_d()





```


```{R}

ggplot(dfwithclass, aes(x = CHELSA_Mean_Temperature_of_Coldest_Quarter, color = class))+
  geom_density(alpha = 0.4)


ggplot(dfwithclass, aes(x = CHELSA_Mean_Temperature_of_Coldest_Quarter, fill = class))+
  geom_histogram(alpha = 0.5, position = 'identity')+
  theme_classic()+
  scale_fill_viridis_d()


```










```{R}

ggplot(dfwithclass, aes(x = EarthEnvTopoMed_Elevation, color = class))+
  geom_density(alpha = 0.4)


```

```{R}

ggplot(dfwithclass, aes(x = SG_Sand_Content_0_100cm, color = class))+
  geom_density(alpha = 0.4)


ggplot(dfwithclass, aes(x = SG_Sand_Content_0_100cm, fill = class))+
  geom_histogram(alpha = 0.5, position = 'identity')+
  scale_fill_viridis_d()

```


```{R}

ggplot(dfwithclass, aes(x = log(CHELSA_Precipitation_of_Wettest_Quarter), color = class))+
  geom_density(alpha = 0.4)





ggplot(dfwithclass, aes(x = log(CHELSA_Precipitation_of_Wettest_Quarter), fill = class))+
  geom_histogram(position = 'identity', alpha = 0.4)+
  scale_fill_viridis_d()+
  theme_classic()

```



```{R}

ggplot(dfwithclass, aes(x = log(CHELSA_Precipitation_of_Driest_Quarter+1), color = class))+
  geom_density(alpha = 0.4)





ggplot(dfwithclass, aes(x = log(CHELSA_Precipitation_of_Driest_Quarter+1), fill = class))+
  geom_histogram(position = 'identity', alpha = 0.4)+
  scale_fill_viridis_d()+
  theme_classic()

```



```{R}

ggplot(dfwithclass, aes(x = CHELSA_Precipitation_Seasonality, color = class))+
  geom_density(alpha = 0.4)





ggplot(dfwithclass, aes(x = CHELSA_Precipitation_Seasonality, fill = class))+
  geom_histogram(position = 'identity', alpha = 0.4)+
  scale_fill_viridis_d()+
  theme_classic()

```


```{R}

ggplot(dfwithclass, aes(x = log(Human_Development_Percentage+1), color = class))+
  geom_density(alpha = 0.4)





ggplot(dfwithclass, aes(x = log(Human_Development_Percentage+1), fill = class))+
  geom_histogram(position = 'identity', alpha = 0.4)+
  scale_fill_viridis_d()+
  theme_classic()

```








