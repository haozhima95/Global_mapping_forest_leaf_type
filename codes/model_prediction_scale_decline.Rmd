---
title: "sample_size_standard_error"
author: "Haozhi Ma"
date: "8/9/2021"
output: html_document
---

This script is used for doing standard error of sample size decline.


Load the dataset


```{R}
dsr <- read.csv('C:\\Users\\haozh\\Desktop\\LL\\functional_type_grid_search\\sampled_model_prediction_20220824.csv')

#for(i in 2:10){
 # addon <- read.csv(paste0('C:\\Users\\haozh\\Desktop\\LL\\functional_type_grid_search\\cv_validation\\classifiedvalidation_fold_',i,'_ntree250_mtry30_minleaf20_dbh_full_var_recent_occurrence.csv'))
#  dsr <- rbind(dsr,addon)
#}

#dsr$needle <- dsr$needle_evergreen+dsr$needle_deciduous

#dsr$needle_pred <- dsr$nd_pred+dsr$ne_pred

dsr$n_prop_dbh <- dsr$ne_prop_dbh + dsr$nd_prop_dbh

dsr$n_pred <- dsr$ne_pred + dsr$nd_pred

#rfmodelprediction$be_pred <- rfmodelprediction$be_pred*100
#rfmodelprediction$bd_pred <- rfmodelprediction$bd_pred*100
#rfmodelprediction$n_pred <- rfmodelprediction$n_pred*100

#rfmodelprediction$obscat <- 0

dsr$be_prop_dbh <- dsr$be_prop_dbh*100

dsr$bd_prop_dbh <- dsr$bd_prop_dbh*100

dsr$n_prop_dbh <- dsr$n_prop_dbh*100

dsr$ne_prop_dbh <- dsr$ne_prop_dbh*100

dsr$nd_prop_dbh <- dsr$nd_prop_dbh*100

dsr$be_pred <- dsr$be_pred*100

dsr$bd_pred <- dsr$bd_pred*100

dsr$n_pred <- dsr$n_pred*100

dsr$ne_pred <- dsr$ne_pred*100

dsr$nd_pred <- dsr$nd_prop_dbh*100

dsr$obscat <- 0


#names(dsr)
```

```{R}

ndsr <- read.csv('C:\\Users\\haozh\\Desktop\\LL\\summary\\nd_sample_pred.csv')

head(ndsr)

```
Initiate the function


```{R}
std <- function(x) sd(x)/sqrt(length(x))


```


```{R}
broadevergreenstd <- data.frame(samplesize = double(),
                                standarderror = double(),
                                stringsAsFactors = FALSE)
broadevergreenpredstd <- data.frame(samplesize = double(),
                                 standarderror = double(),
                                 stringsAsFactors = FALSE)

broaddeciduousstd <- data.frame(samplesize = double(),
                                standarderror = double(),
                                stringsAsFactors = FALSE)
broaddeciduouspredstd <- data.frame(samplesize = double(),
                                    standarderor = double(),
                                    stringsAsFactors = FALSE)

nestd <- data.frame(samplesize = double(),
                        standarderror = double(),
                        stringsAsFactors = FALSE)

nepredstd <- data.frame(samplesize = double(),
                            standarderror = double(),
                            stringsAsFactors = FALSE)

ndstd <- data.frame(samplesize = double(),
                        standarderror = double(),
                        stringsAsFactors = FALSE)

ndpredstd <- data.frame(samplesize = double(),
                            standarderror = double(),
                            stringsAsFactors = FALSE)




nstd <- data.frame(samplesize = double(),
                        standarderror = double(),
                        stringsAsFactors = FALSE)

npredstd <- data.frame(samplesize = double(),
                            standarderror = double(),
                            stringsAsFactors = FALSE)

```


```{R}

vc <- sample.int(65535, 1000)
for(j in vc){
  set.seed(j)
  for(i in c(5,10,20,30,40,50,100,200,300,500,1000)){
    dsrowname <- sample(1:nrow(dsr), size = i)
    ds <- dsr[dsrowname,]
    #dsnd <- ndsr[dsrowname,]
    broadevergreenstd[nrow(broadevergreenstd)+1,]<-c(i, std(ds$be_prop_dbh))
    broadevergreenpredstd[NROW(broadevergreenpredstd)+1,]<-c(i, std(ds$be_pred))
    
    broaddeciduousstd[nrow(broaddeciduousstd)+1,]<-c(i, std(ds$bd_prop_dbh))
    broaddeciduouspredstd[nrow(broaddeciduouspredstd)+1,]<-c(i, std(ds$bd_pred))
    
    nestd[nrow(nestd)+1,]<-c(i, std(ds$ne_prop_dbh))
    nepredstd[nrow(nepredstd)+1,]<-c(i, std(ds$ne_pred))
    
    #ndstd[nrow(ndstd)+1,]<-c(i, std(dsnd$nd_prop_dbh))
    #ndpredstd[nrow(ndpredstd)+1,]<-c(i, std(dsnd$nd_pred_mean))
    
    
    nstd[nrow(nstd)+1,]<-c(i, std(ds$n_prop_dbh))
    npredstd[nrow(npredstd)+1,]<-c(i, std(ds$n_pred))
  }
}

vc <- sample.int(65535, 1000)
for(j in vc){
  set.seed(j)
  for(i in c(5,10,20,30,40,50,100,200,300,500,1000)){
    dsrowname <- sample(1:nrow(ndsr),size = i,replace = TRUE)
    ds <- ndsr[dsrowname,]
    
    ndstd[nrow(ndstd)+1,]<-c(i, std(ds$nd_prop_dbh))
    ndpredstd[nrow(ndpredstd)+1,]<-c(i, std(ds$nd_pred_mean))

    
    
  }
}
```



```{R}

head(broadevergreenstd)

```


```{R}
#broadevergreenstd$datasource <- 'observed'
#broadevergreenpredstd$datasource <- 'predicted'

#broadevergreenstd <- rbind(broadevergreenstd, broadevergreenpredstd)

#broaddeciduousstd$datasource <- 'observed'
#broaddeciduouspredstd$datasource <- 'predicted'

#broaddeciduousstd <- rbind(broaddeciduousstd, broaddeciduouspredstd)

#needlestd$datasource <- 'observed'
#needlepredstd$datasource <- 'predicted'

#needlestd <- rbind(needlestd, needlepredstd)



bestd <- aggregate(broadevergreenstd[,2],list(broadevergreenstd$samplesize),median)

head(bestd)
names(bestd)<-c('samplesize','standarderror')
bestd$datasource <- 'observed'


bepredstd <- aggregate(broadevergreenpredstd[,2],list(broadevergreenpredstd$samplesize),median)
head(bepredstd)
names(bepredstd)<- c('samplesize','standarderror')
bepredstd$datasource <- 'predicted'

bestd <- rbind(bestd, bepredstd)



bdstd <- aggregate(broaddeciduousstd[,2], list(broaddeciduousstd$samplesize),median)
names(bdstd)<-c('samplesize','standarderror')
bdstd$datasource <- 'observed'

bdpredstd <- aggregate(broaddeciduouspredstd[,2], list(broaddeciduouspredstd$samplesize),median)
names(bdpredstd)<-c('samplesize', 'standarderror')
bdpredstd$datasource <- 'predicted'

bdstd <- rbind(bdstd, bdpredstd)


nestd <- aggregate(nestd[,2],list(nestd$samplesize),median)
names(nestd)<-c('samplesize','standarderror')
nestd$datasource <- 'observed'


nepredstd <- aggregate(nepredstd[,2],list(nepredstd$samplesize),median)
names(nepredstd)<-c('samplesize','standarderror')
nepredstd$datasource <- 'predicted'

nestd <- rbind(nestd, nepredstd)





ndstd <- aggregate(ndstd[,2],list(ndstd$samplesize),median)
names(ndstd)<-c('samplesize','standarderror')
ndstd$datasource <- 'observed'


ndpredstd <- aggregate(ndpredstd[,2],list(ndpredstd$samplesize),median)
names(ndpredstd)<-c('samplesize','standarderror')
ndpredstd$datasource <- 'predicted'

ndstd <- rbind(ndstd, ndpredstd)




nstd <- aggregate(nstd[,2],list(nstd$samplesize),median)
names(nstd)<-c('samplesize','standarderror')
nstd$datasource <- 'observed'


npredstd <- aggregate(npredstd[,2],list(npredstd$samplesize),median)
names(npredstd)<-c('samplesize','standarderror')
npredstd$datasource <- 'predicted'

nstd <- rbind(nstd, npredstd)




```


```{R}
library(ggplot2)

p4<-ggplot(data = bestd, aes(x = samplesize, y = standarderror,color = datasource))+
  geom_point(size = 2)+
  #geom_smooth(se = FALSE)
  geom_smooth(method = 'glm',se = FALSE,method.args = list(family = gaussian(link = '1/mu^2')),size = 1.5)+
  theme_classic()+
  labs(x = 'Sample size', y = 'Standard error \n(Functional type coverage in %)')+
  guides(color = guide_legend(title = 'Data source'))+
  scale_color_viridis_d()+
  theme(axis.title = element_text(size = 20), axis.text.x = element_text(size = 20), axis.text.y = element_text(size = 20),
        legend.title = element_text(size = 20), legend.text = element_text(size = 20),legend.position = c(0.8,0.8))

```


```{R}
library(ggplot2)

p5<-ggplot(data = bdstd, aes(x = samplesize, y = standarderror,color = datasource))+
  geom_point(size = 2)+
  #geom_smooth(se = FALSE)
  geom_smooth(method = 'glm',se = FALSE,method.args = list(family = gaussian(link = '1/mu^2')),size = 1.5)+
  theme_classic()+
  labs(x = 'Sample size', y = 'Standard error \n(Functional type coverage in %)')+
  guides(color = guide_legend(title = 'Data source'))+
  scale_color_viridis_d()+
  theme(axis.title = element_text(size = 20), axis.text.x = element_text(size = 20), axis.text.y = element_text(size = 20),
        legend.title = element_text(size = 20), legend.text = element_text(size = 20),legend.position = c(0.8,0.8))

```





```{R}
library(ggplot2)

p6<-ggplot(data = nestd, aes(x = samplesize, y = standarderror,color = datasource))+
  geom_point(size = 2)+
  #geom_smooth(se = FALSE)
  geom_smooth(method = 'glm',se = FALSE,method.args = list(family = gaussian(link = '1/mu^2')),size = 1.5)+
  theme_classic()+
  labs(x = 'Sample size', y = 'Standard error \n(Functional type coverage in %)')+
  guides(color = guide_legend(title = 'Data source'))+
  scale_color_viridis_d()+
  theme(axis.title = element_text(size = 20), axis.text.x = element_text(size = 20), axis.text.y = element_text(size = 20),
        legend.title = element_text(size = 20), legend.text = element_text(size = 20),legend.position = c(0.8,0.8))

```


```{R}
library(ggplot2)

p7<-ggplot(data = ndstd, aes(x = samplesize, y = standarderror,color = datasource))+
  geom_point(size = 2)+
  #geom_smooth(se = FALSE)
  geom_smooth(method = 'glm',se = FALSE,method.args = list(family = gaussian(link = '1/mu^2')),size = 1.5)+
  theme_classic()+
  labs(x = 'Sample size', y = 'Standard error \n(Functional type coverage in %)')+
  guides(color = guide_legend(title = 'Data source'))+
  scale_color_viridis_d()+
  theme(axis.title = element_text(size = 20), axis.text.x = element_text(size = 20), axis.text.y = element_text(size = 20),
        legend.title = element_text(size = 20), legend.text = element_text(size = 20),legend.position = c(0.8,0.8))

```

```{R}
library(ggplot2)

p8<-ggplot(data = nstd, aes(x = samplesize, y = standarderror,color = datasource))+
  geom_point(size = 2)+
  #geom_smooth(se = FALSE)
  geom_smooth(method = 'glm',se = FALSE,method.args = list(family = gaussian(link = '1/mu^2')),size = 1.5)+
  theme_classic()+
  labs(x = 'Sample size', y = 'Standard error \n(Functional type coverage in %)')+
  guides(color = guide_legend(title = 'Data source'))+
  scale_color_viridis_d()+
  theme(axis.title = element_text(size = 20), axis.text.x = element_text(size = 20), axis.text.y = element_text(size = 20),
        legend.title = element_text(size = 20), legend.text = element_text(size = 20),legend.position = c(0.8,0.8))

```


```{R}

rfmodelprediction <- read.csv('C:\\Users\\haozh\\Desktop\\LL\\functional_type_grid_search\\cv_validation\\classifiedvalidation_fold_1_ntree250_mtry30_minleaf20_dbh_full_var_recent_occurrence.csv')

for(i in 2:10){
  addon <- read.csv(paste0('C:\\Users\\haozh\\Desktop\\LL\\functional_type_grid_search\\cv_validation\\classifiedvalidation_fold_',i,'_ntree250_mtry30_minleaf20_dbh_full_var_recent_occurrence.csv'))
  rfmodelprediction <- rbind(rfmodelprediction,addon)
}

head(rfmodelprediction)

names(rfmodelprediction)
```


```{R}

library(ggplot2)


```


```{R}
rfmodelprediction$n_prop_dbh <- rfmodelprediction$ne_prop_dbh + rfmodelprediction$nd_prop_dbh

rfmodelprediction$n_pred <- rfmodelprediction$ne_pred + rfmodelprediction$nd_pred

#rfmodelprediction$be_pred <- rfmodelprediction$be_pred*100
#rfmodelprediction$bd_pred <- rfmodelprediction$bd_pred*100
#rfmodelprediction$n_pred <- rfmodelprediction$n_pred*100

#rfmodelprediction$obscat <- 0

rfmodelprediction$be_prop_dbh <- rfmodelprediction$be_prop_dbh*100

rfmodelprediction$bd_prop_dbh <- rfmodelprediction$bd_prop_dbh*100

rfmodelprediction$n_prop_dbh <- rfmodelprediction$n_prop_dbh*100

rfmodelprediction$be_pred <- rfmodelprediction$be_pred*100

rfmodelprediction$bd_pred <- rfmodelprediction$bd_pred*100

rfmodelprediction$n_pred <- rfmodelprediction$n_pred*100

rfmodelprediction$obscat <- 0


```


```{R}

obintervals <- seq(from = 0, to = 100, by = 10)

intervalname <- c('0~10', '10~20', '20~30', '30~40', '40~50', '50~60', '60~70', '70~80', '80~90', '90~100')


```


```{R}

for(i in 1:10){
  rfmodelprediction[rfmodelprediction$be_prop_dbh>=obintervals[i] & rfmodelprediction$be_prop_dbh<obintervals[i+1],]$obscat <- intervalname[i]
}


rfmodelprediction[rfmodelprediction$be_prop_dbh == 100,]$obscat <- intervalname[10]

```

```{R}

head(rfmodelprediction[,c('be_prop_dbh', 'be_pred', 'obscat')])

```

```{R}

p1<-ggplot(rfmodelprediction, aes(x = obscat, y = be_pred))+
  geom_boxplot(size = 1.2, outlier.shape = NA)+
  scale_y_continuous(limits = c(0,100))+
  coord_flip()+
  theme_classic()+
  theme(axis.title = element_text(size = 20), axis.text.x = element_text(size = 20), axis.text.y = element_text(size = 20),
        legend.title = element_text(size = 20), legend.text = element_text(size = 20),legend.position = c(0.8,0.8))


```



```{R}

for(i in 1:10){
  rfmodelprediction[rfmodelprediction$bd_prop_dbh>=obintervals[i] & rfmodelprediction$bd_prop_dbh<obintervals[i+1],]$obscat <- intervalname[i]
}


rfmodelprediction[rfmodelprediction$bd_prop_dbh == 100,]$obscat <- intervalname[10]

```

```{R}

head(rfmodelprediction[,c('bd_prop_dbh', 'bd_pred', 'obscat')])

```



```{R}

p2<-ggplot(rfmodelprediction, aes(x = obscat, y = bd_pred))+
  geom_boxplot(size = 1.2, outlier.shape = NA)+
  scale_y_continuous(limits = c(0,100))+
  coord_flip()+
  theme_classic()+
  theme(axis.title = element_text(size = 20), axis.text.x = element_text(size = 20), axis.text.y = element_text(size = 20),
        legend.title = element_text(size = 20), legend.text = element_text(size = 20),legend.position = c(0.8,0.8))


```

```{R}

for(i in 1:10){
  rfmodelprediction[rfmodelprediction$n_prop_dbh>=obintervals[i] & rfmodelprediction$n_prop_dbh<obintervals[i+1],]$obscat <- intervalname[i]
}


rfmodelprediction[rfmodelprediction$n_prop_dbh == 100,]$obscat <- intervalname[10]

```

```{R}

head(rfmodelprediction[,c('n_prop_dbh', 'n_pred', 'obscat')])

```



```{R}

p3<-ggplot(rfmodelprediction, aes(x = obscat, y = n_pred))+
  geom_boxplot(size = 1.2, outlier.shape = NA)+
  scale_y_continuous(limits = c(0,100))+
  coord_flip()+
  theme_classic()+
  theme(axis.title = element_text(size = 20), axis.text.x = element_text(size = 20), axis.text.y = element_text(size = 20),
        legend.title = element_text(size = 20), legend.text = element_text(size = 20),legend.position = c(0.8,0.8))


```













```{R}

library(ggpubr)


ggarrange(p1,p2,p3,
          p4,p5,p6,
          labels = c('A','B' ,'C', 'D', 'E', 'F'),
        font.label = list(face = 'bold',color = 'black',size = 20),
        ncol = 3,
        nrow = 2)



ggarrange(p4,p5,p6,p7,
          labels = c('A', 'B', 'C', 'D'),
          font.label = list(face = 'bold',color = 'black',size = 20),
        ncol = 2,
        nrow = 2)



```







