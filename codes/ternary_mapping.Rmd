---
title: "mapping_point_ternary"
author: "Haozhi Ma"
date: "7/13/2021"
output: html_document
---




```{R}
require(ggplot2)
require(tidyverse)
require(Hmisc)
require(car)
require(data.table)
require(ggbiplot)
library(dplyr)
library(tricolore)
#library(ggtern)


```



Load teh dataset

```{R}

df.fft <- read.csv('C:\\Users\\haozh\\Desktop\\LL\\functional_type_grid_search\\df_with_covariate_pixel_aggregate_20210722.csv')


head(df.fft)

names(df.fft)




df.fft$broad <- df.fft$broad_evergreen + df.fft$broad_deciduous

df.fft$needle <- df.fft$needle_deciduous + df.fft$needle_evergreen

df.fft$evergreen <- df.fft$broad_evergreen + df.fft$needle_evergreen

df.fft$deciduous <- df.fft$broad_deciduous + df.fft$needle_deciduous


df.fft$petprep <- df.fft$PET - df.fft$CHELSA_Annual_Precipitation

```


```{R}

tric_dat <- Tricolore(df.fft, 
                      p1 = 'broad_evergreen',
                      p2 = 'broad_deciduous',
                      p3 = 'needle',
                      center = NA,
                      crop = FALSE,
                      show_center = FALSE,
                      hue = 0,
                      contrast = 0.7,
                      spread = 1,
                      lightness = 0.7,
                      chroma = 1,
                      #values = c("#D53E4F", "#F46D43", "#FEE08B", "#FFFFBF",  "#ABDDA4",  "#3288BD"),
                      label_as = 'pct')


df.fft$functionrgb <- tric_dat$rgb



```






```{R}
world <- map_data("world")
worldplot <- ggplot() +
  borders('world', colour = 'grey40', fill = 'grey40')+
  geom_point(data = df.fft, aes(x = longitude, y = latitude, color = functionrgb),size = 0.5, shape = 15)+
  scale_color_identity()+
  coord_fixed(1.3)+
  annotation_custom(
    ggplotGrob(tric_dat$key+labs(L = 'broad_evergreen', T = 'broad_deciduous', R = 'needle')), xmin = -190, xmax = -100, ymin = -60, ymax = 30)
  #plotTheme
worldplot

```




```{R}
w= 0.003 * (max(df.fft$longitude)-min(df.fft$longitude))
h= 0.003 * (max(df.fft$latitude)-min(df.fft$latitude))

library(ggtern)
#memory.limit(size = 4e7)
world <- map_data("world")
ggplot(df.fft, aes(x = round(longitude,4), y = round(latitude,4), fill = functionrgb)) +
  borders('world', colour = 'grey40', fill = 'grey40')+ 
  #geom_tile(width = w/2, height = h)+
  #scale_fill_identity()+
  #scale_fill_viridis_c()+
  coord_fixed(1.3)+
  annotation_custom(
    ggplotGrob(tric_dat$key+labs(L = 'broad_evergreen', T = 'broad_deciduous', R = 'needle')), xmin = -180, xmax = -100, ymin = -60, ymax = 30)+
  theme(legend.position = 'none')


```

```{R}

for(i in 0:24){


ric_dat <- Tricolore(df.fft, 
                      p1 = 'broad_evergreen',
                      p2 = 'deciduous',
                      p3 = 'needle_evergreen',
                      center = NA,
                      crop = FALSE,
                      show_center = FALSE,
                      hue = i/24,
                      contrast = 0.7,
                      spread = 1,
                      lightness = 0.7,
                      chroma = 1,
                      #values = c("#D53E4F", "#F46D43", "#FEE08B", "#FFFFBF",  "#ABDDA4",  "#3288BD"),
                      label_as = 'pct')


df.fft$functionrgb <- tric_dat$rgb



#world <- map_data("world")
print(ggplot(df.fft, aes(x = round(longitude,4), y = round(latitude,4), fill = ric_dat)) +
  borders('world', colour = 'grey40', fill = 'grey40')+ 
  #geom_tile(width = w/2, height = h)+
  #scale_fill_identity()+
  #scale_fill_viridis_c()+
  coord_fixed(1.3)+
  labs(title = i)+
  annotation_custom(
    ggplotGrob(tric_dat$key+labs(L = 'broad_evergreen', T = 'deciduous', R = 'needle_evergreen')), xmin = -180, xmax = -100, ymin = -60, ymax = 30)+
  theme(legend.position = 'none')
)

}

```







```{R}
library(raster)
library(rgdal)

```


```{R}
t1 <- stack('C:\\Users\\haozh\\Desktop\\LL\\mapping\\functional_types\\fft_probability_1.tif')
str(t1)
```


```{R}
t1[[2]]

```



```{R}

plot(t1[[2]])


```

```{R}

library(tricolore)


tricol <- Tricolore(t1, 
                    t1$be_pred,
                    t1$deci_pred,
                    t1$ne_pred,
                    center = NA,
                    crop = FALSE,
                    show_center = FALSE,
                    hue = 0,
                    contrast = 0.7,
                    spread = 1,
                    lightness = 0.7,
                    chroma = 1,
                    #values = c("#D53E4F", "#F46D43", "#FEE08B", "#FFFFBF",  "#ABDDA4",  "#3288BD"),
                    label_as = 'pct')


t1$functionrgb <- tric_dat$rgb
```



```{R}
require(Ternary)


```


```{R}

TernaryCoords(0,0,100)
TernaryPlot(alab = 'Broadleaf evergreen', blab = 'Deciduous', clab = 'Needleleaf evergreen')

values <- TernaryPointValues(rgb, resolution = 100)
ColorTernary(values,spectrum = NULL)


```




















