---
title: "play_with_GFBI"
author: "Haozhi Ma"
date: "9/8/2020"
output: html_document
---

This script is used for playing species reference list with GFBI dataset.

Load the Best match.


```{R}
library(feather)

```

```{R}
bestmatchtpl<-read_feather('C:\\Users\\haozh\\Desktop\\LL\\GFBI_data\\BEST_MATCH_all_species_TPL.feather')

#feather_metadata('C:\\Users\\haozh\\Desktop\\LL\\GFBI_data\\BEST_MATCH_all_species_TPL.feather')
head(bestmatchtpl,n = 15L)

summary(bestmatchtpl$tax_level)
```

Load the GFBI rarefied dataset.

```{R}

gfrare <- read.csv('C:\\Users\\haozh\\Desktop\\LL\\GFBI_data\\GFBI_rarefied.csv')
tail(gfrare,n = 10L)
nrow(gfrare)
```




Try left join getting the information of the right species names.


```{R}
library(plyr)
correctgf<-join(gfrare,bestmatchtpl, by = 'raw_name')
#head(correctgf)

correctgf<-subset(correctgf, select = -c(tax_species,
                                         tax_level,
                                         raw_name))
head(correctgf,n = 10L)


```
Load leaf type information and check its species names

```{R}
leaftypedic <- read.csv('C:\\Users\\haozh\\Desktop\\LL\\Dictionary_leaftype_20210520_with_datasetid.csv')

names(leaftypedic)<- c('X', 'raw_name', 'ObsDataID', 'TraitName', 'OriglName', 'leaftype', 'DatasetID_leaftype')

nrow(leaftypedic)

leaftypedic <- leaftypedic[!duplicated(leaftypedic$raw_name),]
head(leaftypedic)
nrow(leaftypedic)
```

```{R}
correctleaftypedic <- join(leaftypedic, bestmatchtpl, by = 'raw_name')
correctleaftypedic <- subset(correctleaftypedic, select = -c(raw_name))
head(correctleaftypedic)
nrow(correctleaftypedic)
correctleaftypedic <- correctleaftypedic[!duplicated(correctleaftypedic$accepted_bin),]
nrow(correctleaftypedic)
```
```{R}
correctleaftypegenusdic<-subset(correctleaftypedic, select = -c(X, ObsDataID, OriglName, accepted_bin, tax_species, match_source,  tax_level))
head(correctleaftypegenusdic)
nrow(correctleaftypegenusdic)
correctleaftypegenusdic <- correctleaftypegenusdic[!duplicated(correctleaftypegenusdic$tax_genus),]
nrow(correctleaftypegenusdic)
names(correctleaftypegenusdic) <- c('TraitName', 'leaftype_genus', 'DatasetID_leaftype', 'tax_genus')
head(correctleaftypegenusdic)
```
```{R}
write.csv(correctleaftypedic, 'c:\\Users\\haozh\\Desktop\\LL\\dictionary_leaftype_spp_correctname_20210521.csv')
write.csv(correctleaftypegenusdic, 'C:\\Users\\haozh\\Desktop\\LL\\dictionary_leaftype_genus_correctname_20210521.csv')

```



Same with leaf habit information


```{R}
# Load the dictionary first
 phenodic <- read.csv('C:\\Users\\haozh\\Desktop\\LL\\leaf_habit_dictionary_witt_datasetid.csv')
#phenodic<-read.csv('C:\\Users\\haozh\\Desktop\\LL\\dictionary_leaf_phenology_spp.csv')
names(phenodic)<-c('X', 'Unnamed..0','raw_name','genus','OrigValueStr','DatasetID')
head(phenodic,n = 10L)

```

Leftjoin

```{R}
correctdic<-join(phenodic,bestmatchtpl, by = 'raw_name')
correctdic<-subset(correctdic, select = -c(raw_name,
                                           Unnamed..0))
```


```{R}
head(correctdic, n = 10L)
nrow(correctdic[correctdic$accepted_bin==NaN,])
nrow(correctdic)
```


Output the dictionary


```{R}
write.csv(correctdic, 'C:\\Users\\haozh\\Desktop\\LL\\dictionary_leaf_phenology_spp_correctname_20210514.csv')

```



Add the genus dictionary


```{R}

sppdic<-read.csv('C:\\Users\\haozh\\Desktop\\LL\\dictionary_leaf_phenology_spp_correctname_unique_20210514.csv')
sppdic<-subset(sppdic, select = -c(tax_genus))
head(sppdic)
genusdic<-read.csv('C:\\Users\\haozh\\Desktop\\LL\\genus_dictionary_20200910.csv')
names(genusdic)<-c('tax_genus','Unnamed..0','OrigValueStr_genus','tax_level')

head(genusdic,n = 10L)

nrow(genusdic[genusdic$OrigValueStr_genus == 1,])/nrow(genusdic)

nrow(genusdic[genusdic$OrigValueStr_genus == 0,])/nrow(genusdic)


```





```{R}
nrow(correctgf)
head(correctgf)
```
To reduce computation pressure, splitting our dataset into different parts. 

```{R}
subcorrectgf1<-correctgf[1:500000,]
head(subcorrectgf1)

subcorrectgf2<-correctgf[500001:1000000,]

subcorrectgf3<-correctgf[1000001:1500000,]

subcorrectgf4<-correctgf[1500001:2000000,]

subcorrectgf5<-correctgf[2000001:2500000,]

subcorrectgf6<-correctgf[2500001:nrow(correctgf),]

```






Leftjoin OrigValueStr

```{R}

correctplot1 <- join(subcorrectgf1,sppdic, by = 'accepted_bin')
# correctplot1 <- join(correctplot1, correctleaftypedic, by = "accepted_bin")
nrow(correctplot1)
head(correctplot1)

```

```{R}

correctplot1 <- join(correctplot1, genusdic, by = 'tax_genus')
nrow(correctplot1)


head(correctplot1)
```

```{R}
is.na(correctplot1[1,'OrigValueStr'])
correctplot1[1,'OrigValueStr']
```


```{R}
for(i in 1:nrow(correctplot1)){
  if(is.na(correctplot1[i,'OrigValueStr'])){
    correctplot1[i,'OrigValueStr'] <- correctplot1[i,'OrigValueStr_genus']
  }
}
head(correctplot1)

```




```{R}

head(correctplot1,20L)

```









```{R}

correctplot2 <- join(subcorrectgf2,sppdic, by = 'accepted_bin')
nrow(correctplot2)
head(correctplot2)

```

```{R}

correctplot2 <- join(correctplot2, genusdic, by = 'tax_genus')
nrow(correctplot2)
head(correctplot2)
```

```{R}
for(i in 1:nrow(correctplot2)){
  if(is.na(correctplot2[i,'OrigValueStr'])){
    correctplot2[i,'OrigValueStr'] <- correctplot2[i,'OrigValueStr_genus']
  }
}
head(correctplot2)

```



```{R}

correctplot3 <- join(subcorrectgf3,sppdic, by = 'accepted_bin')
nrow(correctplot3)
head(correctplot3)
```

```{R}


correctplot3 <- join(correctplot3, genusdic, by = 'tax_genus')
nrow(correctplot3)
head(correctplot3)
```


```{R}
for(i in 1:nrow(correctplot3)){
  if(is.na(correctplot3[i,'OrigValueStr'])){
    correctplot3[i,'OrigValueStr'] <- correctplot3[i,'OrigValueStr_genus']
  }
}
head(correctplot3)

```


```{R}

correctplot4 <- join(subcorrectgf4,sppdic, by = 'accepted_bin')
nrow(correctplot4)
head(correctplot4)
```



```{R}

correctplot4 <- join(correctplot4, genusdic, by = 'tax_genus')
nrow(correctplot4)
head(correctplot4)
```


```{R}
for(i in 1:nrow(correctplot4)){
  if(is.na(correctplot4[i,'OrigValueStr'])){
    correctplot4[i,'OrigValueStr'] <- correctplot4[i,'OrigValueStr_genus']
  }
}
head(correctplot4)

```



```{R}

correctplot5 <- join(subcorrectgf5,sppdic, by = 'accepted_bin')
nrow(correctplot5)
head(correctplot5)

```

```{R}
correctplot5 <- join(correctplot5, genusdic, by = 'tax_genus')
nrow(correctplot5)
head(correctplot5)
```

```{R}
for(i in 1:nrow(correctplot5)){
  if(is.na(correctplot5[i,'OrigValueStr'])){
    correctplot5[i,'OrigValueStr'] <- correctplot5[i,'OrigValueStr_genus']
  }
}
head(correctplot5)

```


```{R}

correctplot6 <- join(subcorrectgf6,sppdic, by = 'accepted_bin')
nrow(correctplot6)
head(correctplot6)
```


```{R}

correctplot6 <- join(correctplot6, genusdic, by = 'tax_genus')
nrow(correctplot6)
head(correctplot6)
```


```{R}
for(i in 1:nrow(correctplot6)){
  if(is.na(correctplot6[i,'OrigValueStr'])){
    correctplot6[i,'OrigValueStr'] <- correctplot6[i,'OrigValueStr_genus']
  }
}
head(correctplot6)

```

Look at the data structure and try to delete some columns


```{R}


plotwithhabit1<-subset(correctplot1, select = -c(tax_level,
                                               tax_level,
                                               Unnamed..0,
                                               match_source,
                                               Unnamed..0
                                               ))
plotwithhabit1 <- subset(plotwithhabit1, select = -c(tax_level,
                                                     Unnamed..0))

head(plotwithhabit1)
```

```{R}


plotwithhabit2<-subset(correctplot2, select = -c(tax_level,
                                               tax_level,
                                               Unnamed..0,
                                               Unnamed..0,
                                               match_source))
plotwithhabit2 <- subset(plotwithhabit2, select = -c(tax_level,
                                                     Unnamed..0))


head(plotwithhabit2)
```


```{R}


plotwithhabit3<-subset(correctplot3, select = -c(tax_level,
                                               tax_level,
                                               Unnamed..0,
                                               Unnamed..0,
                                               match_source))
plotwithhabit3 <- subset(plotwithhabit3, select = -c(tax_level,
                                                     Unnamed..0))

head(plotwithhabit3)
```


```{R}


plotwithhabit4<-subset(correctplot4, select = -c(tax_level,
                                               tax_level,
                                               Unnamed..0,
                                               Unnamed..0,
                                               match_source))
plotwithhabit4 <- subset(plotwithhabit4, select = -c(tax_level,
                                                     Unnamed..0))

head(plotwithhabit4)
```


```{R}


plotwithhabit5<-subset(correctplot5, select = -c(tax_level,
                                               tax_level,
                                               Unnamed..0,
                                               Unnamed..0,
                                               match_source))
plotwithhabit5 <- subset(plotwithhabit5, select = -c(tax_level,
                                                     Unnamed..0))

head(plotwithhabit5)
```


```{R}


plotwithhabit6<-subset(correctplot6, select = -c(tax_level,
                                               tax_level,
                                               Unnamed..0,
                                               Unnamed..0,
                                               match_source))
plotwithhabit6 <- subset(plotwithhabit6, select = -c(tax_level,
                                                     Unnamed..0))

head(plotwithhabit6)
```

```{R}
plotwithtype1<-join(plotwithhabit1, correctleaftypedic, by = 'accepted_bin')
plotwithtype1 <- subset(plotwithtype1, select = -c(tax_level,
                                                   tax_species,
                                                   match_source,
                                                   OriglName,
                                                   TraitName,
                                                   X))
plotwithtype1 <- plotwithtype1[,-18]
head(plotwithtype1)
```
```{R}
plotwithtypewithgenus1 <- join(plotwithtype1, correctleaftypegenusdic, by = 'tax_genus')
plotwithtypewithgenus1 <- plotwithtypewithgenus1[,c(-20,-18)]
head(plotwithtypewithgenus1)

```

```{R}
for(i in 1:nrow(plotwithtypewithgenus1)){
  if(is.na(plotwithtypewithgenus1[i,'leaftype'])){
    plotwithtypewithgenus1[i,'leaftype'] <- plotwithtypewithgenus1[i,'leaftype_genus']
  }
}
head(plotwithtypewithgenus1)



```

```{R}
plotwithtype2<-join(plotwithhabit2, correctleaftypedic, by = 'accepted_bin')
plotwithtype2 <- subset(plotwithtype2, select = -c(tax_level,
                                                   tax_species,
                                                   match_source,
                                                   OriglName,
                                                   TraitName,
                                                   X))
plotwithtype2 <- plotwithtype2[,-18]
head(plotwithtype2)
```
```{R}
plotwithtypewithgenus2 <- join(plotwithtype2, correctleaftypegenusdic, by = 'tax_genus')
plotwithtypewithgenus2 <- plotwithtypewithgenus2[,c(-20,-18)]
head(plotwithtypewithgenus2)

```

```{R}
for(i in 1:nrow(plotwithtypewithgenus2)){
  if(is.na(plotwithtypewithgenus2[i,'leaftype'])){
    plotwithtypewithgenus2[i,'leaftype'] <- plotwithtypewithgenus2[i,'leaftype_genus']
  }
}
head(plotwithtypewithgenus2)



```


```{R}
plotwithtype3<-join(plotwithhabit3, correctleaftypedic, by = 'accepted_bin')
plotwithtype3 <- subset(plotwithtype3, select = -c(tax_level,
                                                   tax_species,
                                                   match_source,
                                                   OriglName,
                                                   TraitName,
                                                   X))
plotwithtype3 <- plotwithtype3[,-18]
head(plotwithtype3)
```
```{R}
plotwithtypewithgenus3 <- join(plotwithtype3, correctleaftypegenusdic, by = 'tax_genus')
plotwithtypewithgenus3 <- plotwithtypewithgenus3[,c(-20,-18)]
head(plotwithtypewithgenus3)

```

```{R}
for(i in 1:nrow(plotwithtypewithgenus3)){
  if(is.na(plotwithtypewithgenus3[i,'leaftype'])){
    plotwithtypewithgenus3[i,'leaftype'] <- plotwithtypewithgenus3[i,'leaftype_genus']
  }
}
head(plotwithtypewithgenus3)



```


```{R}
plotwithtype4<-join(plotwithhabit4, correctleaftypedic, by = 'accepted_bin')
plotwithtype4 <- subset(plotwithtype4, select = -c(tax_level,
                                                   tax_species,
                                                   match_source,
                                                   OriglName,
                                                   TraitName,
                                                   X))
plotwithtype4 <- plotwithtype4[,-18]
head(plotwithtype4)
```
```{R}
plotwithtypewithgenus4 <- join(plotwithtype4, correctleaftypegenusdic, by = 'tax_genus')
plotwithtypewithgenus4 <- plotwithtypewithgenus4[,c(-20,-18)]
head(plotwithtypewithgenus4)

```

```{R}
for(i in 1:nrow(plotwithtypewithgenus4)){
  if(is.na(plotwithtypewithgenus4[i,'leaftype'])){
    plotwithtypewithgenus4[i,'leaftype'] <- plotwithtypewithgenus4[i,'leaftype_genus']
  }
}
head(plotwithtypewithgenus4)



```

```{R}
plotwithtype5<-join(plotwithhabit5, correctleaftypedic, by = 'accepted_bin')
plotwithtype5 <- subset(plotwithtype5, select = -c(tax_level,
                                                   tax_species,
                                                   match_source,
                                                   OriglName,
                                                   TraitName,
                                                   X))
plotwithtype5 <- plotwithtype5[,-18]
head(plotwithtype5)
```
```{R}
plotwithtypewithgenus5 <- join(plotwithtype5, correctleaftypegenusdic, by = 'tax_genus')
plotwithtypewithgenus5 <- plotwithtypewithgenus5[,c(-20,-18)]
head(plotwithtypewithgenus5)

```

```{R}
for(i in 1:nrow(plotwithtypewithgenus5)){
  if(is.na(plotwithtypewithgenus5[i,'leaftype'])){
    plotwithtypewithgenus5[i,'leaftype'] <- plotwithtypewithgenus5[i,'leaftype_genus']
  }
}
head(plotwithtypewithgenus5)



```


```{R}
plotwithtype6<-join(plotwithhabit6, correctleaftypedic, by = 'accepted_bin')
plotwithtype6 <- subset(plotwithtype6, select = -c(tax_level,
                                                   tax_species,
                                                   match_source,
                                                   OriglName,
                                                   TraitName,
                                                   X))
plotwithtype6 <- plotwithtype6[,-18]
head(plotwithtype6)
```
```{R}
plotwithtypewithgenus6 <- join(plotwithtype6, correctleaftypegenusdic, by = 'tax_genus')
plotwithtypewithgenus6 <- plotwithtypewithgenus6[,c(-20,-18)]
head(plotwithtypewithgenus6)

```

```{R}
for(i in 1:nrow(plotwithtypewithgenus6)){
  if(is.na(plotwithtypewithgenus6[i,'leaftype'])){
    plotwithtypewithgenus6[i,'leaftype'] <- plotwithtypewithgenus6[i,'leaftype_genus']
  }
}
head(plotwithtypewithgenus6)



```




Aggregate them all


```{R}

allplotwithhabittype<-rbind(plotwithtypewithgenus1,rbind(plotwithtypewithgenus2,rbind(plotwithtypewithgenus3,rbind(plotwithtypewithgenus4,rbind(plotwithtypewithgenus5,plotwithtypewithgenus6)))))


nrow(allplotwithhabittype)


```


Outputting dataset

```{R}
write.csv(allplotwithhabittype, 'C:\\Users\\haozh\\Desktop\\LL\\GFBI_data\\raregfdata_with_habit_type_20211208.csv')

```



