---
title: "semivariance_occurrence"
author: "Haozhi Ma"
date: "6/5/2022"
output: html_document
---

Firstly load the data
```{R}
library(sp)

library(spatstat)

library(gstat)

library(geoR)

library(ncf)

library(spdep)

library(boot)

```



```{R}
dsr <- read.csv('C:\\Users\\haozh\\Desktop\\LL\\functional_type_grid_search\\cv_validation\\classifiedvalidation_fold_1_ntree250_mtry20_minleaf15_dbh_full_var_recent_occurrence.csv')

for(i in 2:10){
  addon <- read.csv(paste0('C:\\Users\\haozh\\Desktop\\LL\\functional_type_grid_search\\cv_validation\\classifiedvalidation_fold_',i,'_ntree250_mtry20_minleaf15_dbh_full_var_recent_occurrence.csv'))
  dsr <- rbind(dsr,addon)
}

names(dsr)

```

```{R}

head(dsr,10L)

#names(dsr)
```



```{R}

df10m <- read.csv('C:\\Users\\haozh\\Desktop\\LL\\spatial_cv\\Spatial_CV_Leafh_Haibt_PredObs_10m_20220515.csv')

df50 <- read.csv('C:\\Users\\haozh\\Desktop\\LL\\spatial_cv\\Spatial_CV_Leafh_Haibt_PredObs_50000m_20220515.csv')

df100 <- read.csv('C:\\Users\\haozh\\Desktop\\LL\\spatial_cv\\Spatial_CV_Leafh_Haibt_PredObs_100000m_20220515.csv')

df200 <- read.csv('C:\\Users\\haozh\\Desktop\\LL\\spatial_cv\\Spatial_CV_Leafh_Haibt_PredObs_200000m_20220515.csv')


df300 <- read.csv('C:\\Users\\haozh\\Desktop\\LL\\spatial_cv\\Spatial_CV_Leafh_Haibt_PredObs_300000m_20220515.csv')

df500 <- read.csv('C:\\Users\\haozh\\Desktop\\LL\\spatial_cv\\Spatial_CV_Leafh_Haibt_PredObs_500000m_20220515.csv')


```




```{R}
names(df10m)

```



```{R}
head(df10m,10L)


```


```{R}

dsr$resi_be <- dsr$be_pred - dsr$be_prop_dbh
dsr$resi_bd <- dsr$bd_pred - dsr$bd_prop_dbh
dsr$resi_ne <- dsr$ne_pred - dsr$ne_prop_dbh
dsr$resi_nd <- dsr$nd_pred - dsr$nd_prop_dbh

df10m$resi_be <- df10m$be_pred - df10m$be_prop_dbh
df10m$resi_bd <- df10m$bd_pred - df10m$bd_prop_dbh
df10m$resi_ne <- df10m$ne_pred - df10m$ne_prop_dbh
df10m$resi_nd <- df10m$nd_pred - df10m$nd_prop_dbh


df50$resi_be <- df50$be_pred - df50$be_prop_dbh
df50$resi_bd <- df50$bd_pred - df50$bd_prop_dbh
df50$resi_ne <- df50$ne_pred - df50$ne_prop_dbh
df50$resi_nd <- df50$nd_pred - df50$nd_prop_dbh



df100$resi_be <- df100$be_pred - df100$be_prop_dbh
df100$resi_bd <- df100$bd_pred - df100$bd_prop_dbh
df100$resi_ne <- df100$ne_pred - df100$ne_prop_dbh
df100$resi_nd <- df100$nd_pred - df100$nd_prop_dbh



df200$resi_be <- df200$be_pred - df200$be_prop_dbh
df200$resi_bd <- df200$bd_pred - df200$bd_prop_dbh
df200$resi_ne <- df200$ne_pred - df200$ne_prop_dbh
df200$resi_nd <- df200$nd_pred - df200$nd_prop_dbh



df300$resi_be <- df300$be_pred - df300$be_prop_dbh
df300$resi_bd <- df300$bd_pred - df300$bd_prop_dbh
df300$resi_ne <- df300$ne_pred - df300$ne_prop_dbh
df300$resi_nd <- df300$nd_pred - df300$nd_prop_dbh


df500$resi_be <- df500$be_pred - df500$be_prop_dbh
df500$resi_bd <- df500$bd_pred - df500$bd_prop_dbh
df500$resi_ne <- df500$ne_pred - df500$ne_prop_dbh
df500$resi_nd <- df500$nd_pred - df500$nd_prop_dbh




```





initiate the function

```{R}
bc_mean <- function(ds){
  return(1-sqrt(ds$be_prop_dbh*ds$be_mean)-sqrt(ds$bd_prop_dbh*ds$bd_mean)-sqrt(ds$ne_prop_dbh*ds$ne_mean)-sqrt(ds$nd_prop_dbh*ds$nd_mean))
}

bc_model <- function(ds){
  return(1-sqrt(ds$be_prop_dbh*ds$be_pred)-sqrt(ds$bd_prop_dbh*ds$bd_pred)-sqrt(ds$ne_prop_dbh*ds$ne_pred)-sqrt(ds$nd_prop_dbh*ds$nd_pred))
}


coef_rel <- function(bcmodel, bcmean){
  return(1-sum(bcmodel)/sum(bcmean))
}



```



```{R}

dfbemean <- mean(dsr$be_prop_dbh)
dfbdmean <- mean(dsr$bd_prop_dbh)
dfnemean <- mean(dsr$ne_prop_dbh)
dfndmean <- mean(dsr$nd_prop_dbh)


dsr$be_mean <- dfbemean
dsr$bd_mean <- dfbdmean
dsr$ne_mean <- dfnemean
dsr$nd_mean <- dfndmean


dfbemean <- mean(df10m$be_prop_dbh)
dfbdmean <- mean(df10m$bd_prop_dbh)
dfnemean <- mean(df10m$ne_prop_dbh)
dfndmean <- mean(df10m$nd_prop_dbh)


df10m$be_mean <- dfbemean
df10m$bd_mean <- dfbdmean
df10m$ne_mean <- dfnemean
df10m$nd_mean <- dfndmean


dfbemean <- mean(df50$be_prop_dbh)
dfbdmean <- mean(df50$bd_prop_dbh)
dfnemean <- mean(df50$ne_prop_dbh)
dfndmean <- mean(df50$nd_prop_dbh)


df50$be_mean <- dfbemean
df50$bd_mean <- dfbdmean
df50$ne_mean <- dfnemean
df50$nd_mean <- dfndmean




dfbemean <- mean(df100$be_prop_dbh)
dfbdmean <- mean(df100$bd_prop_dbh)
dfnemean <- mean(df100$ne_prop_dbh)
dfndmean <- mean(df100$nd_prop_dbh)


df100$be_mean <- dfbemean
df100$bd_mean <- dfbdmean
df100$ne_mean <- dfnemean
df100$nd_mean <- dfndmean




dfbemean <- mean(df200$be_prop_dbh)
dfbdmean <- mean(df200$bd_prop_dbh)
dfnemean <- mean(df200$ne_prop_dbh)
dfndmean <- mean(df200$nd_prop_dbh)


df200$be_mean <- dfbemean
df200$bd_mean <- dfbdmean
df200$ne_mean <- dfnemean
df200$nd_mean <- dfndmean




dfbemean <- mean(df300$be_prop_dbh)
dfbdmean <- mean(df300$bd_prop_dbh)
dfnemean <- mean(df300$ne_prop_dbh)
dfndmean <- mean(df300$nd_prop_dbh)


df300$be_mean <- dfbemean
df300$bd_mean <- dfbdmean
df300$ne_mean <- dfnemean
df300$nd_mean <- dfndmean



dfbemean <- mean(df500$be_prop_dbh)
dfbdmean <- mean(df500$bd_prop_dbh)
dfnemean <- mean(df500$ne_prop_dbh)
dfndmean <- mean(df500$nd_prop_dbh)


df500$be_mean <- dfbemean
df500$bd_mean <- dfbdmean
df500$ne_mean <- dfnemean
df500$nd_mean <- dfndmean





dsr$bcmean <- bc_mean(dsr)

dsr$bcmodel <- bc_model(dsr)

df10m$bcmean <- bc_mean(df10m)

df10m$bcmodel <- bc_model(df10m)


df50$bcmean <- bc_mean(df50)

df50$bcmodel <- bc_model(df50)

df100$bcmean <- bc_mean(df100)

df100$bcmodel <- bc_model(df100)

df200$bcmean <- bc_mean(df200)

df200$bcmodel <- bc_model(df200)



df300$bcmean <- bc_mean(df300)

df300$bcmodel <- bc_model(df300)


df500$bcmean <- bc_mean(df500)

df500$bcmodel <- bc_model(df500)



```


```{R}

coef_rel(dsr$bcmodel, dsr$bcmean)

coef_rel(df10m$bcmodel, df10m$bcmean)


coef_rel(df50$bcmodel, df50$bcmean)

coef_rel(df100$bcmodel, df100$bcmean)

coef_rel(df200$bcmodel, df200$bcmean)

coef_rel(df300$bcmodel, df300$bcmean)

coef_rel(df500$bcmodel, df500$bcmean)

```





```{R}

coordinates(dsr) <- ~LON + LAT
proj4string(dsr) <- CRS("+init=epsg:4326")



coordinates(df10m) <- ~longitude + latitude
proj4string(df10m) <- CRS("+init=epsg:4326")

coordinates(df50) <- ~longitude + latitude
proj4string(df50) <- CRS("+init=epsg:4326")


coordinates(df100) <- ~longitude + latitude
proj4string(df100) <- CRS("+init=epsg:4326")


coordinates(df200) <- ~longitude + latitude
proj4string(df200) <- CRS("+init=epsg:4326")


coordinates(df300) <- ~longitude + latitude
proj4string(df300) <- CRS("+init=epsg:4326")


coordinates(df500) <- ~longitude + latitude
proj4string(df500) <- CRS("+init=epsg:4326")

```




```{R}
vcloud.be.kfold<-variogram(resi_be~1, data = dsr, cloud = F, cutoff = 1000, width = 8)
vcloud.be.kfold$class <- 'lookfold'
```

```{R}
plot(vcloud.be.kfold)

```


```{R}
vcloud.bd.kfold<-variogram(resi_bd~1, data = dsr, cloud = F, cutoff = 1000, width = 8)
vcloud.bd.kfold$class <- 'lookfold'
```

```{R}
plot(vcloud.bd.kfold)

```

```{R}
vcloud.ne.kfold<-variogram(resi_ne~1, data = dsr, cloud = F, cutoff = 1000, width = 8)
vcloud.ne.kfold$class <- 'lookfold'
```

```{R}
plot(vcloud.ne.kfold)

```


```{R}
vcloud.nd.kfold<-variogram(resi_nd~1, data = dsr, cloud = F, cutoff = 1000, width = 8)
vcloud.nd.kfold$class <- 'lookfold'
```

```{R}
plot(vcloud.nd.kfold)

```





```{R}
vcloud.be.10m<-variogram(resi_be~1, data = df10m, cloud = F, cutoff = 1000, width = 8)
vcloud.be.10m$class <- 'loo10m'
```

```{R}
plot(vcloud.be.10m)

```



```{R}
vcloud.bd.10m<-variogram(resi_bd~1, data = df10m, cloud = F, cutoff = 1000, width = 8)
vcloud.bd.10m$class <- 'loo10m'
```

```{R}
plot(vcloud.bd.10m)

```


```{R}
vcloud.ne.10m<-variogram(resi_ne~1, data = df10m, cloud = F, cutoff = 1000, width = 8)
vcloud.ne.10m$class <- 'loo10m'
```

```{R}
plot(vcloud.ne.10m)

```

```{R}
vcloud.nd.10m<-variogram(resi_nd~1, data = df10m, cloud = F, cutoff = 1000, width = 8)
vcloud.nd.10m$class <- 'loo10m'
```

```{R}
plot(vcloud.nd.10m)

```







```{R}
vcloud.be.50km<-variogram(resi_be~1, data = df50, cloud = F, cutoff = 1000, width = 8)
vcloud.be.50km$class <- 'loo50km'
```

```{R}
plot(vcloud.be.50km)

```


```{R}
vcloud.bd.50km<-variogram(resi_bd~1, data = df50, cloud = F, cutoff = 1000, width = 8)
vcloud.bd.50km$class <- 'loo50km'
```

```{R}
plot(vcloud.bd.50km)

```


```{R}
vcloud.ne.50km<-variogram(resi_ne~1, data = df50, cloud = F, cutoff = 1000, width = 8)
vcloud.ne.50km$class <- 'loo50km'
```

```{R}
plot(vcloud.ne.50km)

```



```{R}
vcloud.nd.50km<-variogram(resi_nd~1, data = df50, cloud = F, cutoff = 1000, width = 8)
vcloud.nd.50km$class <- 'loo50km'
```

```{R}
plot(vcloud.nd.50km)

```






```{R}
vcloud.be.100km<-variogram(resi_be~1, data = df100, cloud = F, cutoff = 1000, width = 8)
vcloud.be.100km$class <- 'loo100km'
```

```{R}
plot(vcloud.be.100km)

```
```{R}
vcloud.bd.100km<-variogram(resi_bd~1, data = df100, cloud = F, cutoff = 1000, width = 8)
vcloud.bd.100km$class <- 'loo100km'
```

```{R}
plot(vcloud.bd.100km)

```


```{R}
vcloud.ne.100km<-variogram(resi_ne~1, data = df100, cloud = F, cutoff = 1000, width = 8)
vcloud.ne.100km$class <- 'loo100km'
```

```{R}
plot(vcloud.ne.100km)

```
```{R}
vcloud.nd.100km<-variogram(resi_nd~1, data = df100, cloud = F, cutoff = 1000, width = 8)
vcloud.nd.100km$class <- 'loo100km'
```

```{R}
plot(vcloud.nd.100km)

```

```{R}

vcloud.be.200km<-variogram(resi_be~1, data = df200, cloud = F, cutoff = 1000, width = 8)
vcloud.be.200km$class <- 'loo200km'

```

```{R}
plot(vcloud.be.200km)

```


```{R}

vcloud.bd.200km<-variogram(resi_bd~1, data = df200, cloud = F, cutoff = 1000, width = 8)
vcloud.bd.200km$class <- 'loo200km'

```

```{R}
plot(vcloud.bd.200km)

```


```{R}

vcloud.ne.200km<-variogram(resi_ne~1, data = df200, cloud = F, cutoff = 1000, width = 8)
vcloud.ne.200km$class <- 'loo200km'

```

```{R}
plot(vcloud.ne.200km)

```

```{R}

vcloud.nd.200km<-variogram(resi_nd~1, data = df200, cloud = F, cutoff = 1000, width = 8)
vcloud.nd.200km$class <- 'loo200km'

```

```{R}
plot(vcloud.nd.200km)

```

```{R}

vcloud.be.300km<-variogram(resi_be~1, data = df300, cloud = F, cutoff = 1000, width = 8)
vcloud.be.300km$class <- 'loo300km'

```

```{R}
plot(vcloud.be.300km)

```


```{R}

vcloud.bd.300km<-variogram(resi_bd~1, data = df300, cloud = F, cutoff = 1000, width = 8)
vcloud.bd.300km$class <- 'loo300km'

```

```{R}
plot(vcloud.bd.300km)

```


```{R}

vcloud.ne.300km<-variogram(resi_ne~1, data = df300, cloud = F, cutoff = 1000, width = 8)
vcloud.ne.300km$class <- 'loo300km'

```

```{R}
plot(vcloud.ne.300km)

```

```{R}

vcloud.nd.300km<-variogram(resi_nd~1, data = df300, cloud = F, cutoff = 1000, width = 8)
vcloud.nd.300km$class <- 'loo300km'

```

```{R}
plot(vcloud.nd.300km)

```

```{R}

vcloud.be.500km<-variogram(resi_be~1, data = df500, cloud = F, cutoff = 1000, width = 8)
vcloud.be.500km$class <- 'loo500km'

```

```{R}
plot(vcloud.be.500km)

```


```{R}

vcloud.bd.500km<-variogram(resi_bd~1, data = df500, cloud = F, cutoff = 1000, width = 8)
vcloud.bd.500km$class <- 'loo500km'

```

```{R}
plot(vcloud.bd.500km)

```


```{R}

vcloud.ne.500km<-variogram(resi_ne~1, data = df500, cloud = F, cutoff = 1000, width = 8)
vcloud.ne.500km$class <- 'loo500km'

```

```{R}
plot(vcloud.ne.500km)

```

```{R}

vcloud.nd.500km<-variogram(resi_nd~1, data = df500, cloud = F, cutoff = 1000, width = 8)
vcloud.nd.500km$class <- 'loo500km'

```

```{R}
plot(vcloud.nd.500km)

```


```{R}
semibeall<-rbind(vcloud.be.kfold,rbind(vcloud.be.10m,rbind(vcloud.be.50km,rbind(vcloud.be.100km, rbind(vcloud.be.200km, rbind(vcloud.be.300km, vcloud.be.500km))))))

head(semibeall)

semibeall$class <- factor(semibeall$class, levels = c('lookfold', 'loo10m', 'loo50km', 'loo100km', 'loo200km', 'loo300km', 'loo500km'))



semibdall<-rbind(vcloud.bd.kfold,rbind(vcloud.bd.10m,rbind(vcloud.bd.50km,rbind(vcloud.bd.100km, rbind(vcloud.bd.200km, rbind(vcloud.bd.300km, vcloud.bd.500km))))))

head(semibdall)

semibdall$class <- factor(semibdall$class, levels = c('lookfold', 'loo10m', 'loo50km', 'loo100km', 'loo200km', 'loo300km', 'loo500km'))


semineall<-rbind(vcloud.ne.kfold,rbind(vcloud.ne.10m,rbind(vcloud.ne.50km,rbind(vcloud.ne.100km, rbind(vcloud.ne.200km, rbind(vcloud.ne.300km,vcloud.ne.500km))))))

head(semineall)

semineall$class <- factor(semineall$class, levels = c('lookfold', 'loo10m', 'loo50km', 'loo100km', 'loo200km', 'loo300km', 'loo500km'))



semindall<-rbind(vcloud.nd.kfold,rbind(vcloud.nd.10m,rbind(vcloud.nd.50km,rbind(vcloud.nd.100km, rbind(vcloud.nd.200km, rbind(vcloud.nd.300km, vcloud.nd.500km))))))

head(semindall)

semindall$class <- factor(semindall$class, levels = c('lookfold', 'loo10m', 'loo50km', 'loo100km', 'loo200km', 'loo300km', 'loo500km'))

```




```{R}
library(ggplot2)
ggplot(data = semibeall, aes(x = dist, y = gamma, color = class))+
  geom_smooth(method = 'loess', se = FALSE, size = 2, span = 0.3)+
  theme_classic()+
  #scale_y_continuous(limits = c(0,400))+
  labs(x = 'Distance (km)', y = 'Semivariance')+
  scale_color_viridis_d()+
  theme(axis.title = element_text(size = 20), axis.text.x = element_text(size = 20,color = 'black'), axis.text.y = element_text(size = 20, colour = 'black'),
        legend.title = element_blank(), legend.text = element_text(size = 20))


ggplot(data = semibdall, aes(x = dist, y = gamma, color = class))+
  geom_smooth(method = 'loess', se = FALSE, size = 2, span = 0.3)+
  theme_classic()+
  #scale_y_continuous(limits = c(0,400))+
  labs(x = 'Distance (km)', y = 'Semivariance')+
  scale_color_viridis_d()+
  theme(axis.title = element_text(size = 20), axis.text.x = element_text(size = 20,color = 'black'), axis.text.y = element_text(size = 20, colour = 'black'),
        legend.title = element_blank(), legend.text = element_text(size = 20))



ggplot(data = semineall, aes(x = dist, y = gamma, color = class))+
  geom_smooth(method = 'loess', se = FALSE, size = 2, span = 0.3)+
  theme_classic()+
  #scale_y_continuous(limits = c(0,400))+
  labs(x = 'Distance (km)', y = 'Semivariance')+
  scale_color_viridis_d()+
  theme(axis.title = element_text(size = 20), axis.text.x = element_text(size = 20,color = 'black'), axis.text.y = element_text(size = 20, colour = 'black'),
        legend.title = element_blank(), legend.text = element_text(size = 20))




ggplot(data = semindall, aes(x = dist, y = gamma, color = class))+
  geom_smooth(method = 'loess', se = FALSE, size = 2, span = 0.3)+
  theme_classic()+
  #scale_y_continuous(limits = c(0,400))+
  labs(x = 'Distance (km)', y = 'Semivariance')+
  scale_color_viridis_d()+
  theme(axis.title = element_text(size = 20), axis.text.x = element_text(size = 20,color = 'black'), axis.text.y = element_text(size = 20, colour = 'black'),
        legend.title = element_blank(), legend.text = element_text(size = 20))



```













