---
title: "bc_trial"
author: "Haozhi Ma"
date: "6/15/2021"
output: html_document
---


# BC calculation

This script is used for initiate a BC function to assess the model accuracy


Load the dataset

```{R}
dsr <- read.csv('C:\\Users\\haozh\\Desktop\\LL\\modelprediction\\modelcomparison_dfrfstem_subtallo_20221010.csv')

#for(i in 2:10){
#  addon <- read.csv(paste0('C:\\Users\\haozh\\Desktop\\LL\\functional_type_grid_search\\cv_validation\\classifiedvalidation_fold_',i,'_ntree250_mtry20_minleaf20_dbh_full_var_recent_occurrence_20221010.csv'))
#  dsr <- rbind(dsr,addon)
#}



#names(dsr)
```






```{R}
#dfwithpred <- read.csv('C:\\Users\\haozh\\Desktop\\LL\\functional_type_grid_search\\df_with_pred_ntree10_var8_coefficient_trial.csv')


dfwithpred <- dsr

dfwithpred$n_prop_stem <- dfwithpred$ne_prop_stem + dfwithpred$nd_prop_stem
dfwithpred$n_pred_mean <- dfwithpred$ne_pred_mean + dfwithpred$ne_pred_mean


names(dfwithpred)
```

```{R}
#dfwithpred$be_obs <- dfwithpred$broad_evergreen/100.0
#dfwithpred$bd_obs <- dfwithpred$broad_deciduous/100.0
#dfwithpred$ne_obs <- dfwithpred$needle/100.0
#dfwithpred$nd_obs <- dfwithpred$needle_deciduous/100.0




```


Calculate the mean of all the proportions across all the points


```{R}
dfbemean <- mean(dfwithpred$be_prop_stem)
dfbdmean <- mean(dfwithpred$bd_prop_stem)
dfnemean <- mean(dfwithpred$ne_prop_stem)
dfndmean <- mean(dfwithpred$nd_prop_stem)
dfnmean <- mean(dfwithpred$n_prop_stem)

dfwithpred$be_mean <- dfbemean
dfwithpred$bd_mean <- dfbdmean
dfwithpred$ne_mean <- dfnemean
dfwithpred$nd_mean <- dfndmean

dfwithpred$n_mean <- dfnmean


```

initiate the function

```{R}
bc_mean <- function(ds){
  return(sqrt(ds$be_prop_stem*ds$be_mean)+sqrt(ds$bd_prop_stem*ds$bd_mean)+sqrt(ds$ne_prop_stem*ds$ne_mean)+sqrt(ds$nd_prop_stem*ds$nd_mean))
}

bc_model <- function(ds){
  return(sqrt(ds$be_prop_stem*ds$be_pred_mean)+sqrt(ds$bd_prop_stem*ds$bd_pred_mean)+sqrt(ds$ne_prop_stem*ds$ne_pred_mean)+sqrt(ds$nd_prop_stem*ds$nd_pred_mean))
}


```


```{R}
dfwithpred$bcmean <- bc_mean(dfwithpred)

dfwithpred$bcmodel <- bc_model(dfwithpred)

#View(dfwithpred)


```


Initiate a function for calculating RelRMSE


```{R}
coef_rel <- function(bcmodel, bcmean){
  return(sum(bcmodel-bcmean)/sum(1-bcmean))
}


```

```{R}
coef_rel(dfwithpred$bcmodel, dfwithpred$bcmean)

```

Another pathway, that we could get the averaged deviation of all the pixels for each functional type.

define the deviation function

```{R}
avedev <- function(x, y){
  return(mean(abs(x - y)))
}


```

```{R}

avedev(dfwithpred$be_obs, dfwithpred$be_pred)

avedev(dfwithpred$bd_obs, dfwithpred$bd_pred)

avedev(dfwithpred$ne_obs, dfwithpred$n_pred)

#avedev(dfwithpred$nd_obs, dfwithpred$nd_pred)
```

A general pathway, to caclulate all the coefficient of determining vairations. 


```{R}
coef_det <- function(xtrue, xpred){
    return(1-sum((xtrue-xpred)^2)/sum((xtrue-mean(xtrue))^2))
}


```


```{R}
coef_det(dfwithpred$be_prop_dbh, dfwithpred$be_pred)
coef_det(dfwithpred$bd_prop_dbh, dfwithpred$bd_pred)
coef_det(dfwithpred$ne_prop_dbh, dfwithpred$ne_pred)
coef_det(dfwithpred$nd_prop_dbh, dfwithpred$nd_pred)

```




Another pathway, that we get the deviation of all the categories in one pixel and averaged by pixel number.

Define the deviation function

```{R}
catdev <- function(ds){
  return(mean((abs(ds$be_pred - ds$be_obs)+abs(ds$bd_pred - ds$bd_obs)+abs(ds$n_pred - ds$ne_obs))/2))
}


catmeandev <- function(ds){
  return(mean((abs(ds$be_mean - ds$be_obs)+abs(ds$bd_mean - ds$bd_obs)+abs(ds$ne_mean - ds$ne_obs))/2))
}



```


```{R}

catdev(dfwithpred)

catmeandev(dfwithpred)


1-catdev(dfwithpred)/catmeandev(dfwithpred)

```


```{R}
catdev <- function(ds){
  return(mean(sqrt((ds$be_pred - ds$be_obs)^2+(ds$bd_pred - ds$bd_obs)^2+(ds$n_pred - ds$ne_obs)^2)/2))
}


catmeandev <- function(ds){
  return(mean(sqrt((ds$be_mean - ds$be_obs)^2+(ds$bd_mean - ds$bd_obs)^2+(ds$ne_mean - ds$ne_obs)^2)/2))
}



```




```{R}

catdev(dfwithpred)

catmeandev(dfwithpred)


1-catdev(dfwithpred)/catmeandev(dfwithpred)

```



An even more native way




```{R}

dfwithpred$allmin <- pmin(dfwithpred$be_pred, dfwithpred$be_obs) + pmin(dfwithpred$bd_pred , dfwithpred$bd_obs) + pmin(dfwithpred$n_pred, dfwithpred$ne_obs)


#pmin(dfwithpred$be_pred, dfwithpred$be_obs)
mean(dfwithpred$allmin)

```








