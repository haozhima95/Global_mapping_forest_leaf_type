---
title: "play_with_ternaryplot"
author: "Haozhi Ma"
date: "7/12/2021"
output: html_document
---

Load teh dataset

```{R}

df.fft <- read.csv('C:\\Users\\haozh\\Desktop\\LL\\functional_type_grid_search\\df_withenv_dbh_20211208.csv')


head(df.fft)

names(df.fft)


df.fft$broad <- df.fft$broad_evergreen + df.fft$broad_deciduous

#df.fft$needle <- df.fft$needle_deciduous + df.fft$needle_evergreen

#df.fft$evergreen <- df.fft$broad_evergreen + df.fft$needle_evergreen

#df.fft$deciduous <- df.fft$broad_deciduous + df.fft$needle_deciduous

#df.fft$petprep <- df.fft$PET - df.fft$CHELSA_Annual_Precipitation


df.fft$type <- 'nn'


subdf0 <- df.fft[df.fft$broad_evergreen>df.fft$broad_deciduous & df.fft$broad_evergreen > df.fft$needle,]
subdf0$type <- 'be'


subdf1 <- df.fft[df.fft$broad_evergreen <= df.fft$broad_deciduous & df.fft$broad_deciduous > df.fft$needle,]
subdf1$type <- 'bd'


subdf2 <- df.fft[df.fft$broad_evergreen <= df.fft$needle & df.fft$broad_deciduous <= df.fft$needle,]
subdf2$type <- 'n'



df.fft <- rbind(subdf0,rbind(subdf1,subdf2))

```



```{R}
library(compositions)
data(SimulatedAmounts)
plot(acomp(sa.lognormals),axes=TRUE)
ternaryAxis(side=1:3,at=1:9/10,
            labels=expression(9:1,4:1,7:3,3:2,1:1,2:3,3:7,1:4,1:9),
            pos=0,col.axis="red",col.lab="green")

#ternaryAxis(side=1:3,pos=0,col.axis="red",col.lab="green")
```




```{R}
#library(geofi)
#> 
#> geofi R package: tools for open GIS data for Finland.
#> Part of rOpenGov <ropengov.org>.
#library(dplyr)
#> 
#> Attaching package: 'dplyr'
#> The following objects are masked from 'package:stats':
#> 
#>     filter, lag
#> The following objects are masked from 'package:base':
#> 
#>     intersect, setdiff, setequal, union
#library(tidyr)
library(ggplot2)
library(tricolore)


```





```{R}
tric_dat <- Tricolore(df.fft, 
                      p1 = 'broad_evergreen',
                      p2 = 'broad_deciduous',
                      p3 = 'needle',
                      center = NA,
                      crop = FALSE,
                      show_center = FALSE,
                      hue = 0,
                      contrast = 0.7,
                      spread = 1,
                      lightness = 0.7,
                      chroma = 1,
                      #values = c("#D53E4F", "#F46D43", "#FEE08B", "#FFFFBF",  "#ABDDA4",  "#3288BD"),
                      label_as = 'pct')


df.fft$functionrgb <- tric_dat$rgb

```



```{R}
#library(ggtern)
ggplot2::ggplot(df.fft, aes(x = CHELSA_Annual_Mean_Temperature, y = CHELSA_Annual_Precipitation))+
  geom_point(alpha = 0.4)+
  scale_color_identity()
  #annotation_custom(
   # ggplotGrob(tric_dat$key+labs(L = 'broad_evergreen', T = 'broad_deciduous', R = 'needle_evergreen')), xmin = -200, xmax = 0, ymin = 2000, ymax = 6000)


```



```{R}
require(ggplot2)
#require(tidyverse)
#require(Hmisc)
#require(car)
#require(data.table)
require(ggbiplot)
#library(dplyr)
plotTheme = theme(#legend.position = 'none',#legend.position = c(0.9, 0.2),
                  legend.background = element_rect(fill = NA, size = 0.5, linetype = 'solid'),
                  legend.text = element_text(color = 'black'),
                  panel.grid.major = element_blank(),
                  panel.grid.minor = element_blank(),
                  panel.background = element_rect(color = 'black', size = 1, fill = 'black'))

```



Load teh dataset

```{R}

df.fft <- read.csv('C:\\Users\\haozh\\Desktop\\LL\\functional_type_grid_search\\df_withenv_dbh_with_fold_20211208.csv')


head(df.fft)

names(df.fft)


#df.fft$broad <- df.fft$broad_evergreen + df.fft$broad_deciduous

#df.fft$needle <- df.fft$needle_deciduous + df.fft$needle_evergreen

#df.fft$evergreen <- df.fft$broad_evergreen + df.fft$needle_evergreen

#df.fft$deciduous <- df.fft$broad_deciduous + df.fft$needle_deciduous

```

```{R}
VariablesVectorSub = c('CHELSA_Mean_Temperature_of_Coldest_Quarter',
                       'CHELSA_Annual_Precipitation',
                       'CHELSA_Precipitation_of_Driest_Quarter',
                       #'CHELSA_Temperature_Seasonality',
                       #'CHELSA_Precipitation_Seasonality',
                       'Aridity_Index',
                       'SG_Sand_Content_0_100cm',
                       #'CHELSA_Mean_Temperature_of_Warmest_Quarter',
                       'SG_Soil_pH_H2O_0_100cm',
                       'cnRatio')
                       #'soil_moisture',
                       #'soil_nitrogen'



```


```{R}

PCAdata <- df.fft[, VariablesVectorSub]

ev.pca <- prcomp(PCAdata, center = TRUE, scale. = TRUE)

summary(ev.pca)

```


```{R}
plot(ev.pca, type = 'l')

```

```{R}
df.fft$type <- factor(df.fft$type, levels = c('bd','nn'))

p1<-ggbiplot::ggbiplot(ev.pca,alpha = 0, obs.scale = 1, var.scale = 1)+
  geom_point(aes(color = df.fft$type),size = 1, alpha = .5)+
  scale_color_viridis_d(direction = -1)+
  plotTheme



```

```{R}
p2<-ggbiplot::ggbiplot(ev.pca,alpha = 0, obs.scale = 1, var.scale = 1)+
  geom_point(aes(color = subdf1$type),size = 0, alpha = 0.4)+
  scale_color_viridis_d(direction = -1)+
  plotTheme



```

```{R}
p3<-ggbiplot::ggbiplot(ev.pca,alpha = 0, obs.scale = 1, var.scale = 1)+
  geom_point(aes(color = df.fft$needle),size = 0, alpha = 0.4)+
  scale_color_viridis_c(direction = -1)+
  plotTheme



```

```{R}
library(ggpubr)

ggarrange(p1, p2, p3,
          ncol=1,
          nrow = 3)


```


```{R}
df.fft$type <- factor(df.fft$type, levels = c('be','bd','n'))
library(ggfortify)
autoplot(ev.pca,data = df.fft, colour = 'type', shape = 19, alpha = 0.5, label = FALSE,loadings = TRUE, loadings.label = TRUE, loadings.label.colour = 'white', loadings.colour = 'white', frame = TRUE,frame.color = 'type', frame.type = 'norm')+
  coord_cartesian(xlim = c(-0.06, 0.03))+
  scale_color_manual(values=c('#238443', '#F0F921', '#2166AC'))+
  scale_fill_manual(values=c('#238443', '#F0F921', '#2166AC'))+
  theme_minimal()+
  plotTheme


```




```{R}
library(dplyr)
library(tricolore)

tric_dat <- Tricolore(df.fft, 
                      p1 = 'broad_evergreen',
                      p2 = 'broad_deciduous',
                      p3 = 'needle',
                      center = NA,
                      crop = FALSE,
                      show_center = FALSE,
                      hue = 0,
                      contrast = 0.7,
                      spread = 1,
                      lightness = 0.7,
                      chroma = 1,
                      #values = c("#D53E4F", "#F46D43", "#FEE08B", "#FFFFBF",  "#ABDDA4",  "#3288BD"),
                      label_as = 'pct')


df.fft$functionrgb <- tric_dat$rgb

```



```{R}

library(ggbiplot)
library(ggtern)
ggbiplot::ggbiplot(ev.pca, alpha = 0, obs.scale = 1, var.scale = 1)+
  ggplot2::geom_point(aes(color = df.fft$functionrgb), size = 0, alpha = 0.4)+
  scale_color_identity()+
  #annotation_custom(
   # ggplotGrob(tric_dat$key+labs(L = 'broad_evergreen', T = 'broad_deciduous', R = 'needle')), xmin = 5, xmax = 10, ymin = 0, ymax = 6)+
  plotTheme



```
```{R}
ggbiplot(ev.pca, group = df.fft$functionrgb, alpha = 0, obs.scale = 1, var.scale = 1)+
  geom_point(aes(color = df.fft$functionrgb), size = 0, alpha = 0.4)+
  scale_color_identity()+
  plotTheme


```



```{R}
tric_dat <- TricoloreSextant(df.fft, 
                      p1 = 'broad_evergreen',
                      p2 = 'broad_deciduous',
                      p3 = 'needle',
                      center = NA,
                      crop = FALSE,
                      show_center = FALSE,
                      #hue = 0,
                      #contrast = 0.7,
                      #spread = 1,
                      #lightness = 0.7,
                      #chroma = 1,
                      values = c('#006FFF', "#006FFF", "#FFFFFF", "#FFFFFF",  "#FFFFFF",  "#006FFF"),
                      label_as = 'pct')


df.fft$functionrgb <- tric_dat$rgb

```







```{R}

ggbiplot(ev.pca, group = df.fft$functionrgb, alpha = 0, obs.scale = 1, var.scale = 1)+
  geom_point(aes(color = df.fft$functionrgb), size = 0, alpha = 0.4, size = 2)+
  scale_color_identity()+
  annotation_custom(
    ggplotGrob(tric_dat$key+labs(L = 'broad_evergreen', T = 'deciduous', R = 'needle_evergreen')), xmin = 5, xmax = 10, ymin = 0, ymax = 6)+
  plotTheme



```

```{R}
tric_dat <- TricoloreSextant(df.fft, 
                      p1 = 'broad_evergreen',
                      p2 = 'deciduous',
                      p3 = 'needle_evergreen',
                      center = NA,
                      crop = FALSE,
                      show_center = FALSE,
                      #hue = 0,
                      #contrast = 0.7,
                      #spread = 1,
                      #lightness = 0.7,
                      #chroma = 1,
                      values = c('#FFFFFF', "#66CCFF", "#006FFF", "#66CCFF",  "#FFFFFF",  "#FFFFFF"),
                      label_as = 'pct')


df.fft$functionrgb <- tric_dat$rgb

```







```{R}

ggbiplot(ev.pca, group = df.fft$functionrgb, alpha = 0, obs.scale = 1, var.scale = 1)+
  geom_point(aes(color = df.fft$functionrgb), size = 0, alpha = 0.4, size = 2)+
  scale_color_identity()+
  annotation_custom(
    ggplotGrob(tric_dat$key+labs(L = 'broad_evergreen', T = 'deciduous', R = 'needle_evergreen')), xmin = 5, xmax = 10, ymin = 0, ymax = 6)+
  plotTheme



```





```{R}
tric_dat <- TricoloreSextant(df.fft, 
                      p1 = 'broad_evergreen',
                      p2 = 'deciduous',
                      p3 = 'needle_evergreen',
                      center = NA,
                      crop = FALSE,
                      show_center = FALSE,
                      #hue = 0,
                      #contrast = 0.7,
                      #spread = 1,
                      #lightness = 0.7,
                      #chroma = 1,
                      values = c('#FFFFFF', "#FFFFFF", "#FFFFFF", "#006FFF",  "#006FFF",  "#006FFF"),
                      label_as = 'pct')


df.fft$functionrgb <- tric_dat$rgb

```







```{R}

ggbiplot(ev.pca, group = df.fft$functionrgb, alpha = 0, obs.scale = 1, var.scale = 1)+
  geom_point(aes(color = df.fft$functionrgb), size = 0, alpha = 0.4, size = 2)+
  scale_color_identity()+
  annotation_custom(
    ggplotGrob(tric_dat$key+labs(L = 'broad_evergreen', T = 'deciduous', R = 'needle_evergreen')), xmin = 5, xmax = 10, ymin = 0, ymax = 6)+
  plotTheme



```


```{R}
tric_dat <- TricoloreSextant(df.fft, 
                      p1 = 'broad_evergreen',
                      p2 = 'broad_deciduous',
                      p3 = 'needle',
                      center = NA,
                      crop = FALSE,
                      show_center = FALSE,
                      #hue = 0,
                      #contrast = 0.7,
                      #spread = 1,
                      #lightness = 0.7,
                      #chroma = 1,
                      values = c('#D53E4F', "#D53E4F", "#FFFF00", "#3288BD",  "#3288BD",  "#3288BD"),
                      label_as = 'pct')


df.fft$functionrgb <- tric_dat$rgb

```







```{R}

ggbiplot(ev.pca, group = df.fft$functionrgb, alpha = 0, obs.scale = 1, var.scale = 1)+
  geom_point(aes(color = df.fft$functionrgb), size = 0, alpha = 0.4, size = 5)+
  scale_color_identity()+
  annotation_custom(
    ggplotGrob(tric_dat$key+labs(L = 'broad_evergreen', T = 'broad_deciduous', R = 'needle')), xmin = 5, xmax = 10, ymin = 0, ymax = 6)+
  plotTheme



```


```{R}
tric_dat <- Tricolore(df.fft, 
                      p1 = 'broad_evergreen',
                      p2 = 'deciduous',
                      p3 = 'needle_evergreen',
                      center = NA,
                      crop = FALSE,
                      show_center = FALSE,
                      breaks = 2,
                      hue = 5/12,
                      contrast = 0.6,
                      #spread = 1,
                      lightness = 1,
                      chroma = 0.8,
                      #values = c('#D53E4F', "#D53E4F", "#FFFF00", "#3288BD",  "#3288BD",  "#3288BD"),
                      label_as = 'pct')


df.fft$functionrgb <- tric_dat$rgb

```







```{R}

ggbiplot(ev.pca, group = df.fft$functionrgb, alpha = 0, obs.scale = 1, var.scale = 1)+
  geom_point(aes(color = df.fft$functionrgb), size = 0, alpha = 0.4, size = 5)+
  scale_color_identity()+
  annotation_custom(
    ggplotGrob(tric_dat$key+labs(L = 'broad_evergreen', T = 'deciduous', R = 'needle_evergreen')), xmin = 5, xmax = 10, ymin = 0, ymax = 6)+
  plotTheme



```



```{R}

for(i in 0:48){



tric_dat <- Tricolore(df.fft, 
                      p1 = 'broad_evergreen',
                      p2 = 'deciduous',
                      p3 = 'needle_evergreen',
                      center = NA,
                      crop = FALSE,
                      show_center = FALSE,
                      #breaks = 2,
                      hue = 34/48,
                      contrast = 1,
                      #spread = 1,
                      lightness = 30/48,
                      chroma = 48/48,
                      #values = c('#D53E4F', "#D53E4F", "#FFFF00", "#3288BD",  "#3288BD",  "#3288BD"),
                      label_as = 'pct')


df.fft$functionrgb <- tric_dat$rgb


print(ggbiplot(ev.pca, group = df.fft$functionrgb, alpha = 0, obs.scale = 1, var.scale = 1)+
  geom_point(aes(color = df.fft$functionrgb), size = 0, alpha = 0.4, size = 20)+
  scale_color_identity()+
    labs(title = i)+
  annotation_custom(
    ggplotGrob(tric_dat$key+labs(L = 'broad_evergreen', T = 'deciduous', R = 'needle_evergreen')), xmin = 5, xmax = 10, ymin = 0, ymax = 6))


}

```


```{R}
kmeans.clust <- df.fft %>%
  select(c(broad_evergreen, deciduous, needle_evergreen)) %>%
  kmeans(centers = 3)


tric_dat <- Tricolore(df.fft, 
                      p1 = 'broad_evergreen',
                      p2 = 'deciduous',
                      p3 = 'needle_evergreen',
                      center = NA,
                      crop = FALSE,
                      show_center = FALSE,
                      breaks = 2,
                      hue = 0,
                      contrast = 0.5,
                      #spread = 1,
                      lightness = 10/12,
                      chroma = 1,
                      #values = c('#D53E4F', "#D53E4F", "#FFFF00", "#3288BD",  "#3288BD",  "#3288BD"),
                      label_as = 'pct')


df.fft$functionrgb <- tric_dat$rgb


print(ggbiplot(ev.pca, groups = factor(kmeans.clust$cluster),ellipse = TRUE, alpha = 0, obs.scale = 1, var.scale = 1, ellipse.prob = 0.68)+
  #geom_point(aes(color = df.fft$functionrgb), size = 0, alpha = 0.4, size = 20)+
  scale_color_identity()+
  #annotation_custom(
  #  ggplotGrob(tric_dat$key+labs(L = 'broad_evergreen', T = 'deciduous', R = 'needle_evergreen')), xmin = 5, xmax = 10, ymin = 0, ymax = 6)+
  plotTheme)


```



```{R}
data("Feldspar")

#Base Plot
base = ggtern(data=Feldspar,aes(Ab,An,Or))

#Clipping Masks
A = base + 
  geom_point(shape = 21, color = 'black', fill = 'red', size = 10) + 
  labs(title="With Mask")
A

B = base + 
  theme_nomask() + 
  geom_point(shape = 21, color = 'black', fill = 'orange', size = 10) +
  labs(title='Without Mask')
B

C = base + 
  geom_mask() +
  geom_point(shape = 21, color = 'black', fill = 'blue', size = 10) +
  labs(title = "Manual Mask, Underneath Points")
C

D = base + 
  geom_mask() +
  geom_point(shape = 21, color = 'black', fill = 'green', size=10) +
  labs(title = "Manual Mask, Turned Off") +
  theme_nomask()
D

#Assemble in a grid
grid.arrange(A,B,C,D,ncol=2)


```


```{R}

ggtern(df.fft, aes(x = broad_evergreen, y = broad_deciduous, z = needle))+
  geom_point(size = 2)+
  theme_rgbw()




```


