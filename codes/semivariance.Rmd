---
title: "leaf_habit_semivariance"
author: "Haozhi Ma"
date: "5/12/2021"
output: html_document
---

Firstly load the data
```{R}
library(sp)

library(spatstat)

library(gstat)

library(geoR)

library(ncf)

library(spdep)

library(boot)

```

```{R}
alldev <- function(ds){
  return(sqrt((ds$be_pred - ds$be_obs)^2+(ds$bd_pred - ds$bd_obs)^2+(ds$n_pred - ds$ne_obs)^2)/2)
}

```


```{R}
dsr <- read.csv('C:\\Users\\haozh\\Desktop\\LL\\spatial_cv\\spatial_cv_fft_dbh_10m_20211208.csv')

dskfold <- read.csv('C:\\Users\\haozh\\Desktop\\LL\\functional_type_grid_search\\kfold_cv_fft_dbh_20211208.csv')
#names(dsr)
```






```{R}
#dfwithpred <- read.csv('C:\\Users\\haozh\\Desktop\\LL\\functional_type_grid_search\\df_with_pred_ntree10_var8_coefficient_trial.csv')


dfwithpred <- dsr

#names(dfwithpred)
```

```{R}
dfwithpred$be_obs <- dfwithpred$broad_evergreen/100.0
dfwithpred$bd_obs <- dfwithpred$broad_deciduous/100.0
dfwithpred$ne_obs <- dfwithpred$needle/100.0
#dfwithpred$nd_obs <- dfwithpred$needle_deciduous/100.0

dfwithpred$resi_be <- dfwithpred$be_pred - dfwithpred$be_obs
dfwithpred$resi_bd <- dfwithpred$bd_pred - dfwithpred$bd_obs
dfwithpred$resi_n <- dfwithpred$n_pred - dfwithpred$ne_obs

dfwithpred$alldev <- sqrt((dfwithpred$resi_be)^2+(dfwithpred$resi_bd)^2+(dfwithpred$resi_n)^2)/2


```




```{R}
dskfold$be_obs <- dskfold$broad_evergreen/100.0
dskfold$bd_obs <- dskfold$broad_deciduous/100.0
dskfold$ne_obs <- dskfold$needle/100.0
#dskfold$nd_obs <- dskfold$needle_deciduous/100.0

dskfold$resi_be <- dskfold$be_pred - dskfold$be_obs
dskfold$resi_bd <- dskfold$bd_pred - dskfold$bd_obs
dskfold$resi_n <- dskfold$n_pred - dskfold$ne_obs

dskfold$alldev <- sqrt((dskfold$resi_be)^2+(dskfold$resi_bd)^2+(dskfold$resi_n)^2)/2


```


File conversion

```{R}
coordinates(dfwithpred) <- ~Lon + Lat
proj4string(dfwithpred) <- CRS("+init=epsg:4326")
coordinates(dskfold) <- ~Lon + Lat
proj4string(dskfold) <- CRS("+init=epsg:4326")

```


```{R}
vcloud.raw<-variogram(be_obs~1, data = dfwithpred, cloud = F, cutoff = 1000, width = 10)
vcloud.raw$class <- 'raw_data'
```

```{R}
plot(vcloud.raw)

```

```{R}
vcloud.10mresi<-variogram(resi_bd~1, data = dfwithpred, cloud = F, cutoff = 1000, width = 10)
vcloud.10mresi$class <- 'loo10m'
```

```{R}
plot(vcloud.10mresi)

```



```{R}
vcloud.10mdev<-variogram(alldev~1, data = dfwithpred, cloud = F, cutoff = 1000, width = 10)
vcloud.10mdev$class <- 'loo10m'
```

```{R}
plot(vcloud.10mresi)

```





```{R}
vcloud.cvresi<-variogram(resi_bd~1, data = dskfold, cloud = F, cutoff = 1000, width = 10)
vcloud.cvresi$class <- 'cv_resi'
```

```{R}
plot(vcloud.cvresi)

```


```{R}
vcloud.cvdev<-variogram(alldev~1, data = dskfold, cloud = F, cutoff = 1000, width = 10)
vcloud.cvdev$class <- 'cv_dev'
```

```{R}
plot(vcloud.cvdev)

```





```{R}
loo100km = read.csv('C:\\Users\\haozh\\Desktop\\LL\\spatial_cv\\spatial_cv_fft_dbh_100000m_20211208.csv')
#head(loo200km, 20)

loo100km$be_obs <- loo100km$broad_evergreen/100.0
loo100km$bd_obs <- loo100km$broad_deciduous/100.0
loo100km$ne_obs <- loo100km$needle/100.0
#loo200km$nd_obs <- loo200km$needle_deciduous/100.0

loo100km$resi_be <- loo100km$be_pred - loo100km$be_obs
loo100km$resi_bd <- loo100km$bd_pred - loo100km$bd_obs
loo100km$resi_n <- loo100km$n_pred - loo100km$ne_obs


loo100km$alldev <- sqrt((loo100km$resi_be)^2+(loo100km$resi_bd)^2+(loo100km$resi_n)^2)/2

```
```{R}
coef_det <- function(xtrue, xpred){
    return(1-sum((xtrue-xpred)^2)/sum((xtrue-mean(xtrue))^2))
}
 
```

```{R}
#coef_det(cvprediction$`regressionmatrix$leaf_habit`,cvprediction$predictmean)

```


```{R}
coordinates(loo100km) <- ~Lon + Lat
proj4string(loo100km) <- CRS("+init=epsg:4326")


```


```{R}
vcloud.100km<-variogram(resi_bd~1, data = loo100km, cloud = F, cutoff = 1000, width = 10)
vcloud.100km$class <- 'loo100km'
```

```{R}
plot(vcloud.100km)

```


```{R}
vcloud.100kmdev<-variogram(alldev~1, data = loo100km, cloud = F, cutoff = 1000, width = 10)
vcloud.100kmdev$class <- 'loo100km'
```

```{R}
plot(vcloud.100kmdev)

```



200km loo spatial cv

```{R}
loo200km = read.csv('C:\\Users\\haozh\\Desktop\\LL\\spatial_cv\\spatial_cv_fft_dbh_200000m_20211208.csv')
#head(loo200km, 20)

loo200km$be_obs <- loo200km$broad_evergreen/100.0
loo200km$bd_obs <- loo200km$broad_deciduous/100.0
loo200km$ne_obs <- loo200km$needle/100.0
#loo200km$nd_obs <- loo200km$needle_deciduous/100.0

loo200km$resi_be <- loo200km$be_pred - loo200km$be_obs
loo200km$resi_bd <- loo200km$bd_pred - loo200km$bd_obs
loo200km$resi_n <- loo200km$n_pred - loo200km$ne_obs


loo200km$alldev <- sqrt((loo200km$resi_be)^2+(loo200km$resi_bd)^2+(loo200km$resi_n)^2)/2

```
```{R}
coef_det <- function(xtrue, xpred){
    return(1-sum((xtrue-xpred)^2)/sum((xtrue-mean(xtrue))^2))
}
 
```

```{R}
#coef_det(cvprediction$`regressionmatrix$leaf_habit`,cvprediction$predictmean)

```


```{R}
coordinates(loo200km) <- ~Lon + Lat
proj4string(loo200km) <- CRS("+init=epsg:4326")


```


```{R}
vcloud.200km<-variogram(resi_bd~1, data = loo200km, cloud = F, cutoff = 1000, width = 10)
vcloud.200km$class <- 'loo200km'
```

```{R}
plot(vcloud.200km)

```


```{R}
vcloud.200kmdev<-variogram(alldev~1, data = loo200km, cloud = F, cutoff = 1000, width = 10)
vcloud.200kmdev$class <- 'loo200km'
```

```{R}
plot(vcloud.200kmdev)

```


```{R}
loo250km = read.csv('C:\\Users\\haozh\\Desktop\\LL\\spatial_cv\\spatial_cv_fft_dbh_250000m_20211208.csv')
#head(loo200km, 20)

loo250km$be_obs <- loo250km$broad_evergreen/100.0
loo250km$bd_obs <- loo250km$broad_deciduous/100.0
loo250km$ne_obs <- loo250km$needle/100.0
#loo200km$nd_obs <- loo200km$needle_deciduous/100.0

loo250km$resi_be <- loo250km$be_pred - loo250km$be_obs
loo250km$resi_bd <- loo250km$bd_pred - loo250km$bd_obs
loo250km$resi_n <- loo250km$n_pred - loo250km$ne_obs


loo250km$alldev <- sqrt((loo250km$resi_be)^2+(loo250km$resi_bd)^2+(loo250km$resi_n)^2)/2

```
```{R}
coef_det <- function(xtrue, xpred){
    return(1-sum((xtrue-xpred)^2)/sum((xtrue-mean(xtrue))^2))
}
 
```

```{R}
#coef_det(cvprediction$`regressionmatrix$leaf_habit`,cvprediction$predictmean)

```


```{R}
coordinates(loo250km) <- ~Lon + Lat
proj4string(loo250km) <- CRS("+init=epsg:4326")


```


```{R}
vcloud.250km<-variogram(resi_bd~1, data = loo250km, cloud = F, cutoff = 1000, width = 10)
vcloud.250km$class <- 'loo250km'
```

```{R}
plot(vcloud.250km)

```


```{R}
vcloud.250kmdev<-variogram(alldev~1, data = loo250km, cloud = F, cutoff = 1000, width = 10)
vcloud.250kmdev$class <- 'loo250km'
```

```{R}
plot(vcloud.250kmdev)

```


```{R}
loo500km = read.csv('C:\\Users\\haozh\\Desktop\\LL\\spatial_cv\\spatial_cv_fft_dbh_500000m_20211208.csv')
#head(loo500km, 20)

loo500km$be_obs <- loo500km$broad_evergreen/100.0
loo500km$bd_obs <- loo500km$broad_deciduous/100.0
loo500km$ne_obs <- loo500km$needle/100.0
#loo500km$nd_obs <- loo500km$needle_deciduous/100.0

loo500km$resi_be <- loo500km$be_pred - loo500km$be_obs
loo500km$resi_bd <- loo500km$bd_pred - loo500km$bd_obs
loo500km$resi_n <- loo500km$n_pred - loo500km$ne_obs


loo500km$alldev <- sqrt((loo500km$resi_be)^2+(loo500km$resi_bd)^2+(loo500km$resi_n)^2)/2

```
```{R}
coef_det <- function(xtrue, xpred){
    return(1-sum((xtrue-xpred)^2)/sum((xtrue-mean(xtrue))^2))
}
 
```

```{R}
#coef_det(cvprediction$`regressionmatrix$leaf_habit`,cvprediction$predictmean)

```


```{R}
coordinates(loo500km) <- ~Lon + Lat
proj4string(loo500km) <- CRS("+init=epsg:4326")


```


```{R}
vcloud.500km<-variogram(resi_bd~1, data = loo500km, cloud = F, cutoff = 1000, width = 10)
vcloud.500km$class <- 'loo500km'
```

```{R}
plot(vcloud.500km)

```


```{R}
vcloud.500kmdev<-variogram(alldev~1, data = loo500km, cloud = F, cutoff = 1000, width = 10)
vcloud.500kmdev$class <- 'loo500km'
```

```{R}
plot(vcloud.500kmdev)

```


```{R}
loo1000km = read.csv('C:\\Users\\haozh\\Desktop\\LL\\spatial_cv\\spatial_cv_fft_dbh_1000000m_20211208.csv')
#head(loo1000km, 20)

loo1000km$be_obs <- loo1000km$broad_evergreen/100.0
loo1000km$bd_obs <- loo1000km$broad_deciduous/100.0
loo1000km$ne_obs <- loo1000km$needle/100.0
#loo1000km$nd_obs <- loo1000km$needle_deciduous/100.0

loo1000km$resi_be <- loo1000km$be_pred - loo1000km$be_obs
loo1000km$resi_bd <- loo1000km$bd_pred - loo1000km$bd_obs
loo1000km$resi_n <- loo1000km$n_pred - loo1000km$ne_obs


loo1000km$alldev <- sqrt((loo1000km$resi_be)^2+(loo1000km$resi_bd)^2+(loo1000km$resi_n)^2)/2

```
```{R}
coef_det <- function(xtrue, xpred){
    return(1-sum((xtrue-xpred)^2)/sum((xtrue-mean(xtrue))^2))
}
 
```

```{R}
#coef_det(cvprediction$`regressionmatrix$leaf_habit`,cvprediction$predictmean)

```


```{R}
coordinates(loo1000km) <- ~Lon + Lat
proj4string(loo1000km) <- CRS("+init=epsg:4326")


```


```{R}
vcloud.1000km<-variogram(resi_bd~1, data = loo1000km, cloud = F, cutoff = 1000, width = 10)
vcloud.1000km$class <- 'loo1000km'
```

```{R}
plot(vcloud.1000km)

```


```{R}
vcloud.1000kmdev<-variogram(alldev~1, data = loo1000km, cloud = F, cutoff = 1000, width = 10)
vcloud.1000kmdev$class <- 'loo1000km'
```

```{R}
plot(vcloud.1000kmdev)

```


```{R}

semiall<-rbind(vcloud.cvresi,rbind(vcloud.10mresi,rbind(vcloud.100km,rbind(vcloud.200km,rbind(vcloud.250km,rbind(vcloud.500km,vcloud.1000km))))))

head(semiall)

semiall$class <- factor(semiall$class, levels = c('cv_resi', 'loo10m', 'loo100km', 'loo200km','loo250km','loo500km','loo1000km'))
```

```{R}
library(ggplot2)
ggplot(data = semiall, aes(x = dist, y = gamma, color = class))+
  geom_smooth(method = 'loess', se = FALSE, size = 2, span = 0.4)+
  theme_classic()+
  #scale_y_continuous(limits = c(0,400))+
  labs(x = 'Distance (km)', y = 'Semivariance')+
  scale_color_viridis_d()+
  theme(axis.title = element_text(size = 20), axis.text.x = element_text(size = 20,color = 'black'), axis.text.y = element_text(size = 20, colour = 'black'),
        legend.title = element_blank(), legend.text = element_text(size = 20))

```



